<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HavaDurumuX - Çevrimdışı</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f8ff; /* Light AliceBlue */
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }
        .header {
            background-color: #87CEEB; /* Sky Blue */
            color: white;
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
        }
        .header-title {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .header-controls button, .header-controls select {
            margin-left: 0.5rem;
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        .header-controls #dataProgressIndicator {
            background-color: rgba(255,255,255,0.2);
            padding: 0.3rem 0.7rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            margin-left: 0.5rem;
            color: white;
            font-weight: 500;
        }

        .main-container {
            flex-grow: 1;
            padding: 1rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }
        .weather-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .weather-card-header {
            background-color: #E6E6FA; /* Soft Lavender */
            color: #555;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #ddd;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .weather-card-body {
            padding: 1rem;
        }
        .current-weather-display {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-bottom: 1rem;
        }
        .current-weather-display .temp {
            font-size: 3rem;
            font-weight: bold;
            color: #87CEEB;
        }
        .current-weather-display .condition-icon {
            font-size: 3.5rem;
            color: #87CEEB;
        }
        .current-weather-display .condition-text {
            font-size: 1rem;
            color: #555;
            text-align: center;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        .detail-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 0.7rem;
            font-size: 0.85rem;
        }
        .detail-item .label {
            color: #555;
            display: block;
            margin-bottom: 0.2rem;
        }
        .detail-item .value {
            font-weight: bold;
            font-size: 1rem;
            color: #87CEEB;
        }
        .forecast-tabs .nav-link {
            color: #87CEEB;
            font-weight: 500;
        }
        .forecast-tabs .nav-link.active {
            color: #555;
            background-color: #E6E6FA !important;
            border-color: #ddd #ddd #E6E6FA !important;
        }
        .daily-forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.3rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .daily-forecast-item:last-child {
            border-bottom: none;
        }
        .daily-forecast-item .day {
            font-weight: 600;
        }
        .daily-forecast-item .icon {
            font-size: 1.5rem;
            color: #87CEEB;
        }
        .hourly-forecast-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 1rem;
        }
        .hourly-forecast-item {
            display: inline-block;
            width: 80px;
            text-align: center;
            padding: 0.5rem;
            margin-right: 0.5rem;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
            font-size: 0.8rem;
        }
        .hourly-forecast-item .icon {
            font-size: 1.8rem;
            color: #87CEEB;
            margin-bottom: 0.2rem;
        }
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1060; /* Higher than Bootstrap modals (usually 1050, 1055 for backdrop) */
            font-size: 1.2rem;
        }
        .loading-container .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }
        .quick-actions button {
            margin: 0.2rem;
            font-size: 0.8rem;
        }
        #mapContainer iframe {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .footer {
            text-align: center;
            padding: 1rem;
            background-color: #e0f0f8;
            color: #555;
            font-size: 0.85rem;
            margin-top: auto;
        }
        @media (max-width: 767px) {
            .header-content {
                flex-direction: column;
            }
            .header-title {
                margin-bottom: 0.5rem;
            }
            .header-controls {
                width: 100%;
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
            }
            .header-controls > * { margin: 0.2rem; }
            .current-weather-display { flex-direction: column; }
            .current-weather-display .temp { margin-bottom: 0.5rem; font-size: 2.5rem; }
            .current-weather-display .condition-icon { font-size: 3rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <div class="header-title">HavaDurumuX Çevrimdışı</div>
            <div class="header-controls">
                <select id="provinceSelect" class="form-select form-select-sm d-inline-block" style="width: auto;"></select>
                <button id="forceRefreshButton" class="btn btn-light btn-sm" title="Mevcut konum verilerini anında yenile (API'den)">
                    <i class="fas fa-sync-alt"></i> Yenile
                </button>
                 <button id="forceBulkUpdateButton" class="btn btn-warning btn-sm" title="Tüm kayıtlı il verilerini API'den çekerek güncelle (6 saat bekleme süresini atlar)">
                    <i class="fas fa-database"></i> Tümünü API'den Yenile
                </button>
                <div id="dataProgressIndicator" title="Yerelde saklanan konum verisi sayısı / Toplam hedef konum sayısı">-- / --</div>
            </div>
        </div>
    </header>

    <div class="main-container container mt-3">
        <div id="loadingContainer" class="loading-container" style="display: none;">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p id="loadingMessage">Yükleniyor...</p>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="weather-card">
                    <div class="weather-card-header" id="currentCity">Konum Seçin</div>
                    <div class="weather-card-body">
                        <div class="current-weather-display">
                            <div>
                                <div class="condition-icon"><i class="fas fa-question-circle"></i></div>
                                <div class="condition-text" id="currentCondition">--</div>
                            </div>
                            <div class="temp" id="currentTemp">--°C</div>
                        </div>
                        <div id="currentTimestamp" class="text-muted text-center small mb-3">Güncelleme: --</div>
                    </div>
                </div>

                <ul class="nav nav-tabs forecast-tabs" id="weatherTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Ayrıntılar</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="hourly-tab" data-bs-toggle="tab" data-bs-target="#hourly" type="button" role="tab" aria-controls="hourly" aria-selected="false">Saatlik</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab" aria-controls="daily" aria-selected="false">Günlük Tahmin (7 Gün)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab" aria-controls="alerts" aria-selected="false">Uyarılar</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map" type="button" role="tab" aria-controls="map" aria-selected="false">Harita</button>
                    </li>
                </ul>
                <div class="tab-content weather-card" id="weatherTabContent" style="border-top-left-radius: 0; border-top-right-radius: 0;">
                    <div class="tab-pane fade show active p-3" id="details" role="tabpanel" aria-labelledby="details-tab">
                        <h5>Ayrıntılı Bilgiler</h5>
                        <div id="detailsContainer" class="detail-grid">
                            {/* Details will be populated by JavaScript */}
                        </div>
                    </div>
                    <div class="tab-pane fade p-3" id="hourly" role="tabpanel" aria-labelledby="hourly-tab">
                        <h5>Saatlik Tahmin (İlk 24 Saat)</h5>
                        <div id="hourlyForecastContainer" class="hourly-forecast-container">
                            <p class="text-muted">Saatlik tahmin verisi bulunamadı.</p>
                        </div>
                    </div>
                    <div class="tab-pane fade p-3" id="daily" role="tabpanel" aria-labelledby="daily-tab">
                        <h5>7 Günlük Tahmin</h5>
                        <div id="dailyForecastContainer">
                            <p class="text-muted">Günlük tahmin verisi bulunamadı.</p>
                        </div>
                    </div>
                    <div class="tab-pane fade p-3" id="alerts" role="tabpanel" aria-labelledby="alerts-tab">
                        <h5>Uyarılar (<span id="alertLocationName"></span>)</h5>
                        <div id="alertsContainer">
                            <p class="text-muted">Aktif uyarı bulunmuyor.</p>
                        </div>
                    </div>
                    <div class="tab-pane fade p-3" id="map" role="tabpanel" aria-labelledby="map-tab">
                        <h5>Konum Haritası: <span id="mapLocation"></span></h5>
                        <div id="mapContainer" style="width: 100%; height: 400px;">
                            <p class="text-muted">Harita yüklenemedi. Lütfen bir konum seçin.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="weather-card">
                    <div class="weather-card-header">Hızlı Eylemler</div>
                    <div class="weather-card-body quick-actions text-center">
                        <button id="getCurrentLocationBtn" class="btn btn-primary btn-sm mb-2 w-100"><i class="fas fa-map-marker-alt"></i> Kayıtlı Konumumu Göster/Seç</button>
                        <button id="changePinnedLocationBtn" class="btn btn-info btn-sm mb-2 w-100" style="display: none;"><i class="fas fa-edit"></i> Kayıtlı Konumumu Değiştir</button>
                        <p class="text-muted small mt-2">Popüler İller:</p>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="Ankara">Ankara</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="İstanbul">İstanbul</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="İzmir">İzmir</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="Antalya">Antalya</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="Bursa Merkez">Bursa Merkez</button>
                        <button class="btn btn-outline-info btn-sm quick-city-special" data-city="Bursa" data-district="İnegöl">Bursa İnegöl</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="Kütahya">Kütahya Merkez</button>
                        <button class="btn btn-outline-info btn-sm quick-city-special" data-city="Kütahya" data-district="Domaniç">Kütahya Domaniç</button>
                    </div>
                </div>
                 <div class="weather-card mt-3">
                    <div class="weather-card-header">Veri Kaynağı & Güncelleme</div>
                    <div class="weather-card-body small">
                        <p>Bu sayfadaki veriler <a href="https://www.met.no/" target="_blank" rel="noopener noreferrer">MET Norway</a> ve <a href="https://open-meteo.com/" target="_blank" rel="noopener noreferrer">Open-Meteo</a> API'lerinden alınmaktadır.</p>
                        <p>Veriler yaklaşık 6 saatte bir otomatik olarak güncellenmeye çalışılır. Manuel olarak "Tümünü API'den Yenile" butonu ile hemen güncelleme başlatabilirsiniz.</p>
                        <p>Son toplu güncelleme: <span id="lastBulkUpdateTimeDisplay" class="fw-bold">Hiçbir zaman</span></p>
                        <p>Bir sonraki otomatik güncelleme yaklaşık: <span id="nextBulkUpdateTimeDisplay" class="fw-bold">--</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pinned Location Selection Modal -->
    <div class="modal fade" id="pinnedLocationModal" tabindex="-1" aria-labelledby="pinnedLocationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pinnedLocationModalLabel">"Mevcut Konumum" Olarak Kaydet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Lütfen "Mevcut Konumum" olarak hızlıca erişmek istediğiniz bir yer seçin:</p>
                    <select id="pinnedLocationSelectModal" class="form-select">
                        {/* Options will be populated by JavaScript */}
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="savePinnedLocationBtn">Kaydet ve Göster</button>
                </div>
            </div>
        </div>
    </div>


    <footer class="footer">
        HavaDurumuX Çevrimdışı Sürümü &copy; <span id="currentYear"></span>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Constants
        const DB_NAME = 'HavaDurumuXOfflineDB_v3';
        const DB_VERSION = 2;
        const STORE_NAME = 'weatherData_v3';
        const OPEN_METEO_API_BASE_URL = 'https://api.open-meteo.com/v1/forecast';
        const BULK_REQUEST_DELAY = 1500; // 1.5 seconds
        const SIX_HOURS_MS = 6 * 60 * 60 * 1000;
        const CACHE_DURATION_MS = SIX_HOURS_MS; 
        const USER_PINNED_LOCATION_KEY_V3 = 'userPinnedGeolocation_v3';


        let db;
        let currentSelectedLocation = null; 
        let isBulkUpdating = false;
        let tempInterpolationInterval = null;
        let pinnedLocationModalInstance = null;
        let pinnedLocationFromStorage = null;


        const provincesToFetchForBulkUpdate = [
            { displayName: "Adana Merkez", dbKey: "Adana_Merkez", lat: 37.00, lon: 35.32 }, { displayName: "Adıyaman Merkez", dbKey: "Adıyaman_Merkez", lat: 37.76, lon: 38.27 }, { displayName: "Afyonkarahisar Merkez", dbKey: "Afyonkarahisar_Merkez", lat: 38.75, lon: 30.53 }, { displayName: "Ağrı Merkez", dbKey: "Ağrı_Merkez", lat: 39.72, lon: 43.05 }, { displayName: "Amasya Merkez", dbKey: "Amasya_Merkez", lat: 40.65, lon: 35.83 }, { displayName: "Ankara Merkez", dbKey: "Ankara_Merkez", lat: 39.93, lon: 32.85 }, { displayName: "Antalya Merkez", dbKey: "Antalya_Merkez", lat: 36.89, lon: 30.70 }, { displayName: "Artvin Merkez", dbKey: "Artvin_Merkez", lat: 41.18, lon: 41.82 }, { displayName: "Aydın Merkez", dbKey: "Aydın_Merkez", lat: 37.84, lon: 27.83 }, { displayName: "Balıkesir Merkez", dbKey: "Balıkesir_Merkez", lat: 39.65, lon: 27.88 }, { displayName: "Bilecik Merkez", dbKey: "Bilecik_Merkez", lat: 40.14, lon: 29.98 }, { displayName: "Bingöl Merkez", dbKey: "Bingöl_Merkez", lat: 38.88, lon: 40.49 }, { displayName: "Bitlis Merkez", dbKey: "Bitlis_Merkez", lat: 38.40, lon: 42.11 }, { displayName: "Bolu Merkez", dbKey: "Bolu_Merkez", lat: 40.73, lon: 31.61 }, { displayName: "Burdur Merkez", dbKey: "Burdur_Merkez", lat: 37.72, lon: 30.28 }, { displayName: "Bursa Merkez", dbKey: "Bursa_Merkez", lat: 40.18, lon: 29.06 }, { displayName: "Bursa İnegöl", dbKey: "Bursa_İnegöl", lat: 40.0833, lon: 29.5167 }, { displayName: "Çanakkale Merkez", dbKey: "Çanakkale_Merkez", lat: 40.15, lon: 26.41 }, { displayName: "Çankırı Merkez", dbKey: "Çankırı_Merkez", lat: 40.60, lon: 33.61 }, { displayName: "Çorum Merkez", dbKey: "Çorum_Merkez", lat: 40.55, lon: 34.95 }, { displayName: "Denizli Merkez", dbKey: "Denizli_Merkez", lat: 37.77, lon: 29.09 }, { displayName: "Diyarbakır Merkez", dbKey: "Diyarbakır_Merkez", lat: 37.91, lon: 40.23 }, { displayName: "Edirne Merkez", dbKey: "Edirne_Merkez", lat: 41.67, lon: 26.57 }, { displayName: "Elazığ Merkez", dbKey: "Elazığ_Merkez", lat: 38.67, lon: 39.22 }, { displayName: "Erzincan Merkez", dbKey: "Erzincan_Merkez", lat: 39.74, lon: 39.49 }, { displayName: "Erzurum Merkez", dbKey: "Erzurum_Merkez", lat: 39.90, lon: 41.27 }, { displayName: "Eskişehir Merkez", dbKey: "Eskişehir_Merkez", lat: 39.77, lon: 30.52 }, { displayName: "Gaziantep Merkez", dbKey: "Gaziantep_Merkez", lat: 37.06, lon: 37.38 }, { displayName: "Giresun Merkez", dbKey: "Giresun_Merkez", lat: 40.91, lon: 38.39 }, { displayName: "Gümüşhane Merkez", dbKey: "Gümüşhane_Merkez", lat: 40.46, lon: 39.47 }, { displayName: "Hakkari Merkez", dbKey: "Hakkari_Merkez", lat: 37.57, lon: 43.74 }, { displayName: "Hatay Merkez", dbKey: "Hatay_Merkez", lat: 36.20, lon: 36.16 }, { displayName: "Isparta Merkez", dbKey: "Isparta_Merkez", lat: 37.76, lon: 30.55 }, { displayName: "Mersin Merkez", dbKey: "Mersin_Merkez", lat: 36.80, lon: 34.62 }, { displayName: "İstanbul Merkez", dbKey: "İstanbul_Merkez", lat: 41.01, lon: 28.97 }, { displayName: "İzmir Merkez", dbKey: "İzmir_Merkez", lat: 38.42, lon: 27.14 }, { displayName: "Kars Merkez", dbKey: "Kars_Merkez", lat: 40.60, lon: 43.09 }, { displayName: "Kastamonu Merkez", dbKey: "Kastamonu_Merkez", lat: 41.37, lon: 33.77 }, { displayName: "Kayseri Merkez", dbKey: "Kayseri_Merkez", lat: 38.72, lon: 35.48 }, { displayName: "Kırklareli Merkez", dbKey: "Kırklareli_Merkez", lat: 41.73, lon: 27.22 }, { displayName: "Kırşehir Merkez", dbKey: "Kırşehir_Merkez", lat: 39.14, lon: 34.16 }, { displayName: "Kocaeli Merkez", dbKey: "Kocaeli_Merkez", lat: 40.76, lon: 29.91 }, { displayName: "Konya Merkez", dbKey: "Konya_Merkez", lat: 37.87, lon: 32.48 }, { displayName: "Kütahya Merkez", dbKey: "Kütahya_Merkez", lat: 39.42, lon: 29.98 }, { displayName: "Kütahya Domaniç", dbKey: "Kütahya_Domaniç", lat: 39.8119, lon: 29.6078 }, { displayName: "Malatya Merkez", dbKey: "Malatya_Merkez", lat: 38.35, lon: 38.30 }, { displayName: "Manisa Merkez", dbKey: "Manisa_Merkez", lat: 38.61, lon: 27.42 }, { displayName: "Kahramanmaraş Merkez", dbKey: "Kahramanmaraş_Merkez", lat: 37.58, lon: 36.93 }, { displayName: "Mardin Merkez", dbKey: "Mardin_Merkez", lat: 37.31, lon: 40.73 }, { displayName: "Muğla Merkez", dbKey: "Muğla_Merkez", lat: 37.21, lon: 28.36 }, { displayName: "Muş Merkez", dbKey: "Muş_Merkez", lat: 38.73, lon: 41.49 }, { displayName: "Nevşehir Merkez", dbKey: "Nevşehir_Merkez", lat: 38.62, lon: 34.71 }, { displayName: "Niğde Merkez", dbKey: "Niğde_Merkez", lat: 37.96, lon: 34.68 }, { displayName: "Ordu Merkez", dbKey: "Ordu_Merkez", lat: 40.98, lon: 37.88 }, { displayName: "Rize Merkez", dbKey: "Rize_Merkez", lat: 41.02, lon: 40.52 }, { displayName: "Sakarya Merkez", dbKey: "Sakarya_Merkez", lat: 40.77, lon: 30.40 }, { displayName: "Samsun Merkez", dbKey: "Samsun_Merkez", lat: 41.28, lon: 36.33 }, { displayName: "Siirt Merkez", dbKey: "Siirt_Merkez", lat: 37.93, lon: 41.94 }, { displayName: "Sinop Merkez", dbKey: "Sinop_Merkez", lat: 42.02, lon: 35.15 }, { displayName: "Sivas Merkez", dbKey: "Sivas_Merkez", lat: 39.75, lon: 37.01 }, { displayName: "Tekirdağ Merkez", dbKey: "Tekirdağ_Merkez", lat: 40.98, lon: 27.51 }, { displayName: "Tokat Merkez", dbKey: "Tokat_Merkez", lat: 40.32, lon: 36.55 }, { displayName: "Trabzon Merkez", dbKey: "Trabzon_Merkez", lat: 41.00, lon: 39.72 }, { displayName: "Tunceli Merkez", dbKey: "Tunceli_Merkez", lat: 39.10, lon: 39.54 }, { displayName: "Şanlıurfa Merkez", dbKey: "Şanlıurfa_Merkez", lat: 37.16, lon: 38.79 }, { displayName: "Uşak Merkez", dbKey: "Uşak_Merkez", lat: 38.67, lon: 29.40 }, { displayName: "Van Merkez", dbKey: "Van_Merkez", lat: 38.50, lon: 43.37 }, { displayName: "Yozgat Merkez", dbKey: "Yozgat_Merkez", lat: 39.82, lon: 34.80 }, { displayName: "Zonguldak Merkez", dbKey: "Zonguldak_Merkez", lat: 41.45, lon: 31.79 }, { displayName: "Aksaray Merkez", dbKey: "Aksaray_Merkez", lat: 38.36, lon: 34.03 }, { displayName: "Bayburt Merkez", dbKey: "Bayburt_Merkez", lat: 40.25, lon: 40.22 }, { displayName: "Karaman Merkez", dbKey: "Karaman_Merkez", lat: 37.18, lon: 33.21 }, { displayName: "Kırıkkale Merkez", dbKey: "Kırıkkale_Merkez", lat: 39.84, lon: 33.51 }, { displayName: "Batman Merkez", dbKey: "Batman_Merkez", lat: 37.88, lon: 41.13 }, { displayName: "Şırnak Merkez", dbKey: "Şırnak_Merkez", lat: 37.51, lon: 42.46 }, { displayName: "Bartın Merkez", dbKey: "Bartın_Merkez", lat: 41.63, lon: 32.33 }, { displayName: "Ardahan Merkez", dbKey: "Ardahan_Merkez", lat: 41.11, lon: 42.70 }, { displayName: "Iğdır Merkez", dbKey: "Iğdır_Merkez", lat: 39.92, lon: 44.04 }, { displayName: "Yalova Merkez", dbKey: "Yalova_Merkez", lat: 40.65, lon: 29.27 }, { displayName: "Karabük Merkez", dbKey: "Karabük_Merkez", lat: 41.20, lon: 32.62 }, { displayName: "Kilis Merkez", dbKey: "Kilis_Merkez", lat: 36.71, lon: 37.11 }, { displayName: "Osmaniye Merkez", dbKey: "Osmaniye_Merkez", lat: 37.07, lon: 36.24 }, { displayName: "Düzce Merkez", dbKey: "Düzce_Merkez", lat: 40.84, lon: 31.15 }
        ];
        const TOTAL_TARGET_LOCATIONS = provincesToFetchForBulkUpdate.length;

        const provinceSelect = document.getElementById('provinceSelect');
        const currentCityEl = document.getElementById('currentCity');
        const currentTempEl = document.getElementById('currentTemp');
        const currentConditionEl = document.getElementById('currentCondition');
        const currentConditionIconEl = document.querySelector('.current-weather-display .condition-icon i');
        const currentTimestampEl = document.getElementById('currentTimestamp');
        const detailsContainer = document.getElementById('detailsContainer');
        const hourlyForecastContainer = document.getElementById('hourlyForecastContainer');
        const dailyForecastContainer = document.getElementById('dailyForecastContainer');
        const alertsContainer = document.getElementById('alertsContainer');
        const alertLocationNameEl = document.getElementById('alertLocationName');
        const mapContainer = document.getElementById('mapContainer');
        const mapLocationEl = document.getElementById('mapLocation');
        const loadingContainer = document.getElementById('loadingContainer');
        const loadingMessageEl = document.getElementById('loadingMessage');
        const forceRefreshButton = document.getElementById('forceRefreshButton');
        const forceBulkUpdateButton = document.getElementById('forceBulkUpdateButton');
        const getCurrentLocationBtn = document.getElementById('getCurrentLocationBtn');
        const changePinnedLocationBtn = document.getElementById('changePinnedLocationBtn');
        const dataProgressIndicator = document.getElementById('dataProgressIndicator');
        const lastBulkUpdateTimeDisplay = document.getElementById('lastBulkUpdateTimeDisplay');
        const nextBulkUpdateTimeDisplay = document.getElementById('nextBulkUpdateTimeDisplay');
        const pinnedLocationSelectModalEl = document.getElementById('pinnedLocationSelectModal');
        const savePinnedLocationBtn = document.getElementById('savePinnedLocationBtn');


        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            pinnedLocationModalInstance = new bootstrap.Modal(document.getElementById('pinnedLocationModal'));
            populateProvinceSelect(provinceSelect); // Main select
            populateProvinceSelect(pinnedLocationSelectModalEl); // Modal select
            initDb();

            provinceSelect.addEventListener('change', handleProvinceSelectChange);
            forceRefreshButton.addEventListener('click', handleForceRefresh);
            forceBulkUpdateButton.addEventListener('click', handleForceBulkUpdate);
            getCurrentLocationBtn.addEventListener('click', handleGetCurrentLocationClick);
            changePinnedLocationBtn.addEventListener('click', handleChangePinnedLocationClick);
            savePinnedLocationBtn.addEventListener('click', handleSavePinnedLocation);
            
            document.querySelectorAll('.quick-city').forEach(button => {
                button.addEventListener('click', handleQuickCitySelect);
            });
            document.querySelectorAll('.quick-city-special').forEach(button => {
                button.addEventListener('click', handleQuickCitySpecialSelect);
            });

            // Event listeners for Bootstrap tabs to ensure map resizes
            const tabButtons = document.querySelectorAll('#weatherTab button[data-bs-toggle="tab"]');
            tabButtons.forEach(button => {
                button.addEventListener('shown.bs.tab', function (event) {
                    if (event.target.id === 'map-tab') {
                        // Potentially re-initialize or resize map if needed,
                        // but Google Embed usually handles this well.
                        console.log("Map tab shown");
                    }
                    if (event.target.id === 'details-tab' && currentSelectedLocation && currentSelectedLocation.weatherData) {
                        updateDetailedInfo(currentSelectedLocation.weatherData);
                    }
                });
            });
        });

        function initDb() {
            showLoading('Veritabanı başlatılıyor...');
            const dbRequest = indexedDB.open(DB_NAME, DB_VERSION);

            dbRequest.onupgradeneeded = (event) => {
                console.log("Database upgrade needed.");
                db = (event.target).result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'dbKey' });
                    console.log("Object store created:", STORE_NAME);
                }
            };

            dbRequest.onsuccess = (event) => {
                db = (event.target).result;
                console.log("Database opened successfully_v3.");
                updateDataProgressIndicator();
                loadPinnedLocationAndInitialWeather(); // New function
                checkAndRunAutoBulkUpdate(); // New function
            };

            dbRequest.onerror = (event) => {
                console.error("Database error:", (event.target).error);
                showError("Veritabanı açılamadı. Çevrimdışı özellikler çalışmayabilir.");
                hideLoading();
            };
        }

        function loadPinnedLocationAndInitialWeather() {
            const storedPinnedKey = localStorage.getItem(USER_PINNED_LOCATION_KEY_V3);
            if (storedPinnedKey) {
                pinnedLocationFromStorage = provincesToFetchForBulkUpdate.find(p => p.dbKey === storedPinnedKey);
            }
            updatePinnedLocationButtonUI();

            if (pinnedLocationFromStorage) {
                currentSelectedLocation = pinnedLocationFromStorage;
                provinceSelect.value = pinnedLocationFromStorage.dbKey;
                loadWeatherDataForLocation(pinnedLocationFromStorage);
            } else {
                 const lastSelectedDbKey = localStorage.getItem('lastSelectedLocationDbKey_v3');
                 if (lastSelectedDbKey) {
                     const foundLocation = provincesToFetchForBulkUpdate.find(p => p.dbKey === lastSelectedDbKey);
                     if (foundLocation) currentSelectedLocation = foundLocation;
                 }
                 if (!currentSelectedLocation && provincesToFetchForBulkUpdate.length > 0) {
                      const kütahyaMerkez = provincesToFetchForBulkUpdate.find(p => p.dbKey === "Kütahya_Merkez");
                      currentSelectedLocation = kütahyaMerkez || provincesToFetchForBulkUpdate[0];
                 }
                 if (currentSelectedLocation) {
                    provinceSelect.value = currentSelectedLocation.dbKey;
                    loadWeatherDataForLocation(currentSelectedLocation);
                 } else {
                    updateWeatherDisplay(null, "Lütfen Bir Konum Seçin");
                    hideLoading();
                 }
            }
        }
        
        function checkAndRunAutoBulkUpdate() {
            const lastBulkUpdateTimeString = localStorage.getItem('lastBulkUpdateTime_v3');
            let lastBulkUpdateTimeMs = 0;
            let shouldConsiderAutoBulkUpdate = true;

            if (lastBulkUpdateTimeString) {
                lastBulkUpdateTimeMs = parseInt(lastBulkUpdateTimeString);
                if (!isNaN(lastBulkUpdateTimeMs)) {
                    const timeSinceLastUpdate = Date.now() - lastBulkUpdateTimeMs;
                    if (timeSinceLastUpdate < SIX_HOURS_MS) {
                        shouldConsiderAutoBulkUpdate = false;
                        console.log(`AUTO BULK UPDATE NOT NEEDED. Next auto update in approx: ${formatTimeDifference(SIX_HOURS_MS - timeSinceLastUpdate)}`);
                        updateNextBulkUpdateDisplay(lastBulkUpdateTimeMs);
                        if (!currentSelectedLocation) hideLoading(); // Hide only if no location is being loaded
                    } else {
                        console.log("AUTO BULK UPDATE NEEDED: 6 hours passed.");
                    }
                } else {
                    localStorage.removeItem('lastBulkUpdateTime_v3');
                }
            } else {
                console.log("AUTO BULK UPDATE NEEDED: No last update time.");
            }
            updateLastBulkUpdateTimeDisplay();

            if (shouldConsiderAutoBulkUpdate) {
                bulkUpdateAllProvincesData(false);
            }
        }


        function populateProvinceSelect(selectElement) {
            selectElement.innerHTML = ''; // Clear existing options
            provincesToFetchForBulkUpdate.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.dbKey;
                option.textContent = loc.displayName;
                selectElement.appendChild(option);
            });
        }

        function handleGetCurrentLocationClick() {
            if (pinnedLocationFromStorage) {
                // If a location is pinned, load its data
                currentSelectedLocation = pinnedLocationFromStorage;
                provinceSelect.value = pinnedLocationFromStorage.dbKey; // Sync main dropdown
                localStorage.setItem('lastSelectedLocationDbKey_v3', pinnedLocationFromStorage.dbKey); // Also update last general selection
                loadWeatherDataForLocation(pinnedLocationFromStorage);
            } else {
                // If no location is pinned, open the modal to select one
                pinnedLocationModalInstance.show();
            }
        }

        function handleChangePinnedLocationClick() {
             // This button is only visible if a location is pinned, so always open modal
            if (pinnedLocationFromStorage) {
                pinnedLocationSelectModalEl.value = pinnedLocationFromStorage.dbKey; // Pre-select current pinned
            }
            pinnedLocationModalInstance.show();
        }

        function handleSavePinnedLocation() {
            const selectedDbKey = pinnedLocationSelectModalEl.value;
            const newPinnedLocation = provincesToFetchForBulkUpdate.find(p => p.dbKey === selectedDbKey);

            if (newPinnedLocation) {
                localStorage.setItem(USER_PINNED_LOCATION_KEY_V3, selectedDbKey);
                pinnedLocationFromStorage = newPinnedLocation;
                currentSelectedLocation = newPinnedLocation; // Also make it the active location
                provinceSelect.value = newPinnedLocation.dbKey; // Sync main dropdown
                localStorage.setItem('lastSelectedLocationDbKey_v3', newPinnedLocation.dbKey); // Update general last selection

                console.log("Pinned location saved:", newPinnedLocation.displayName);
                loadWeatherDataForLocation(newPinnedLocation);
                updatePinnedLocationButtonUI();
                pinnedLocationModalInstance.hide();
            }
        }

        function updatePinnedLocationButtonUI() {
            if (pinnedLocationFromStorage) {
                getCurrentLocationBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i> Kayıtlı Konum: ${pinnedLocationFromStorage.displayName.split(" ")[0]}`; // Show only province name or short version
                getCurrentLocationBtn.classList.remove('btn-primary');
                getCurrentLocationBtn.classList.add('btn-success');
                changePinnedLocationBtn.style.display = 'inline-block';
            } else {
                getCurrentLocationBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i> "Mevcut Konum" Kaydet/Seç`;
                getCurrentLocationBtn.classList.remove('btn-success');
                getCurrentLocationBtn.classList.add('btn-primary');
                changePinnedLocationBtn.style.display = 'none';
            }
        }


        function handleProvinceSelectChange() {
            const selectedDbKey = provinceSelect.value;
            const selectedLoc = provincesToFetchForBulkUpdate.find(p => p.dbKey === selectedDbKey);
            if (selectedLoc) {
                currentSelectedLocation = selectedLoc;
                localStorage.setItem('lastSelectedLocationDbKey_v3', selectedLoc.dbKey);
                loadWeatherDataForLocation(selectedLoc);
            }
        }
        
        function handleQuickCitySelect(event) {
            const cityName = event.target.dataset.city;
            const targetLocation = provincesToFetchForBulkUpdate.find(p => p.displayName === cityName + " Merkez" || p.displayName === cityName);
            if (targetLocation) {
                currentSelectedLocation = targetLocation;
                provinceSelect.value = targetLocation.dbKey;
                localStorage.setItem('lastSelectedLocationDbKey_v3', targetLocation.dbKey);
                loadWeatherDataForLocation(targetLocation);
            }
        }

        function handleQuickCitySpecialSelect(event) {
            const provinceName = event.target.dataset.city;
            const districtName = event.target.dataset.district;
            const targetLocation = provincesToFetchForBulkUpdate.find(p => p.displayName === `${provinceName} ${districtName}`);
            if (targetLocation) {
                currentSelectedLocation = targetLocation;
                provinceSelect.value = targetLocation.dbKey;
                localStorage.setItem('lastSelectedLocationDbKey_v3', targetLocation.dbKey);
                loadWeatherDataForLocation(targetLocation);
            }
        }


        function handleForceRefresh() {
            if (currentSelectedLocation) {
                console.log("Forcing refresh for current location:", currentSelectedLocation.displayName);
                fetchAndSaveWeatherData(currentSelectedLocation, true); 
            } else {
                alert("Lütfen önce bir konum seçin.");
            }
        }
        
        function handleForceBulkUpdate() {
            console.log("Force bulk update triggered by button.");
            bulkUpdateAllProvincesData(true); 
        }
        

        async function loadWeatherDataForLocation(location, forceApiFetch = false) {
            if (!location || !location.dbKey) {
                console.error("Invalid location provided to loadWeatherDataForLocation:", location);
                updateWeatherDisplay(null, "Geçersiz Konum");
                return;
            }
            showLoading(`${location.displayName} için veri yükleniyor...`);
            const result = await fetchAndSaveWeatherData(location, forceApiFetch);
            
            if (result && result.data) {
                currentSelectedLocation.weatherData = result.data; // Store fetched data with the location object
                updateWeatherDisplay(result.data, location.displayName);
                updateDetailedInfo(result.data); // Pass the whole enriched data
                updateForecastTabs(result.data, location.displayName); // Pass the whole enriched data
                updateAlerts(result.data, location.displayName); // Pass the whole enriched data
                updateMapTab(location.lat, location.lon, location.displayName);
                 if (result.fromCache) {
                    console.log(`${location.displayName} data loaded from cache. Timestamp: ${new Date(result.data.timestamp).toLocaleString('tr-TR')}`);
                } else {
                    console.log(`${location.displayName} data fetched from API and saved. Timestamp: ${new Date(result.data.timestamp).toLocaleString('tr-TR')}`);
                }
            } else {
                console.error(`Failed to load weather data for ${location.displayName}.`);
                updateWeatherDisplay(null, location.displayName + " (Veri Alınamadı)");
                 const staleData = await getWeatherDataFromDB(location.dbKey);
                 if (staleData) {
                    console.warn(`Displaying stale data for ${location.displayName} as a fallback.`);
                    currentSelectedLocation.weatherData = staleData;
                    updateWeatherDisplay(staleData, location.displayName + " (Eski Veri)");
                    updateDetailedInfo(staleData);
                    updateForecastTabs(staleData, location.displayName);
                    updateAlerts(staleData, location.displayName);
                    updateMapTab(location.lat, location.lon, location.displayName);
                 }
            }
            hideLoading();
        }

        async function fetchAndSaveWeatherData(location, forceApi = false) {
            if (!db) return null;
            if (!forceApi) {
                const dbData = await getWeatherDataFromDB(location.dbKey);
                if (dbData && dbData.timestamp && (Date.now() - dbData.timestamp < CACHE_DURATION_MS)) {
                    console.log(`Fresh data for ${location.displayName} found in DB.`);
                    return { data: dbData, fromCache: true };
                }
            }
            
            // Primary API: Open-Meteo (for richer data)
            const hourlyParams = "temperature_2m,relative_humidity_2m,apparent_temperature,precipitation_probability,precipitation,rain,showers,snowfall,weather_code,surface_pressure,cloud_cover,visibility,wind_speed_10m,wind_direction_10m,wind_gusts_10m,uv_index,is_day";
            const dailyParams = "weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,uv_index_max,precipitation_sum,rain_sum,showers_sum,snowfall_sum,precipitation_hours,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant";
            const currentParams = "temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,cloud_cover,surface_pressure,wind_speed_10m,wind_direction_10m,wind_gusts_10m,uv_index";
            
            const openMeteoUrl = `${OPEN_METEO_API_BASE_URL}?latitude=${location.lat}&longitude=${location.lon}&current=${currentParams}&hourly=${hourlyParams}&daily=${dailyParams}&timezone=auto&forecast_days=7`;

            try {
                console.log(`Fetching from Open-Meteo API for ${location.displayName}`);
                const response = await fetch(openMeteoUrl);
                if (!response.ok) {
                    console.error(`Open-Meteo API Error for ${location.displayName}: ${response.status} ${response.statusText}`);
                    return { data: null, fromCache: false, error: `API Hatası: ${response.status}` };
                }
                const apiData = await response.json();
                if (apiData && apiData.current && apiData.hourly && apiData.daily) {
                    // Add units and a combined structure for easier handling later
                    const enrichedData = { 
                        ...apiData, 
                        units: apiData.current_units, // Or map from hourly_units if preferred
                        timestamp: Date.now(), 
                        dbKey: location.dbKey 
                    };
                    await saveWeatherDataToDB(enrichedData);
                    return { data: enrichedData, fromCache: false };
                } else {
                    console.error(`Invalid Open-Meteo API data structure for ${location.displayName}:`, apiData);
                    return { data: null, fromCache: false, error: "Geçersiz API Verisi" };
                }
            } catch (error) {
                console.error(`Network or fetch error for ${location.displayName} (Open-Meteo):`, error);
                return { data: null, fromCache: false, error: "Ağ Hatası" };
            }
        }


        function getWeatherDataFromDB(dbKey) {
            return new Promise((resolve, reject) => {
                if (!db) { reject("DB not open"); return; }
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(dbKey);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => {
                    console.error("Error reading from DB:", request.error);
                    reject(request.error);
                };
            });
        }

        function saveWeatherDataToDB(data) {
            return new Promise((resolve, reject) => {
                if (!db) { reject("DB not open"); return; }
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(data); 
                request.onsuccess = () => {
                    console.log(`Data for ${data.dbKey} saved to DB successfully.`);
                    resolve(request.result);
                };
                request.onerror = () => {
                    console.error("Error writing to DB:", request.error);
                    reject(request.error);
                };
            });
        }
        
        async function updateDataProgressIndicator() {
            if (!db) {
                dataProgressIndicator.textContent = 'Veritabanı Yok';
                return;
            }
            let relevantCount = 0;
            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const keyRequest = store.getAllKeys();
                keyRequest.onsuccess = () => {
                    const allKeysInDb = keyRequest.result;
                    provincesToFetchForBulkUpdate.forEach(targetLoc => {
                        if (allKeysInDb.includes(targetLoc.dbKey)) {
                            relevantCount++;
                        }
                    });
                    dataProgressIndicator.textContent = `Veri: ${relevantCount} / ${TOTAL_TARGET_LOCATIONS}`;
                };
                keyRequest.onerror = () => {
                     dataProgressIndicator.textContent = `Veri: ? / ${TOTAL_TARGET_LOCATIONS}`;
                }
            } catch (error) {
                console.error("Error updating data progress indicator:", error);
                dataProgressIndicator.textContent = 'Veri Durumu: Hata';
            }
        }


        async function bulkUpdateAllProvincesData(forceUpdate = false) {
            if (isBulkUpdating) {
                console.log("Bulk update already in progress.");
                if (loadingMessageEl.textContent.includes("tamamlandı") || loadingMessageEl.textContent.includes("bekleniyor")) {
                     console.warn("isBulkUpdating was true but message suggested completion. Resetting flag.");
                     isBulkUpdating = false;
                } else { return; }
            }
            
            const lastBulkUpdateTimeString = localStorage.getItem('lastBulkUpdateTime_v3');
            if (!forceUpdate && lastBulkUpdateTimeString) {
                const lastBulkUpdateTimeMs = parseInt(lastBulkUpdateTimeString);
                if (!isNaN(lastBulkUpdateTimeMs) && (Date.now() - lastBulkUpdateTimeMs) < SIX_HOURS_MS) {
                    console.log(`AUTO BULK UPDATE SKIPPED. Next auto update in approx: ${formatTimeDifference(SIX_HOURS_MS - (Date.now() - lastBulkUpdateTimeMs))}`);
                    updateNextBulkUpdateDisplay(lastBulkUpdateTimeMs);
                    if (!document.getElementById('loadingContainer').style.display.includes('none') && !currentSelectedLocation) {
                        hideLoading(); 
                    }
                    return;
                }
            }

            console.log(forceUpdate ? "FORCED bulk update starting." : "AUTOMATIC bulk update starting.");
            isBulkUpdating = true;
            let updatedSomethingInBulk = false;
            let successfulUpdates = 0;
            let failedUpdates = 0;
            const totalToUpdate = provincesToFetchForBulkUpdate.length;

            showLoading(`Toplu güncelleme başlatılıyor (0/${totalToUpdate})...`);
            updateLastBulkUpdateTimeDisplay(); 

            for (let i = 0; i < totalToUpdate; i++) {
                const locationToProcess = provincesToFetchForBulkUpdate[i];
                updateLoadingMessage(`İller Güncelleniyor: ${i + 1} / ${totalToUpdate} (Şu an: ${locationToProcess.displayName})...`);
                
                const result = await fetchAndSaveWeatherData(locationToProcess, true); // Always force API during bulk
                if (result) {
                    if (!result.fromCache && result.data) { 
                        updatedSomethingInBulk = true;
                        successfulUpdates++;
                    } else if (result.fromCache && result.data) {
                         // This case shouldn't happen if forceApi=true was effective
                    } else { 
                        console.error(`Bulk update failed for ${locationToProcess.displayName}. Error: ${result.error || 'Unknown'}`);
                        failedUpdates++;
                    }
                } else {
                    console.error(`Bulk update failed critically for ${locationToProcess.displayName}.`);
                    failedUpdates++;
                }

                if (i < totalToUpdate - 1) {
                    await new Promise(resolve => setTimeout(resolve, BULK_REQUEST_DELAY));
                }
            }
            
            isBulkUpdating = false;
            let summaryMessage = `Toplu güncelleme tamamlandı. Başarılı API güncellemesi: ${successfulUpdates}, Başarısız: ${failedUpdates}.`;
            if (updatedSomethingInBulk || (successfulUpdates > 0 && totalToUpdate > 0)) { // Ensure time is set if any success
                localStorage.setItem('lastBulkUpdateTime_v3', Date.now().toString());
                console.log("Bulk update finished. Last update time saved:", new Date(Date.now()).toLocaleString('tr-TR'));
                summaryMessage += " Son güncelleme zamanı kaydedildi.";
                 if (currentSelectedLocation) { 
                    loadWeatherDataForLocation(currentSelectedLocation, false); 
                }
            } else {
                summaryMessage += " API'den yeni veri alınmadı veya tümü başarısız. Son güncelleme zamanı değiştirilmedi.";
            }
            
            console.log(summaryMessage);
            showLoading(summaryMessage, 3000); 
            updateDataProgressIndicator();
            updateLastBulkUpdateTimeDisplay();
            updateNextBulkUpdateDisplay(localStorage.getItem('lastBulkUpdateTime_v3') ? parseInt(localStorage.getItem('lastBulkUpdateTime_v3')) : null);
        }


        function updateWeatherDisplay(enrichedData, cityName) {
            clearInterval(tempInterpolationInterval);
            if (!enrichedData || !enrichedData.current || !enrichedData.hourly) {
                currentCityEl.textContent = cityName || "Bilinmeyen Konum";
                currentTempEl.textContent = "--°C";
                currentConditionEl.textContent = "Veri Yok";
                currentConditionIconEl.className = 'fas fa-question-circle';
                currentTimestampEl.textContent = `Güncelleme: ${new Date().toLocaleTimeString('tr-TR')}`;
                updateDetailedInfo(null);
                updateForecastTabs(null, cityName);
                updateAlerts(null, cityName);
                updateMapTab(null, null, cityName);
                return;
            }

            const current = enrichedData.current;
            const units = enrichedData.units || enrichedData.current_units || {}; // Use correct units source
            
            currentCityEl.textContent = cityName;
            currentTempEl.textContent = `${current.temperature_2m !== null ? current.temperature_2m.toFixed(0) : '--'}°${units.temperature_2m || 'C'}`;
            
            const { description, Icon } = getWeatherSymbolInfoOpenMeteo(current.weather_code, current.is_day === 1);
            currentConditionEl.textContent = description;
            currentConditionIconEl.className = Icon;

            const lastUpdated = enrichedData.timestamp ? new Date(enrichedData.timestamp) : new Date();
            const dataTime = new Date(current.time); // Open-Meteo current.time is already ISO
            currentTimestampEl.textContent = `Veri Zamanı: ${dataTime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} | Saklandı: ${lastUpdated.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
        }

        function updateDetailedInfo(enrichedData) {
            detailsContainer.innerHTML = ''; // Clear previous details
            const na = "N/A";

            if (!enrichedData || !enrichedData.current) {
                detailsContainer.innerHTML = '<p class="text-muted">Ayrıntılı veri bulunamadı.</p>';
                return;
            }
            
            const current = enrichedData.current;
            const units = enrichedData.units || enrichedData.current_units || {};

            const detailsToShow = [
                { label: "Sıcaklık", value: current.temperature_2m, unit: units.temperature_2m || '°C' },
                { label: "Hissedilen S.", value: current.apparent_temperature, unit: units.apparent_temperature || '°C' },
                { label: "Bağıl Nem", value: current.relative_humidity_2m, unit: units.relative_humidity_2m || '%' },
                { label: "Basınç (Deniz Sv.)", value: current.surface_pressure, unit: units.surface_pressure || 'hPa' }, // Open-Meteo current.surface_pressure is often MSL
                { label: "Rüzgar Hızı", value: current.wind_speed_10m, unit: units.wind_speed_10m || 'km/h' },
                { label: "Rüzgar Yönü", value: current.wind_direction_10m, unit: units.wind_direction_10m || '°' },
                { label: "Rüzgar Hamlesi", value: current.wind_gusts_10m, unit: units.wind_gusts_10m || 'km/h' },
                { label: "Bulut Örtüsü", value: current.cloud_cover, unit: units.cloud_cover || '%' },
                { label: "Görüş Mesafesi", value: current.visibility !== undefined ? (current.visibility / 1000) : null, unit: 'km' }, // Convert meters to km
                { label: "UV İndeksi", value: current.uv_index, unit: "" },
                { label: "Anlık Yağış", value: current.precipitation, unit: units.precipitation || 'mm' },
                { label: "Anlık Yağmur", value: current.rain, unit: units.rain || 'mm' },
                { label: "Anlık Sağanak", value: current.showers, unit: units.showers || 'mm' },
                { label: "Anlık Kar", value: current.snowfall, unit: units.snowfall || 'cm' }, // OpenMeteo provides cm for snowfall
            ];

            detailsToShow.forEach(detail => {
                if (detail.value !== undefined && detail.value !== null) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'detail-item';
                    itemDiv.innerHTML = `
                        <span class="label">${detail.label}</span>
                        <span class="value">${typeof detail.value === 'number' ? detail.value.toFixed(detail.unit === 'km' || detail.unit === 'mm' ? 1 : 0) : detail.value}${detail.unit || ''}</span>
                    `;
                    detailsContainer.appendChild(itemDiv);
                }
            });
             if (detailsContainer.childElementCount === 0) {
                detailsContainer.innerHTML = '<p class="text-muted col-12">Gösterilecek ek ayrıntı bulunamadı.</p>';
            }
        }


        function updateForecastTabs(enrichedData, cityName) {
            alertLocationNameEl.textContent = cityName || "Seçili Konum";
            if (!enrichedData || !enrichedData.hourly || !enrichedData.hourly.time || !enrichedData.daily || !enrichedData.daily.time) {
                hourlyForecastContainer.innerHTML = '<p class="text-muted">Saatlik tahmin verisi bulunamadı.</p>';
                dailyForecastContainer.innerHTML = '<p class="text-muted">Günlük tahmin verisi bulunamadı.</p>';
                return;
            }

            const hourly = enrichedData.hourly;
            const daily = enrichedData.daily;
            const units = enrichedData.units || enrichedData.hourly_units || {};

            // Hourly Forecast (first 24 entries)
            let hourlyHtml = '';
            const hourlyToShow = Math.min(hourly.time.length, 24);
            for (let i = 0; i < hourlyToShow; i++) {
                const time = new Date(hourly.time[i]);
                const symbolInfo = getWeatherSymbolInfoOpenMeteo(hourly.weather_code[i], hourly.is_day[i] === 1);
                hourlyHtml += `
                    <div class="hourly-forecast-item">
                        <div>${time.getHours()}:00</div>
                        <div class="icon"><i class="${symbolInfo.Icon}"></i></div>
                        <div>${hourly.temperature_2m[i] !== null ? hourly.temperature_2m[i].toFixed(0) : '--'}°</div>
                        <div class="text-muted small">${hourly.precipitation[i] !== null ? hourly.precipitation[i].toFixed(1) : '--'}mm</div>
                    </div>
                `;
            }
            hourlyForecastContainer.innerHTML = hourlyHtml || '<p class="text-muted">Saatlik tahmin verisi yok.</p>';

            // Daily Forecast (up to 7 days)
            let dailyHtml = '';
            for (let i = 0; i < daily.time.length; i++) {
                const date = new Date(daily.time[i]);
                const symbolInfo = getWeatherSymbolInfoOpenMeteo(daily.weather_code[i], true); // Assume day for daily icon
                const dayName = date.toLocaleDateString('tr-TR', { weekday: 'short' });

                dailyHtml += `
                    <div class="daily-forecast-item">
                        <span class="day">${dayName}, ${date.toLocaleDateString('tr-TR', {day: '2-digit', month:'short'})}</span>
                        <span class="icon"><i class="${symbolInfo.Icon}"></i></span>
                        <span>${daily.temperature_2m_min[i] !== null ? daily.temperature_2m_min[i].toFixed(0) : '--'}° / ${daily.temperature_2m_max[i] !== null ? daily.temperature_2m_max[i].toFixed(0) : '--'}°</span>
                        <span class="text-muted small">${daily.precipitation_sum[i] !== null ? daily.precipitation_sum[i].toFixed(1) : '--'}mm</span>
                    </div>
                `;
            }
            dailyForecastContainer.innerHTML = dailyHtml || '<p class="text-muted">Günlük tahmin verisi yok.</p>';
        }
        
        function updateAlerts(enrichedData, cityName) {
            alertsContainer.innerHTML = ''; 
            if (!enrichedData || !enrichedData.hourly || !enrichedData.hourly.time || enrichedData.hourly.time.length === 0) {
                alertsContainer.innerHTML = '<p class="text-muted">Uyarı analizi için saatlik veri bulunamadı.</p>';
                return;
            }

            const hourly = enrichedData.hourly;
            const lookAheadEntries = Math.min(hourly.time.length, 66); // Up to 66 hours

            let hasRain = false;
            let hasSnow = false;
            let hasCold = false;
            let hasHot = false;
            let hasStorm = false;

            for (let i = 0; i < lookAheadEntries; i++) {
                if (hourly.precipitation?.[i] > 0 && (hourly.rain?.[i] > 0 || hourly.showers?.[i] > 0)) hasRain = true;
                if (hourly.snowfall?.[i] > 0) hasSnow = true; // OpenMeteo gives snowfall in cm
                if (hourly.temperature_2m?.[i] < 5) hasCold = true;
                if (hourly.temperature_2m?.[i] > 30) hasHot = true;
                // WMO codes for thunderstorm: 95 (slight/moderate), 96 & 99 (with hail), 97 (heavy)
                if ([95, 96, 97, 99].includes(hourly.weather_code?.[i])) hasStorm = true;

            }
            
            let alertMessage = "";
            if (hasRain) alertMessage += "Yağmur ";
            if (hasSnow) alertMessage += (alertMessage ? ", " : "") + "Kar ";
            if (hasCold) alertMessage += (alertMessage ? ", " : "") + "Soğuk Hava ";
            if (hasHot) alertMessage += (alertMessage ? ", " : "") + "Sıcak Hava ";
            if (hasStorm && !(alertMessage.includes("Yağmur") || alertMessage.includes("Kar"))) { // Avoid redundant storm if rain/snow already mentioned
                 alertMessage += (alertMessage ? ", " : "") + "Fırtına ";
            }


            if (alertMessage) {
                 const finalAlertMessage = `Önümüzdeki 66 saat içinde ${cityName} için ${alertMessage.trim().replace(/,\s*$/, "")} beklentisi var. Detaylar için saatlik/günlük tahminleri kontrol edin.`;
                 const alertDiv = document.createElement('div');
                 alertDiv.className = `alert alert-warning alert-dismissible fade show small p-2 mb-2`; // General warning
                 alertDiv.role = 'alert';
                 alertDiv.innerHTML = `
                    <strong>Uyarı!</strong> ${finalAlertMessage}
                    <button type="button" class="btn-close btn-sm p-2" data-bs-dismiss="alert" aria-label="Close"></button>
                 `;
                 alertsContainer.appendChild(alertDiv);
            } else {
                alertsContainer.innerHTML = '<p class="text-muted">Önümüzdeki 66 saat için önemli bir meteorolojik uyarı bulunmuyor.</p>';
            }
        }

        function updateMapTab(lat, lon, locationName) {
            mapLocationEl.textContent = locationName || "Bilinmiyor";
            if (lat && lon) {
                mapContainer.innerHTML = `<iframe src="https://maps.google.com/maps?q=${lat},${lon}&hl=tr&z=10&output=embed" width="100%" height="100%"></iframe>`;
            } else {
                mapContainer.innerHTML = '<p class="text-muted">Harita için konum bilgisi bulunamadı.</p>';
            }
        }
        
        // WMO Weather interpretation codes (WW) from Open-Meteo
        const WMO_CODE_MAP = {
            0: { description: 'Açık', icon: 'fas fa-sun' },
            1: { description: 'Parçalı Az Bulutlu', icon: 'fas fa-cloud-sun' },
            2: { description: 'Parçalı Bulutlu', icon: 'fas fa-cloud' },
            3: { description: 'Çok Bulutlu', icon: 'fas fa-cloud' },
            45: { description: 'Sisli', icon: 'fas fa-smog' },
            48: { description: 'Kırağı Sisi', icon: 'fas fa-smog' }, // Freezing fog
            51: { description: 'Hafif Çisenti', icon: 'fas fa-cloud-rain' }, // Drizzle
            53: { description: 'Orta Çisenti', icon: 'fas fa-cloud-rain' },
            55: { description: 'Yoğun Çisenti', icon: 'fas fa-cloud-showers-heavy' },
            56: { description: 'Hafif Donan Çisenti', icon: 'fas fa-snowflake' }, // Freezing Drizzle
            57: { description: 'Yoğun Donan Çisenti', icon: 'fas fa-snowflake' },
            61: { description: 'Hafif Yağmurlu', icon: 'fas fa-cloud-rain' },
            63: { description: 'Orta Yağmurlu', icon: 'fas fa-cloud-rain' },
            65: { description: 'Şiddetli Yağmurlu', icon: 'fas fa-cloud-showers-heavy' },
            66: { description: 'Hafif Donan Yağmur', icon: 'fas fa-snowflake' }, // Freezing Rain
            67: { description: 'Yoğun Donan Yağmur', icon: 'fas fa-snowflake' },
            71: { description: 'Hafif Kar Yağışlı', icon: 'fas fa-snowflake' },
            73: { description: 'Orta Kar Yağışlı', icon: 'fas fa-snowflake' },
            75: { description: 'Yoğun Kar Yağışlı', icon: 'fas fa-snowflake' },
            77: { description: 'Kar Taneleri', icon: 'fas fa-snowflake' }, // Snow grains
            80: { description: 'Hafif Sağanak Yağmur', icon: 'fas fa-cloud-showers-heavy' },
            81: { description: 'Orta Sağanak Yağmur', icon: 'fas fa-cloud-showers-heavy' },
            82: { description: 'Şiddetli Sağanak Yağmur', icon: 'fas fa-cloud-showers-heavy' },
            85: { description: 'Hafif Kar Sağanağı', icon: 'fas fa-snowflake' },
            86: { description: 'Yoğun Kar Sağanağı', icon: 'fas fa-snowflake' },
            95: { description: 'Gök Gürültülü Fırtına', icon: 'fas fa-bolt' }, // Thunderstorm slight or moderate
            96: { description: 'Hafif Dolu ile Fırtına', icon: 'fas fa-cloud-meatball' }, // Thunderstorm with slight hail
            99: { description: 'Yoğun Dolu ile Fırtına', icon: 'fas fa-cloud-meatball' }  // Thunderstorm with heavy hail
        };

        function getWeatherSymbolInfoOpenMeteo(wmoCode, isDay = true) {
            const info = WMO_CODE_MAP[wmoCode];
            if (info) {
                if (wmoCode === 0 && !isDay) return { description: 'Açık (Gece)', Icon: 'fas fa-moon' };
                if (wmoCode === 1 && !isDay) return { description: 'Az Bulutlu (Gece)', Icon: 'fas fa-cloud-moon' };
                return { description: info.description, Icon: info.icon };
            }
            return { description: 'Bilinmiyor', Icon: 'fas fa-question-circle' };
        }


        function showLoading(message, autoHideDelay = 0) {
            loadingMessageEl.textContent = message;
            loadingContainer.style.display = 'flex';
            if (autoHideDelay > 0) {
                setTimeout(() => {
                    if (loadingMessageEl.textContent === message) {
                        hideLoading();
                    }
                }, autoHideDelay);
            }
        }

        function hideLoading() {
            loadingContainer.style.display = 'none';
        }

        function updateLoadingMessage(message) {
            if (loadingContainer.style.display !== 'none') {
                loadingMessageEl.textContent = message;
            }
        }
        
        function showError(message) {
            alert(message);
            console.error(message);
        }
        
        function formatTimeDifference(ms) {
            if (ms < 0) ms = 0;
            let seconds = Math.floor(ms / 1000);
            let minutes = Math.floor(seconds / 60);
            let hours = Math.floor(minutes / 60);

            seconds %= 60;
            minutes %= 60;

            if (hours > 0) return `${hours} sa ${minutes} dk`;
            if (minutes > 0) return `${minutes} dk ${seconds} sn`;
            return `${seconds} sn`;
        }
        
        function updateLastBulkUpdateTimeDisplay() {
            const lastTime = localStorage.getItem('lastBulkUpdateTime_v3');
            if (lastTime) {
                lastBulkUpdateTimeDisplay.textContent = new Date(parseInt(lastTime)).toLocaleString('tr-TR');
            } else {
                lastBulkUpdateTimeDisplay.textContent = "Henüz Yok";
            }
        }

        function updateNextBulkUpdateDisplay(lastUpdateTimeMs) {
            if (lastUpdateTimeMs) {
                const nextUpdateTs = lastUpdateTimeMs + SIX_HOURS_MS;
                const remainingMs = nextUpdateTs - Date.now();
                if (remainingMs > 0) {
                    nextBulkUpdateTimeDisplay.textContent = `${formatTimeDifference(remainingMs)} sonra (${new Date(nextUpdateTs).toLocaleTimeString('tr-TR')})`;
                } else {
                    nextBulkUpdateTimeDisplay.textContent = "Şimdi veya Yakında";
                }
            } else {
                nextBulkUpdateTimeDisplay.textContent = "Belirsiz (İlk güncelleme bekleniyor)";
            }
        }

    </script>
</body>
</html>