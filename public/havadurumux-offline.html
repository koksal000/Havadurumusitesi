
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İnternetsiz HavaDurumuX - Türkiye'nin En Kapsamlı Hava Durumu Platformu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0066CC;
            --secondary-blue: #0080FF;
            --accent-orange: #FF6B35;
            --success-green: #00C896;
            --warning-yellow: #FFD23F;
            --danger-red: #FF4757;
            --dark-navy: #1A1D29;
            --light-gray: #F8FAFC;
            --medium-gray: #64748B;
            --border-color: #E2E8F0;
            --shadow-light: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-large: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --light-gray: #1A1D29;
            --dark-navy: #F8FAFC;
            --border-color: #334155;
            --medium-gray: #94A3B8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-navy);
            min-height: 100vh;
            transition: var(--transition);
            overflow-x: hidden;
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: var(--light-gray);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 1.5rem 0;
            box-shadow: var(--shadow-medium);
        }

        [data-theme="dark"] .header {
            background: rgba(26, 29, 41, 0.95);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: var(--shadow-medium);
        }

        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        .logo-text p {
            font-size: 0.9rem;
            color: var(--medium-gray);
            margin: 0;
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .theme-toggle, .location-btn, .refresh-btn {
            background: var(--light-gray);
            border: 2px solid var(--border-color);
            color: var(--dark-navy);
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle:hover, .location-btn:hover, .refresh-btn:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .search-section {
            max-width: 1400px;
            margin: 3rem auto;
            padding: 0 2rem;
        }

        .search-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: var(--shadow-large);
            border: 1px solid var(--border-color);
        }

        [data-theme="dark"] .search-container {
            background: rgba(26, 29, 41, 0.95);
        }

        .search-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .search-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-navy);
            margin-bottom: 0.5rem;
        }

        .search-header p {
            color: var(--medium-gray);
            font-size: 1.1rem;
        }

        .search-input-group {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1.2rem 1.5rem 1.2rem 3.5rem;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            font-size: 1.1rem;
            background: var(--light-gray);
            color: var(--dark-navy);
            transition: var(--transition);
            font-weight: 500;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
            transform: translateY(-2px);
        }

        .search-icon {
            position: absolute;
            left: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--medium-gray);
            font-size: 1.2rem;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .quick-action-btn {
            background: var(--light-gray);
            border: 2px solid var(--border-color);
            color: var(--dark-navy);
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-action-btn:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            transform: translateY(-2px);
        }

        .province-grid-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: var(--shadow-large);
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        [data-theme="dark"] .province-grid-container {
            background: rgba(26, 29, 41, 0.98);
        }

        .province-grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .province-grid-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-navy);
        }

        .province-count {
            background: var(--gradient-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .region-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            justify-content: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        .region-filter {
            padding: 0.8rem 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            background: white;
            color: var(--dark-navy);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .region-filter:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            transform: translateY(-2px);
        }

        .region-filter.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .province-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.2rem;
        }

        .province-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .province-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            transition: left 0.6s;
        }

        .province-item:hover::before {
            left: 100%;
        }

        .province-item:hover {
            transform: translateY(-5px) scale(1.02);
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-large);
        }

        .province-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .province-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
        }

        .province-plate {
            background: var(--primary-blue);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .province-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }

        .province-item:hover .info-item {
            color: rgba(255, 255, 255, 0.9);
        }

        .province-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .province-item:hover .province-stats {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .province-population {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .weather-preview {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .loading-container {
            display: none;
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            margin: 2rem auto;
            max-width: 600px;
            box-shadow: var(--shadow-large);
        }

        .loading-container.active {
            display: block;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-left: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-navy);
            margin-bottom: 0.5rem;
        }

        .loading-subtext {
            color: var(--medium-gray);
            font-size: 1rem;
        }
         .progress-bar-container {
            width: 80%;
            background-color: var(--border-color);
            border-radius: 10px;
            margin: 1rem auto;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: var(--success-green);
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.5s ease-in-out;
            font-size: 0.8rem;
        }

        .weather-display {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem 4rem;
        }

        .weather-display.active {
            display: block;
        }

        .current-weather {
            background: var(--gradient-primary);
            color: white;
            border-radius: 24px;
            padding: 3rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-large);
        }

        .current-weather::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .weather-location {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .weather-location h2 {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
        }

        .weather-main {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 3rem;
            margin-bottom: 2rem;
        }

        .weather-icon-main {
            font-size: 6rem;
            text-align: center;
        }

        .weather-temp {
            font-size: 5rem;
            font-weight: 300;
            line-height: 1;
            text-align: center;
        }
        .weather-temp-animation {
            transition: opacity 0.5s ease-in-out;
        }

        .weather-desc {
            text-align: center;
        }

        .weather-desc h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .weather-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adjusted minmax for more items */
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }

        .detail-card:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .detail-icon {
            font-size: 1.8rem; /* Slightly smaller icon */
            margin-bottom: 0.8rem; /* Reduced margin */
        }

        .detail-value {
            font-size: 1.3rem; /* Slightly smaller value */
            font-weight: 700;
            margin-bottom: 0.3rem; /* Reduced margin */
        }

        .detail-label {
            font-size: 0.8rem; /* Slightly smaller label */
            opacity: 0.9;
        }

        .weather-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-medium);
            overflow-x: auto;
        }

        .weather-tab {
            flex: 1;
            min-width: 120px;
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            color: var(--dark-navy);
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .weather-tab:hover {
            background: rgba(0, 102, 204, 0.1);
        }

        .weather-tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-large);
        }
        [data-theme="dark"] .tab-content {
             background: rgba(26, 29, 41, 0.95);
        }


        .tab-content.active {
            display: block;
        }

        .forecast-scroll {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            padding: 1rem 0;
        }

        .forecast-item {
            min-width: 180px; /* Adjusted width */
            background: var(--light-gray);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }
         [data-theme="dark"] .forecast-item {
            background: #2a2f45; /* Darker background for items in dark mode */
        }


        .forecast-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-medium);
        }

        .forecast-day {
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .forecast-icon {
            font-size: 2.5rem; /* Adjusted icon size */
            margin: 0.8rem 0; /* Adjusted margin */
        }

        .forecast-temps {
            display: flex;
            justify-content: space-between;
            margin: 0.8rem 0; /* Adjusted margin */
            font-weight: 600;
        }

        .forecast-high {
            color: var(--danger-red);
        }

        .forecast-low {
            color: var(--primary-blue);
        }
        
        .hourly-chart-container {
            height: 300px; /* Default height, can be adjusted */
            margin-top: 1rem;
            position: relative;
        }
        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--medium-gray);
            font-style: italic;
        }


        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 0 1rem;
            }
             .header-controls {
                flex-direction: column;
                width: 100%;
            }
            .theme-toggle, .location-btn, .refresh-btn {
                width: 100%;
                justify-content: center;
            }

            .search-section {
                padding: 0 1rem;
                margin: 2rem auto;
            }

            .search-container {
                padding: 1.5rem;
            }

            .province-grid {
                grid-template-columns: 1fr;
            }

            .weather-main {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .weather-temp {
                font-size: 4rem;
            }

            .weather-tabs {
                flex-direction: column;
            }

            .weather-tab {
                min-width: auto;
            }
            .weather-details-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
             .detail-card {
                padding: 1rem;
            }
            .detail-icon {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            .detail-value {
                font-size: 1.1rem;
            }
            .detail-label {
                font-size: 0.75rem;
            }
        }

        .hidden {
            display: none !important;
        }

        .text-gradient {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 4px;
        }
         [data-theme="dark"] ::-webkit-scrollbar-track {
            background: #2a2f45;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-blue);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-cloud-sun"></i>
                </div>
                <div class="logo-text">
                    <h1>İnternetsiz HavaDurumuX</h1>
                    <p>Çevrimdışı Hava Durumu Bilgileri</p>
                </div>
            </div>
            <div class="header-controls">
                <button class="location-btn" onclick="getCurrentUserLocation()">
                    <i class="fas fa-location-arrow"></i>
                    Konumum
                </button>
                 <button class="refresh-btn" onclick="manualBulkUpdate()">
                    <i class="fas fa-sync-alt"></i>
                    Tüm Verileri Yenile
                </button>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                    <span id="themeText">Koyu Tema</span>
                </button>
            </div>
        </div>
    </header>

    <div class="search-section">
        <div class="search-container">
            <div class="search-header">
                <h2>Türkiye'nin Her Yerinden Çevrimdışı Hava Durumu</h2>
                <p>Veriler en son güncellendiğinde, internetsiz erişim sağlayın.</p>
            </div>
            
            <div class="search-input-group">
                <i class="fas fa-search search-icon"></i>
                 <select class="search-input" id="provinceSelector" onchange="handleProvinceSelection(this.value)">
                    <option value="">İl Seçin...</option>
                 </select>
            </div>

            <div class="quick-actions">
                <button class="quick-action-btn" onclick="selectLocation('İstanbul_Merkez', 'İstanbul')">
                    <i class="fas fa-city"></i>
                    İstanbul
                </button>
                <button class="quick-action-btn" onclick="selectLocation('Ankara_Merkez', 'Ankara')">
                    <i class="fas fa-landmark"></i>
                    Ankara
                </button>
                <button class="quick-action-btn" onclick="selectLocation('İzmir_Merkez', 'İzmir')">
                    <i class="fas fa-anchor"></i>
                    İzmir
                </button>
                <button class="quick-action-btn" onclick="selectLocation('Kütahya_Domaniç', 'Kütahya / Domaniç')">
                    <i class="fas fa-mountain"></i>
                    Domaniç
                </button>
                 <button class="quick-action-btn" onclick="selectLocation('Bursa_İnegöl', 'Bursa / İnegöl')">
                    <i class="fas fa-industry"></i>
                    İnegöl
                </button>
            </div>
            <div id="lastBulkUpdateTimeDisplay" style="text-align: center; margin-top: 1rem; color: var(--medium-gray); font-size: 0.9rem;">
                <!-- Last bulk update time will be shown here -->
            </div>
        </div>
    </div>

    <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingTextMain">Hava durumu bilgileri yükleniyor...</div>
        <div class="loading-subtext" id="loadingTextSub">Met Norway API'den gerçek veriler çekiliyor</div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="loadingProgressBar">0%</div>
        </div>
        <p id="currentUpdateStatus" style="font-size: 0.85rem; color: var(--medium-gray); margin-top: 0.5rem;"></p>
    </div>

    <div class="weather-display" id="weatherDisplay">
        <div class="current-weather">
            <div class="weather-location">
                <i class="fas fa-map-marker-alt"></i>
                <h2 id="currentCity">Seçili Konum</h2>
                <span id="currentCountry">Türkiye</span>
            </div>
            <div class="weather-main">
                <div class="weather-icon-main" id="currentIcon">☀️</div>
                <div class="weather-temp weather-temp-animation" id="currentTemp">--°</div>
                <div class="weather-desc">
                    <h3 id="currentDescription">Yükleniyor...</h3>
                    <p id="currentDate"></p>
                    <p id="dataLastUpdated" style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem;"></p>
                </div>
            </div>
            <div class="weather-details-grid">
                <div class="detail-card">
                    <div class="detail-icon"><i class="fas fa-thermometer-half"></i></div>
                    <div class="detail-value" id="feelsLike">--°</div>
                    <div class="detail-label">Hissedilen</div>
                </div>
                <div class="detail-card">
                    <div class="detail-icon"><i class="fas fa-tint"></i></div>
                    <div class="detail-value" id="humidity">--%</div>
                    <div class="detail-label">Nem</div>
                </div>
                <div class="detail-card">
                    <div class="detail-icon"><i class="fas fa-wind"></i></div>
                    <div class="detail-value" id="windSpeed">-- km/h</div>
                    <div class="detail-label">Rüzgar</div>
                </div>
                 <div class="detail-card">
                    <div class="detail-icon"><i class="fas fa-water"></i></div> <!-- Çiy Noktası için yeni ikon -->
                    <div class="detail-value" id="dewPoint">--°</div>
                    <div class="detail-label">Çiy Noktası</div>
                </div>
                <div class="detail-card">
                    <div class="detail-icon"><i class="fas fa-compress-arrows-alt"></i></div>
                    <div class="detail-value" id="pressure">-- hPa</div>
                    <div class="detail-label">Basınç</div>
                </div>
                <div class="detail-card">
                    <div class="detail-icon"><i class="fas fa-eye"></i></div>
                    <div class="detail-value" id="visibility">-- km</div>
                    <div class="detail-label">Görüş</div>
                </div>
                 <div class="detail-card">
                    <div class="detail-icon"><i class="fas fa-cloud"></i></div>
                    <div class="detail-value" id="cloudCover">--%</div>
                    <div class="detail-label">Bulutluluk</div>
                </div>
            </div>
        </div>

        <div class="weather-tabs">
            <button class="weather-tab active" onclick="showTab('hourly')">
                <i class="fas fa-clock"></i>
                Saatlik
            </button>
            <button class="weather-tab" onclick="showTab('daily')">
                <i class="fas fa-calendar-week"></i>
                Günlük
            </button>
            <button class="weather-tab" onclick="showTab('details')">
                <i class="fas fa-chart-line"></i>
                Detaylar
            </button>
             <button class="weather-tab" onclick="showTab('charts')">
                <i class="fas fa-chart-bar"></i>
                Grafikler
            </button>
            <button class="weather-tab" onclick="showTab('alerts')">
                <i class="fas fa-exclamation-triangle"></i>
                Uyarılar
            </button>
        </div>

        <div id="hourly" class="tab-content active">
            <h3><i class="fas fa-clock"></i> Yaklaşık 3 Günlük Saatlik Tahmin</h3>
            <div class="forecast-scroll" id="hourlyContainer">
                <p>Saatlik tahminler burada gösterilecek...</p>
            </div>
        </div>

        <div id="daily" class="tab-content">
            <h3 id="dailyForecastTitle"><i class="fas fa-calendar-week"></i> Günlük Tahmin (Yaklaşık 3 Gün)</h3>
            <div class="forecast-scroll" id="dailyContainer">
                <p>Günlük tahminler burada gösterilecek...</p>
            </div>
        </div>

        <div id="details" class="tab-content">
            <h3><i class="fas fa-chart-line"></i> Detaylı Bilgiler</h3>
            <div id="detailsContainer">
                <p>Seçili konum için detaylı meteorolojik bilgiler burada gösterilecek.</p>
            </div>
        </div>
        
        <div id="charts" class="tab-content">
            <h3><i class="fas fa-chart-bar"></i> Hava Durumu Grafikleri</h3>
            <div id="chartsContainer" class="hourly-chart-container">
                <div class="chart-placeholder">Saatlik sıcaklık grafiği burada gösterilecek.</div>
            </div>
             <div id="precipitationChartContainer" class="hourly-chart-container">
                <div class="chart-placeholder">Saatlik yağış ihtimali grafiği burada gösterilecek.</div>
            </div>
        </div>


        <div id="alerts" class="tab-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Meteoroloji Uyarıları</h3>
            <div id="alertsContainer">
                 <div style="text-align: center; padding: 2rem; color: var(--medium-gray);">
                    <i class="fas fa-shield-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h4>Aktif Uyarı Bulunmuyor</h4>
                    <p>Seçili konum için meteoroloji uyarısı bulunmamaktadır.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- START OF SCRIPT ---

        // CONFIGURATION
        const DB_NAME = 'HavaDurumuX_Offline_DB_v6';
        const DB_VERSION = 1; // Increment if schema changes
        const STORE_NAME = 'illerWeatherData_v5';
        const MET_NORWAY_API_USER_AGENT = 'HavaDurumuX_Offline/1.1 (domaniccamlicakoyu@gmail.com)';
        const BULK_UPDATE_INTERVAL_MS = 6 * 60 * 60 * 1000; // 6 hours
        const SINGLE_LOCATION_UPDATE_INTERVAL_MS = 6 * 60 * 60 * 1000; // 6 hours for individual updates too
        const BULK_REQUEST_DELAY = 15000; // 15 seconds between requests in bulk update

        // Data for provinces and specific districts to fetch during bulk update
        // IMPORTANT: Coordinates for "Merkez" districts are taken from the 'turkishProvinces' array below.
        // Ensure those are accurate for province centers.
        // For Domaniç and İnegöl, provide accurate lat/lon.
        const locationsToFetchForBulkUpdate = [
            { dbKey: 'Adana_Merkez', displayName: 'Adana', latKey: 'Adana', lonKey: 'Adana' },
            { dbKey: 'Adıyaman_Merkez', displayName: 'Adıyaman', latKey: 'Adıyaman', lonKey: 'Adıyaman' },
            { dbKey: 'Afyonkarahisar_Merkez', displayName: 'Afyonkarahisar', latKey: 'Afyonkarahisar', lonKey: 'Afyonkarahisar' },
            { dbKey: 'Ağrı_Merkez', displayName: 'Ağrı', latKey: 'Ağrı', lonKey: 'Ağrı' },
            { dbKey: 'Amasya_Merkez', displayName: 'Amasya', latKey: 'Amasya', lonKey: 'Amasya' },
            { dbKey: 'Ankara_Merkez', displayName: 'Ankara', latKey: 'Ankara', lonKey: 'Ankara' },
            { dbKey: 'Antalya_Merkez', displayName: 'Antalya', latKey: 'Antalya', lonKey: 'Antalya' },
            { dbKey: 'Artvin_Merkez', displayName: 'Artvin', latKey: 'Artvin', lonKey: 'Artvin' },
            { dbKey: 'Aydın_Merkez', displayName: 'Aydın', latKey: 'Aydın', lonKey: 'Aydın' },
            { dbKey: 'Balıkesir_Merkez', displayName: 'Balıkesir', latKey: 'Balıkesir', lonKey: 'Balıkesir' },
            { dbKey: 'Bilecik_Merkez', displayName: 'Bilecik', latKey: 'Bilecik', lonKey: 'Bilecik' },
            { dbKey: 'Bingöl_Merkez', displayName: 'Bingöl', latKey: 'Bingöl', lonKey: 'Bingöl' },
            { dbKey: 'Bitlis_Merkez', displayName: 'Bitlis', latKey: 'Bitlis', lonKey: 'Bitlis' },
            { dbKey: 'Bolu_Merkez', displayName: 'Bolu', latKey: 'Bolu', lonKey: 'Bolu' },
            { dbKey: 'Burdur_Merkez', displayName: 'Burdur', latKey: 'Burdur', lonKey: 'Burdur' },
            { dbKey: 'Bursa_Merkez', displayName: 'Bursa', latKey: 'Bursa', lonKey: 'Bursa' },
            { dbKey: 'Bursa_İnegöl', displayName: 'Bursa / İnegöl', lat: 40.0833, lon: 29.5167 }, // Specific district
            { dbKey: 'Çanakkale_Merkez', displayName: 'Çanakkale', latKey: 'Çanakkale', lonKey: 'Çanakkale' },
            { dbKey: 'Çankırı_Merkez', displayName: 'Çankırı', latKey: 'Çankırı', lonKey: 'Çankırı' },
            { dbKey: 'Çorum_Merkez', displayName: 'Çorum', latKey: 'Çorum', lonKey: 'Çorum' },
            { dbKey: 'Denizli_Merkez', displayName: 'Denizli', latKey: 'Denizli', lonKey: 'Denizli' },
            { dbKey: 'Diyarbakır_Merkez', displayName: 'Diyarbakır', latKey: 'Diyarbakır', lonKey: 'Diyarbakır' },
            { dbKey: 'Edirne_Merkez', displayName: 'Edirne', latKey: 'Edirne', lonKey: 'Edirne' },
            { dbKey: 'Elazığ_Merkez', displayName: 'Elazığ', latKey: 'Elazığ', lonKey: 'Elazığ' },
            { dbKey: 'Erzincan_Merkez', displayName: 'Erzincan', latKey: 'Erzincan', lonKey: 'Erzincan' },
            { dbKey: 'Erzurum_Merkez', displayName: 'Erzurum', latKey: 'Erzurum', lonKey: 'Erzurum' },
            { dbKey: 'Eskişehir_Merkez', displayName: 'Eskişehir', latKey: 'Eskişehir', lonKey: 'Eskişehir' },
            { dbKey: 'Gaziantep_Merkez', displayName: 'Gaziantep', latKey: 'Gaziantep', lonKey: 'Gaziantep' },
            { dbKey: 'Giresun_Merkez', displayName: 'Giresun', latKey: 'Giresun', lonKey: 'Giresun' },
            { dbKey: 'Gümüşhane_Merkez', displayName: 'Gümüşhane', latKey: 'Gümüşhane', lonKey: 'Gümüşhane' },
            { dbKey: 'Hakkâri_Merkez', displayName: 'Hakkâri', latKey: 'Hakkâri', lonKey: 'Hakkâri' },
            { dbKey: 'Hatay_Merkez', displayName: 'Hatay', latKey: 'Hatay', lonKey: 'Hatay' },
            { dbKey: 'Isparta_Merkez', displayName: 'Isparta', latKey: 'Isparta', lonKey: 'Isparta' },
            { dbKey: 'Mersin_Merkez', displayName: 'Mersin', latKey: 'Mersin', lonKey: 'Mersin' },
            { dbKey: 'İstanbul_Merkez', displayName: 'İstanbul', latKey: 'İstanbul', lonKey: 'İstanbul' },
            { dbKey: 'İzmir_Merkez', displayName: 'İzmir', latKey: 'İzmir', lonKey: 'İzmir' },
            { dbKey: 'Kars_Merkez', displayName: 'Kars', latKey: 'Kars', lonKey: 'Kars' },
            { dbKey: 'Kastamonu_Merkez', displayName: 'Kastamonu', latKey: 'Kastamonu', lonKey: 'Kastamonu' },
            { dbKey: 'Kayseri_Merkez', displayName: 'Kayseri', latKey: 'Kayseri', lonKey: 'Kayseri' },
            { dbKey: 'Kırklareli_Merkez', displayName: 'Kırklareli', latKey: 'Kırklareli', lonKey: 'Kırklareli' },
            { dbKey: 'Kırşehir_Merkez', displayName: 'Kırşehir', latKey: 'Kırşehir', lonKey: 'Kırşehir' },
            { dbKey: 'Kocaeli_Merkez', displayName: 'Kocaeli', latKey: 'Kocaeli', lonKey: 'Kocaeli' },
            { dbKey: 'Konya_Merkez', displayName: 'Konya', latKey: 'Konya', lonKey: 'Konya' },
            { dbKey: 'Kütahya_Merkez', displayName: 'Kütahya', latKey: 'Kütahya', lonKey: 'Kütahya' },
            { dbKey: 'Kütahya_Domaniç', displayName: 'Kütahya / Domaniç', lat: 39.8119, lon: 29.6078 }, // Specific district
            { dbKey: 'Malatya_Merkez', displayName: 'Malatya', latKey: 'Malatya', lonKey: 'Malatya' },
            { dbKey: 'Manisa_Merkez', displayName: 'Manisa', latKey: 'Manisa', lonKey: 'Manisa' },
            { dbKey: 'Kahramanmaraş_Merkez', displayName: 'Kahramanmaraş', latKey: 'Kahramanmaraş', lonKey: 'Kahramanmaraş' },
            { dbKey: 'Mardin_Merkez', displayName: 'Mardin', latKey: 'Mardin', lonKey: 'Mardin' },
            { dbKey: 'Muğla_Merkez', displayName: 'Muğla', latKey: 'Muğla', lonKey: 'Muğla' },
            { dbKey: 'Muş_Merkez', displayName: 'Muş', latKey: 'Muş', lonKey: 'Muş' },
            { dbKey: 'Nevşehir_Merkez', displayName: 'Nevşehir', latKey: 'Nevşehir', lonKey: 'Nevşehir' },
            { dbKey: 'Niğde_Merkez', displayName: 'Niğde', latKey: 'Niğde', lonKey: 'Niğde' },
            { dbKey: 'Ordu_Merkez', displayName: 'Ordu', latKey: 'Ordu', lonKey: 'Ordu' },
            { dbKey: 'Rize_Merkez', displayName: 'Rize', latKey: 'Rize', lonKey: 'Rize' },
            { dbKey: 'Sakarya_Merkez', displayName: 'Sakarya', latKey: 'Sakarya', lonKey: 'Sakarya' },
            { dbKey: 'Samsun_Merkez', displayName: 'Samsun', latKey: 'Samsun', lonKey: 'Samsun' },
            { dbKey: 'Siirt_Merkez', displayName: 'Siirt', latKey: 'Siirt', lonKey: 'Siirt' },
            { dbKey: 'Sinop_Merkez', displayName: 'Sinop', latKey: 'Sinop', lonKey: 'Sinop' },
            { dbKey: 'Sivas_Merkez', displayName: 'Sivas', latKey: 'Sivas', lonKey: 'Sivas' },
            { dbKey: 'Tekirdağ_Merkez', displayName: 'Tekirdağ', latKey: 'Tekirdağ', lonKey: 'Tekirdağ' },
            { dbKey: 'Tokat_Merkez', displayName: 'Tokat', latKey: 'Tokat', lonKey: 'Tokat' },
            { dbKey: 'Trabzon_Merkez', displayName: 'Trabzon', latKey: 'Trabzon', lonKey: 'Trabzon' },
            { dbKey: 'Tunceli_Merkez', displayName: 'Tunceli', latKey: 'Tunceli', lonKey: 'Tunceli' },
            { dbKey: 'Şanlıurfa_Merkez', displayName: 'Şanlıurfa', latKey: 'Şanlıurfa', lonKey: 'Şanlıurfa' },
            { dbKey: 'Uşak_Merkez', displayName: 'Uşak', latKey: 'Uşak', lonKey: 'Uşak' },
            { dbKey: 'Van_Merkez', displayName: 'Van', latKey: 'Van', lonKey: 'Van' },
            { dbKey: 'Yozgat_Merkez', displayName: 'Yozgat', latKey: 'Yozgat', lonKey: 'Yozgat' },
            { dbKey: 'Zonguldak_Merkez', displayName: 'Zonguldak', latKey: 'Zonguldak', lonKey: 'Zonguldak' },
            { dbKey: 'Aksaray_Merkez', displayName: 'Aksaray', latKey: 'Aksaray', lonKey: 'Aksaray' },
            { dbKey: 'Bayburt_Merkez', displayName: 'Bayburt', latKey: 'Bayburt', lonKey: 'Bayburt' },
            { dbKey: 'Karaman_Merkez', displayName: 'Karaman', latKey: 'Karaman', lonKey: 'Karaman' },
            { dbKey: 'Kırıkkale_Merkez', displayName: 'Kırıkkale', latKey: 'Kırıkkale', lonKey: 'Kırıkkale' },
            { dbKey: 'Batman_Merkez', displayName: 'Batman', latKey: 'Batman', lonKey: 'Batman' },
            { dbKey: 'Şırnak_Merkez', displayName: 'Şırnak', latKey: 'Şırnak', lonKey: 'Şırnak' },
            { dbKey: 'Bartın_Merkez', displayName: 'Bartın', latKey: 'Bartın', lonKey: 'Bartın' },
            { dbKey: 'Ardahan_Merkez', displayName: 'Ardahan', latKey: 'Ardahan', lonKey: 'Ardahan' },
            { dbKey: 'Iğdır_Merkez', displayName: 'Iğdır', latKey: 'Iğdır', lonKey: 'Iğdır' },
            { dbKey: 'Yalova_Merkez', displayName: 'Yalova', latKey: 'Yalova', lonKey: 'Yalova' },
            { dbKey: 'Karabük_Merkez', displayName: 'Karabük', latKey: 'Karabük', lonKey: 'Karabük' },
            { dbKey: 'Kilis_Merkez', displayName: 'Kilis', latKey: 'Kilis', lonKey: 'Kilis' },
            { dbKey: 'Osmaniye_Merkez', displayName: 'Osmaniye', latKey: 'Osmaniye', lonKey: 'Osmaniye' },
            { dbKey: 'Düzce_Merkez', displayName: 'Düzce', latKey: 'Düzce', lonKey: 'Düzce' }
        ];
        
        // This is the province data from your HTML, used for coordinates of "Merkez" districts
        const turkishProvinces = [
            { name: 'Adana', region: 'Akdeniz', plateCode: '01', population: '2.258.718', lat: 37.0, lon: 35.3213 },
            { name: 'Adıyaman', region: 'Güneydoğu Anadolu', plateCode: '02', population: '635.169', lat: 37.7648, lon: 38.2786 },
            { name: 'Afyonkarahisar', region: 'Ege', plateCode: '03', population: '747.555', lat: 38.7507, lon: 30.5567 },
            { name: 'Ağrı', region: 'Doğu Anadolu', plateCode: '04', population: '535.435', lat: 39.7191, lon: 43.0503 },
            { name: 'Amasya', region: 'Karadeniz', plateCode: '05', population: '335.789', lat: 40.6499, lon: 35.8353 },
            { name: 'Ankara', region: 'İç Anadolu', plateCode: '06', population: '5.747.325', lat: 39.9334, lon: 32.8597 },
            { name: 'Antalya', region: 'Akdeniz', plateCode: '07', population: '2.619.832', lat: 36.8969, lon: 30.7133 },
            { name: 'Artvin', region: 'Karadeniz', plateCode: '08', population: '174.010', lat: 41.1828, lon: 41.8183 },
            { name: 'Aydın', region: 'Ege', plateCode: '09', population: '1.148.241', lat: 37.8560, lon: 27.8416 },
            { name: 'Balıkesir', region: 'Marmara', plateCode: '10', population: '1.257.590', lat: 39.6484, lon: 27.8826 },
            { name: 'Bilecik', region: 'Marmara', plateCode: '11', population: '228.673', lat: 40.1553, lon: 29.9833 },
            { name: 'Bingöl', region: 'Doğu Anadolu', plateCode: '12', population: '281.205', lat: 38.8849, lon: 40.4967 },
            { name: 'Bitlis', region: 'Doğu Anadolu', plateCode: '13', population: '349.396', lat: 38.4000, lon: 42.1000 }, // Example coordinates
            { name: 'Bolu', region: 'Karadeniz', plateCode: '14', population: '320.824', lat: 40.5760, lon: 31.5788 },
            { name: 'Burdur', region: 'Akdeniz', plateCode: '15', population: '270.283', lat: 37.7200, lon: 30.2900 },
            { name: 'Bursa', region: 'Marmara', plateCode: '16', population: '3.139.744', lat: 40.1826, lon: 29.0665 },
            { name: 'Çanakkale', region: 'Marmara', plateCode: '17', population: '542.157', lat: 40.1553, lon: 26.4142 },
            { name: 'Çankırı', region: 'İç Anadolu', plateCode: '18', population: '195.789', lat: 40.6013, lon: 33.6134 },
            { name: 'Çorum', region: 'Karadeniz', plateCode: '19', population: '535.405', lat: 40.5506, lon: 34.9556 },
            { name: 'Denizli', region: 'Ege', plateCode: '20', population: '1.040.915', lat: 37.7765, lon: 29.0864 },
            { name: 'Diyarbakır', region: 'Güneydoğu Anadolu', plateCode: '21', population: '1.783.431', lat: 37.9144, lon: 40.2306 },
            { name: 'Edirne', region: 'Marmara', plateCode: '22', population: '407.763', lat: 41.6818, lon: 26.5623 },
            { name: 'Elazığ', region: 'Doğu Anadolu', plateCode: '23', population: '591.098', lat: 38.6810, lon: 39.2264 },
            { name: 'Erzincan', region: 'Doğu Anadolu', plateCode: '24', population: '236.034', lat: 39.7500, lon: 39.5000 },
            { name: 'Erzurum', region: 'Doğu Anadolu', plateCode: '25', population: '758.279', lat: 39.9000, lon: 41.2700 },
            { name: 'Eskişehir', region: 'İç Anadolu', plateCode: '26', population: '898.369', lat: 39.7667, lon: 30.5256 },
            { name: 'Gaziantep', region: 'Güneydoğu Anadolu', plateCode: '27', population: '2.154.051', lat: 37.0662, lon: 37.3833 },
            { name: 'Giresun', region: 'Karadeniz', plateCode: '28', population: '453.912', lat: 40.9128, lon: 38.3895 },
            { name: 'Gümüşhane', region: 'Karadeniz', plateCode: '29', population: '137.354', lat: 40.4604, lon: 39.5084 },
            { name: 'Hakkâri', region: 'Doğu Anadolu', plateCode: '30', population: '287.625', lat: 37.5833, lon: 43.7333 },
            { name: 'Hatay', region: 'Akdeniz', plateCode: '31', population: '1.686.043', lat: 36.4018, lon: 36.3498 },
            { name: 'Isparta', region: 'Akdeniz', plateCode: '32', population: '441.412', lat: 37.7648, lon: 30.5566 },
            { name: 'Mersin', region: 'Akdeniz', plateCode: '33', population: '1.916.432', lat: 36.8000, lon: 34.6333 },
            { name: 'İstanbul', region: 'Marmara', plateCode: '34', population: '15.840.900', lat: 41.0082, lon: 28.9784 },
            { name: 'İzmir', region: 'Ege', plateCode: '35', population: '4.462.056', lat: 38.4192, lon: 27.1287 },
            { name: 'Kars', region: 'Doğu Anadolu', plateCode: '36', population: '285.410', lat: 40.6167, lon: 43.1000 },
            { name: 'Kastamonu', region: 'Karadeniz', plateCode: '37', population: '383.373', lat: 41.3887, lon: 33.7827 },
            { name: 'Kayseri', region: 'İç Anadolu', plateCode: '38', population: '1.421.362', lat: 38.7312, lon: 35.4787 },
            { name: 'Kırklareli', region: 'Marmara', plateCode: '39', population: '361.836', lat: 41.7333, lon: 27.2167 },
            { name: 'Kırşehir', region: 'İç Anadolu', plateCode: '40', population: '242.938', lat: 39.1425, lon: 34.1709 },
            { name: 'Kocaeli', region: 'Marmara', plateCode: '41', population: '2.033.441', lat: 40.8533, lon: 29.8815 },
            { name: 'Konya', region: 'İç Anadolu', plateCode: '42', population: '2.277.017', lat: 37.8667, lon: 32.4833 },
            { name: 'Kütahya', region: 'Ege', plateCode: '43', population: '579.257', lat: 39.4167, lon: 29.9833 },
            { name: 'Malatya', region: 'Doğu Anadolu', plateCode: '44', population: '812.580', lat: 38.3552, lon: 38.3095 },
            { name: 'Manisa', region: 'Ege', plateCode: '45', population: '1.468.279', lat: 38.6191, lon: 27.4289 },
            { name: 'Kahramanmaraş', region: 'Akdeniz', plateCode: '46', population: '1.177.436', lat: 37.5858, lon: 36.9371 },
            { name: 'Mardin', region: 'Güneydoğu Anadolu', plateCode: '47', population: '854.716', lat: 37.3212, lon: 40.7245 },
            { name: 'Muğla', region: 'Ege', plateCode: '48', population: '1.000.773', lat: 37.2153, lon: 28.3636 },
            { name: 'Muş', region: 'Doğu Anadolu', plateCode: '49', population: '408.809', lat: 38.9462, lon: 41.7539 },
            { name: 'Nevşehir', region: 'İç Anadolu', plateCode: '50', population: '302.887', lat: 38.6939, lon: 34.6857 },
            { name: 'Niğde', region: 'İç Anadolu', plateCode: '51', population: '364.707', lat: 37.9667, lon: 34.6833 },
            { name: 'Ordu', region: 'Karadeniz', plateCode: '52', population: '771.932', lat: 40.9839, lon: 37.8764 },
            { name: 'Rize', region: 'Karadeniz', plateCode: '53', population: '348.608', lat: 41.0201, lon: 40.5234 },
            { name: 'Sakarya', region: 'Marmara', plateCode: '54', population: '1.042.649', lat: 40.6940, lon: 30.4358 },
            { name: 'Samsun', region: 'Karadeniz', plateCode: '55', population: '1.348.542', lat: 41.2928, lon: 36.3313 },
            { name: 'Siirt', region: 'Güneydoğu Anadolu', plateCode: '56', population: '331.670', lat: 37.9333, lon: 41.9500 },
            { name: 'Sinop', region: 'Karadeniz', plateCode: '57', population: '216.548', lat: 42.0231, lon: 35.1531 },
            { name: 'Sivas', region: 'İç Anadolu', plateCode: '58', population: '646.608', lat: 39.7477, lon: 37.0179 },
            { name: 'Tekirdağ', region: 'Marmara', plateCode: '59', population: '1.081.065', lat: 40.9833, lon: 27.5167 },
            { name: 'Tokat', region: 'Karadeniz', plateCode: '60', population: '596.454', lat: 40.3167, lon: 36.5500 },
            { name: 'Trabzon', region: 'Karadeniz', plateCode: '61', population: '813.903', lat: 41.0015, lon: 39.7178 },
            { name: 'Tunceli', region: 'Doğu Anadolu', plateCode: '62', population: '84.022', lat: 39.3074, lon: 39.4388 },
            { name: 'Şanlıurfa', region: 'Güneydoğu Anadolu', plateCode: '63', population: '2.115.256', lat: 37.1591, lon: 38.7969 },
            { name: 'Uşak', region: 'Ege', plateCode: '64', population: '371.006', lat: 38.6823, lon: 29.4082 },
            { name: 'Van', region: 'Doğu Anadolu', plateCode: '65', population: '1.149.342', lat: 38.4891, lon: 43.4089 },
            { name: 'Yozgat', region: 'İç Anadolu', plateCode: '66', population: '419.440', lat: 39.8181, lon: 34.8147 },
            { name: 'Zonguldak', region: 'Karadeniz', plateCode: '67', population: '588.510', lat: 41.4564, lon: 31.7987 },
            { name: 'Aksaray', region: 'İç Anadolu', plateCode: '68', population: '429.069', lat: 38.3687, lon: 34.0370 },
            { name: 'Bayburt', region: 'Karadeniz', plateCode: '69', population: '84.843', lat: 40.2552, lon: 40.2249 },
            { name: 'Karaman', region: 'İç Anadolu', plateCode: '70', population: '254.913', lat: 37.1759, lon: 33.2287 },
            { name: 'Kırıkkale', region: 'İç Anadolu', plateCode: '71', population: '280.234', lat: 39.8468, lon: 33.5153 },
            { name: 'Batman', region: 'Güneydoğu Anadolu', plateCode: '72', population: '634.169', lat: 37.8812, lon: 41.1351 },
            { name: 'Şırnak', region: 'Güneydoğu Anadolu', plateCode: '73', population: '546.113', lat: 37.4187, lon: 42.4918 },
            { name: 'Bartın', region: 'Karadeniz', plateCode: '74', population: '198.979', lat: 41.5811, lon: 32.4610 },
            { name: 'Ardahan', region: 'Doğu Anadolu', plateCode: '75', population: '96.326', lat: 41.1105, lon: 42.7022 },
            { name: 'Iğdır', region: 'Doğu Anadolu', plateCode: '76', population: '201.314', lat: 39.8880, lon: 44.0048 },
            { name: 'Yalova', region: 'Marmara', plateCode: '77', population: '283.751', lat: 40.6500, lon: 29.2667 },
            { name: 'Karabük', region: 'Karadeniz', plateCode: '78', population: '248.014', lat: 41.2061, lon: 32.6204 },
            { name: 'Kilis', region: 'Güneydoğu Anadolu', plateCode: '79', population: '142.490', lat: 36.7184, lon: 37.1212 },
            { name: 'Osmaniye', region: 'Akdeniz', plateCode: '80', population: '558.556', lat: 37.2130, lon: 36.1763 },
            { name: 'Düzce', region: 'Karadeniz', plateCode: '81', population: '405.614', lat: 40.8438, lon: 31.1565 }
        ];


        const weatherConditions = {
            'clearsky_day': { icon: '☀️', description: 'Açık' },
            'clearsky_night': { icon: '🌙', description: 'Açık (Gece)' },
            'fair_day': { icon: '🌤️', description: 'Az Bulutlu' },
            'fair_night': { icon: '☁️', description: 'Az Bulutlu (Gece)' },
            'partlycloudy_day': { icon: '⛅', description: 'Parçalı Bulutlu' },
            'partlycloudy_night': { icon: '☁️', description: 'Parçalı Bulutlu (Gece)' },
            'cloudy': { icon: '☁️', description: 'Çok Bulutlu' },
            'rain': { icon: '🌧️', description: 'Yağmurlu' },
            'lightrain': { icon: '🌦️', description: 'Hafif Yağmurlu' },
            'heavyrain': { icon: '🌧️', description: 'Şiddetli Yağmur' },
            'rainshowers_day': { icon: '🌦️', description: 'Sağanak Yağışlı' },
            'rainshowers_night': { icon: '🌧️', description: 'Sağanak Yağışlı (Gece)' },
            'lightrainshowers_day': { icon: '🌦️', description: 'Hafif Sağanak Yağışlı' },
            'lightrainshowers_night': { icon: '🌧️', description: 'Hafif Sağanak Yağışlı (Gece)' },
            'heavyrainshowers_day': { icon: '🌧️', description: 'Şiddetli Sağanak Yağışlı' },
            'heavyrainshowers_night': { icon: '🌧️', description: 'Şiddetli Sağanak Yağışlı (Gece)' },
            'rainshowersandthunder_day': { icon: '⛈️', description: 'Gök Gürültülü Sağanak Yağışlı' },
            'rainshowersandthunder_night': { icon: '⛈️', description: 'Gök Gürültülü Sağanak Yağışlı (Gece)' },
            'heavyrainandthunder': { icon: '⛈️', description: 'Şiddetli Gök Gürültülü Yağmur' },
            'sleet': { icon: '🌨️', description: 'Sulu Sepken' },
            'lightsleet': { icon: '🌨️', description: 'Hafif Sulu Sepken' },
            'heavysleet': { icon: '🌨️', description: 'Yoğun Sulu Sepken' },
            'sleetshowers_day': { icon: '🌨️', description: 'Sulu Sepken Sağanağı' },
            'sleetshowers_night': { icon: '🌨️', description: 'Sulu Sepken Sağanağı (Gece)' },
            'lightsleetshowers_day': {icon: '🌨️', description: 'Hafif Sulu Sepken Sağanağı'},
            'lightsleetshowers_night': {icon: '🌨️', description: 'Hafif Sulu Sepken Sağanağı (Gece)'},
            'heavysleetshowers_day': {icon: '🌨️', description: 'Yoğun Sulu Sepken Sağanağı'},
            'heavysleetshowers_night': {icon: '🌨️', description: 'Yoğun Sulu Sepken Sağanağı (Gece)'},
            'snow': { icon: '❄️', description: 'Karlı' },
            'lightsnow': { icon: '❄️', description: 'Hafif Kar Yağışlı' },
            'heavysnow': { icon: '❄️', description: 'Yoğun Kar Yağışlı' },
            'snowshowers_day': { icon: '🌨️', description: 'Kar Sağanağı' },
            'snowshowers_night': { icon: '🌨️', description: 'Kar Sağanağı (Gece)' },
            'lightsnowshowers_day': {icon: '🌨️', description: 'Hafif Kar Sağanağı'},
            'lightsnowshowers_night': {icon: '🌨️', description: 'Hafif Kar Sağanağı (Gece)'},
            'heavysnowshowers_day': {icon: '❄️', description: 'Yoğun Kar Sağanağı'},
            'heavysnowshowers_night': {icon: '❄️', description: 'Yoğun Kar Sağanağı (Gece)'},
            'snowandthunder': { icon: '🌨️⛈️', description: 'Gök Gürültülü Karlı' }, // Need combined icon or better single
            'fog': { icon: '🌫️', description: 'Sisli' },
            // Default
            'default': { icon: '❓', description: 'Bilinmiyor' }
        };

        let db;
        let currentSelectedLocationKey = 'Ankara_Merkez'; 
        let currentSelectedDisplayName = 'Ankara';
        let currentWeatherData = null;
        let tempAnimationInterval = null;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            initDB().then(() => {
                populateProvinceSelector();
                initializeAppUI();
                checkAndPerformBulkUpdate();
                loadAndDisplayWeather(currentSelectedLocationKey, currentSelectedDisplayName, true); // Load default on init
            }).catch(error => {
                console.error("DB Initialization failed:", error);
                showErrorMessage("Çevrimdışı veritabanı başlatılamadı. Uygulama düzgün çalışmayabilir.");
            });
            updateCurrentDateTime();
            setInterval(updateCurrentDateTime, 60000); // Update time every minute
        });

        function initializeAppUI() {
            const defaultProvince = locationsToFetchForBulkUpdate.find(loc => loc.dbKey === currentSelectedLocationKey);
            if (defaultProvince) {
                document.getElementById('provinceSelector').value = defaultProvince.dbKey;
            }
            updateLastBulkUpdateTimeDisplay();
        }


        // --- INDEXEDDB FUNCTIONS ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.error);
                    reject("IndexedDB açılamadı.");
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("IndexedDB başarıyla açıldı.");
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    console.log("IndexedDB upgrade needed.");
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'dbKey' });
                        console.log(`Object store '${STORE_NAME}' oluşturuldu.`);
                    }
                };
            });
        }

        function saveData(dbKey, displayName, dataToSave) {
            if (!db) { console.error("DB not initialized for saveData"); return Promise.reject("DB not initialized"); }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ dbKey: dbKey, displayName: displayName, data: dataToSave, lastUpdated: Date.now() });
                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error(`Veri kaydedilirken hata (${dbKey}):`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        function getData(dbKey) {
            if (!db) { console.error("DB not initialized for getData"); return Promise.reject("DB not initialized"); }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(dbKey);
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => {
                    console.error(`Veri okunurken hata (${dbKey}):`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // --- DATA FETCHING & MANAGEMENT ---
        async function fetchWeatherData(lat, lon) {
            console.log(`Fetching data for lat: ${lat}, lon: ${lon}`);
            if (lat == 0 && lon == 0) {
                console.warn(`Invalid coordinates (0,0) for API request. Skipping.`);
                return Promise.reject("Invalid coordinates");
            }
            const apiUrl = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`;
            try {
                const response = await fetch(apiUrl, {
                    headers: { 'User-Agent': MET_NORWAY_API_USER_AGENT }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API Error ${response.status} for ${lat},${lon}: ${errorText}`);
                    throw new Error(`API Hatası: ${response.status}`);
                }
                const data = await response.json();
                if (!data.properties || !data.properties.timeseries || data.properties.timeseries.length === 0) {
                    console.warn("API'den beklenen formatta veri gelmedi veya zaman serisi boş:", data);
                    throw new Error("API'den eksik veya hatalı veri geldi.");
                }
                console.log(`Data fetched successfully for ${lat},${lon}`);
                return data;
            } catch (error) {
                console.error(`fetchWeatherData error for ${lat},${lon}:`, error);
                throw error;
            }
        }

        async function loadAndDisplayWeather(dbKey, displayName, forceUpdate = false) {
            currentSelectedLocationKey = dbKey;
            currentSelectedDisplayName = displayName;
            document.getElementById('currentCity').textContent = displayName;
            showLoading(displayName);
            
            try {
                const storedData = await getData(dbKey);
                if (storedData && !forceUpdate && (Date.now() - storedData.lastUpdated < SINGLE_LOCATION_UPDATE_INTERVAL_MS)) {
                    console.log(`'${displayName}' için güncel yerel veri kullanılıyor.`);
                    currentWeatherData = storedData.data;
                    updateWeatherUI(displayName, currentWeatherData, storedData.lastUpdated);
                } else {
                    console.log(`'${displayName}' için API'den yeni veri çekiliyor. Force: ${forceUpdate}, Stored: ${storedData ? new Date(storedData.lastUpdated).toLocaleString() : 'Yok'}`);
                    const locationConfig = getLocationConfig(dbKey);
                    if (!locationConfig) {
                        throw new Error(`'${dbKey}' için konum konfigürasyonu bulunamadı.`);
                    }
                    currentWeatherData = await fetchWeatherData(locationConfig.lat, locationConfig.lon);
                    await saveData(dbKey, displayName, currentWeatherData);
                    updateWeatherUI(displayName, currentWeatherData, Date.now());
                }
            } catch (error) {
                console.error(`'${displayName}' için hava durumu yüklenirken hata:`, error);
                showErrorMessage(`'${displayName}' için hava durumu verileri yüklenemedi. Lütfen internet bağlantınızı kontrol edin veya daha sonra tekrar deneyin.`);
                // Try to load old data if available, even if update failed
                const storedData = await getData(dbKey);
                if (storedData) {
                    console.warn(`'${displayName}' için eski veri gösteriliyor (güncelleme başarısız).`);
                    currentWeatherData = storedData.data;
                    updateWeatherUI(displayName, currentWeatherData, storedData.lastUpdated, true); // Indicate it's stale
                }
            } finally {
                hideLoading();
            }
        }
        
        function getLocationConfig(dbKeyToFind) {
            const provinceDataMap = {};
            turkishProvinces.forEach(p => {
                provinceDataMap[p.name] = { lat: p.lat, lon: p.lon };
            });

            const location = locationsToFetchForBulkUpdate.find(loc => loc.dbKey === dbKeyToFind);
            if (location) {
                if (location.latKey && location.lonKey) { // It's a "Merkez" type
                    const coords = provinceDataMap[location.latKey];
                    if (coords) {
                        return { ...location, lat: coords.lat, lon: coords.lon };
                    } else {
                        console.error(`Koordinatlar bulunamadı: ${location.latKey}`);
                        return { ...location, lat: 0, lon: 0 }; // Fallback, API will likely fail
                    }
                } else { // It's a specific district with its own lat/lon
                    return location;
                }
            }
            console.error(`Konum konfigürasyonu bulunamadı: ${dbKeyToFind}`);
            return null;
        }


        async function checkAndPerformBulkUpdate() {
            const lastBulkUpdateTime = localStorage.getItem('lastBulkUpdateTime_v3');
            if (!lastBulkUpdateTime || (Date.now() - parseInt(lastBulkUpdateTime) > BULK_UPDATE_INTERVAL_MS)) {
                console.log("Toplu güncelleme zamanı geldi veya ilk çalıştırma.");
                manualBulkUpdate(); // Call manualBulkUpdate which handles UI
            } else {
                console.log("Son toplu güncelleme hala geçerli. Atlanıyor.");
                updateLastBulkUpdateTimeDisplay();
            }
        }

        async function manualBulkUpdate() {
            showLoading(null, true); // Show bulk update loading
            const progressBar = document.getElementById('loadingProgressBar');
            const currentUpdateStatusEl = document.getElementById('currentUpdateStatus');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            currentUpdateStatusEl.textContent = '';

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < locationsToFetchForBulkUpdate.length; i++) {
                const location = locationsToFetchForBulkUpdate[i];
                const locationConfig = getLocationConfig(location.dbKey);

                if (!locationConfig || (locationConfig.lat === 0 && locationConfig.lon === 0)) {
                     console.warn(`Geçersiz koordinatlar veya bulunamayan yapılandırma: ${location.displayName}. Atlanıyor.`);
                     errorCount++;
                } else {
                    currentUpdateStatusEl.textContent = `'${location.displayName}' için veri çekiliyor... (${i + 1}/${locationsToFetchForBulkUpdate.length})`;
                    try {
                        const weatherData = await fetchWeatherData(locationConfig.lat, locationConfig.lon);
                        await saveData(location.dbKey, location.displayName, weatherData);
                        successCount++;
                        console.log(`'${location.displayName}' için veri başarıyla güncellendi ve kaydedildi.`);
                    } catch (error) {
                        errorCount++;
                        console.error(`'${location.displayName}' için toplu güncelleme sırasında hata:`, error);
                    }
                }
                
                const progress = Math.round(((i + 1) / locationsToFetchForBulkUpdate.length) * 100);
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;

                if (i < locationsToFetchForBulkUpdate.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, BULK_REQUEST_DELAY));
                }
            }
            
            localStorage.setItem('lastBulkUpdateTime_v3', Date.now().toString());
            updateLastBulkUpdateTimeDisplay();
            hideLoading();
            alert(`Toplu güncelleme tamamlandı.\nBaşarılı: ${successCount}\nHatalı: ${errorCount}`);
            // Reload current view if it was part of the bulk update
            if (locationsToFetchForBulkUpdate.some(loc => loc.dbKey === currentSelectedLocationKey)) {
                loadAndDisplayWeather(currentSelectedLocationKey, currentSelectedDisplayName, true);
            }
        }


        // --- UI UPDATE FUNCTIONS ---
        function updateWeatherUI(displayName, weatherData, lastUpdatedTimestamp, isStale = false) {
            if (!weatherData || !weatherData.properties || !weatherData.properties.timeseries || weatherData.properties.timeseries.length === 0) {
                console.warn("updateWeatherUI: Geçersiz veya eksik hava durumu verisi.", weatherData);
                showErrorMessage(`'${displayName}' için hava durumu verileri alınamadı veya eksik.`);
                return;
            }
            const timeseries = weatherData.properties.timeseries;
            const now = new Date();
            
            // Find the closest timeseries entry to the current time
            let currentForecastEntry = timeseries[0];
            for (let i = 0; i < timeseries.length; i++) {
                const entryTime = new Date(timeseries[i].time);
                if (entryTime <= now) {
                    currentForecastEntry = timeseries[i];
                } else {
                    // If the first entry is in the future, use it. Otherwise, we found the closest past/current.
                    if (i === 0) currentForecastEntry = timeseries[i];
                    break; 
                }
            }
            
            const currentData = currentForecastEntry.data.instant.details;
            const next1HourSummary = currentForecastEntry.data.next_1_hours?.summary;
            const next6HoursSummary = currentForecastEntry.data.next_6_hours?.summary;
            const next12HoursSummary = currentForecastEntry.data.next_12_hours?.summary;

            // Determine symbol code: prefer 1h, then 6h, then 12h
            let symbolCode = 'clearsky_day'; // Default
            if (next1HourSummary?.symbol_code) {
                symbolCode = next1HourSummary.symbol_code;
            } else if (next6HoursSummary?.symbol_code) {
                symbolCode = next6HoursSummary.symbol_code;
            } else if (next12HoursSummary?.symbol_code) {
                symbolCode = next12HoursSummary.symbol_code;
            }
            
            const isDayTime = new Date(currentForecastEntry.time).getHours() >= 6 && new Date(currentForecastEntry.time).getHours() < 19;
            const conditionKey = symbolCode.includes('_night') || symbolCode.includes('_day') ? symbolCode : (isDayTime ? `${symbolCode}_day` : `${symbolCode}_night`);
            const condition = weatherConditions[conditionKey] || weatherConditions[symbolCode] || weatherConditions['default'];

            document.getElementById('currentCity').textContent = displayName;
            document.getElementById('currentIcon').textContent = condition.icon;
            document.getElementById('currentDescription').textContent = condition.description;
            
            const currentTemp = parseFloat(currentData.air_temperature);
            document.getElementById('currentTemp').textContent = `${Math.round(currentTemp)}°`;

            // Gradual temperature animation setup
            const currentHourIndex = timeseries.findIndex(ts => ts.time === currentForecastEntry.time);
            let nextHourTemp = currentTemp; // Default to current if no next hour
            if (currentHourIndex < timeseries.length - 1) {
                const nextHourData = timeseries[currentHourIndex + 1].data.instant.details;
                nextHourTemp = parseFloat(nextHourData.air_temperature);
            }
            animateTemperatureChange(currentTemp, nextHourTemp);


            document.getElementById('feelsLike').textContent = `${Math.round(currentData.air_temperature)}°`; // MET Norway compact doesn't have apparent_temperature directly
            document.getElementById('humidity').textContent = `${Math.round(currentData.relative_humidity ?? 0)}%`;
            document.getElementById('windSpeed').textContent = `${Math.round((currentData.wind_speed ?? 0) * 3.6)} km/h ${getWindDirectionArrow(currentData.wind_from_direction)}`;
            document.getElementById('pressure').textContent = `${Math.round(currentData.air_pressure_at_sea_level ?? 0)} hPa`;
            document.getElementById('visibility').textContent = 'N/A'; // MET Norway compact doesn't provide visibility
            document.getElementById('dewPoint').textContent = `${Math.round(currentData.dew_point_temperature ?? 0)}°`;
            document.getElementById('cloudCover').textContent = `${Math.round(currentData.cloud_area_fraction ?? 0)}%`;


            const lastUpdatedDate = new Date(lastUpdatedTimestamp);
            document.getElementById('dataLastUpdated').textContent = `Veri Son Güncelleme: ${lastUpdatedDate.toLocaleString('tr-TR')} ${isStale ? '(Eski Veri)' : ''}`;
            
            updateHourlyForecastUI(timeseries);
            updateDailyForecastUI(timeseries);
            updateDetailedInfoUI(currentData, currentForecastEntry.data); // Pass entire current entry data for more details
            updateCharts(timeseries);

            document.getElementById('weatherDisplay').classList.add('active');
            document.getElementById('loadingContainer').classList.remove('active');
             updateCurrentDateTime(); // Ensure current time display is also updated
        }
        
        let temperatureAnimationId = null;

        function animateTemperatureChange(startTemp, endTemp) {
            if (temperatureAnimationId) {
                clearInterval(temperatureAnimationId);
            }

            const tempElement = document.getElementById('currentTemp');
            let currentAnimatedTemp = startTemp;
            const difference = endTemp - startTemp;
            const steps = Math.abs(difference) / 0.1; // Number of 0.1 degree steps
            
            // If no significant difference, just set and return
            if (steps < 1) {
                tempElement.textContent = `${Math.round(endTemp)}°`;
                return;
            }

            const increment = difference / steps;
            // Animate over approx 5-10 seconds for smoothness, regardless of hour duration
            // Total duration for animation could be fixed, e.g., 10 seconds.
            // Interval duration should be total_duration / steps.
            // Let's aim for roughly 1 change per 200ms for a smoother look, up to 50 steps.
            const animationDuration = Math.min(steps * 200, 10000); // Max 10 seconds animation
            const intervalTime = animationDuration / steps;


            tempElement.textContent = `${currentAnimatedTemp.toFixed(1)}°`;

            let stepCount = 0;
            temperatureAnimationId = setInterval(() => {
                currentAnimatedTemp += increment;
                stepCount++;
                tempElement.textContent = `${currentAnimatedTemp.toFixed(1)}°`;
                
                if (stepCount >= steps) {
                    clearInterval(temperatureAnimationId);
                    tempElement.textContent = `${Math.round(endTemp)}°`; // Final rounded value
                }
            }, intervalTime);
        }


        function updateHourlyForecastUI(timeseries) {
            const container = document.getElementById('hourlyContainer');
            container.innerHTML = ''; // Clear previous items
            
            const now = new Date();
            let startIndex = timeseries.findIndex(item => new Date(item.time) >= now);
            if (startIndex === -1) startIndex = 0; // If all past, show from beginning

            const hourlyDataToShow = timeseries.slice(startIndex, startIndex + 24);

            hourlyDataToShow.forEach((item) => {
                const time = new Date(item.time);
                const details = item.data.instant.details;
                const next1HourSummary = item.data.next_1_hours?.summary;
                const precipitationAmount = item.data.next_1_hours?.details?.precipitation_amount ?? 0;

                let symbolCode = 'clearsky_day';
                 if (next1HourSummary?.symbol_code) {
                    symbolCode = next1HourSummary.symbol_code;
                } else if (item.data.next_6_hours?.summary?.symbol_code) {
                    symbolCode = item.data.next_6_hours.summary.symbol_code;
                }

                const isDayTime = time.getHours() >= 6 && time.getHours() < 19;
                const conditionKey = symbolCode.includes('_night') || symbolCode.includes('_day') ? symbolCode : (isDayTime ? `${symbolCode}_day` : `${symbolCode}_night`);
                const condition = weatherConditions[conditionKey] || weatherConditions[symbolCode] || weatherConditions['default'];
                
                const hourItem = document.createElement('div');
                hourItem.className = 'forecast-item';
                hourItem.innerHTML = `
                    <div class="forecast-day">${time.getHours().toString().padStart(2, '0')}:00</div>
                    <div class="forecast-icon">${condition.icon}</div>
                    <div class="forecast-temps">
                        <span class="forecast-high">${Math.round(details.air_temperature ?? 0)}°</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--medium-gray); margin-top: 0.5rem; min-height: 2.4em; line-height: 1.2em;">
                        ${condition.description}
                    </div>
                    ${precipitationAmount > 0 ? 
                        `<div style="font-size: 0.8rem; color: var(--primary-blue); margin-top: 0.3rem;">
                            <i class="fas fa-tint"></i> ${precipitationAmount.toFixed(1)} mm
                        </div>` : ''
                    }
                `;
                container.appendChild(hourItem);
            });
        }

        function updateDailyForecastUI(timeseries) {
            const container = document.getElementById('dailyContainer');
            container.innerHTML = '';
            const dailyAggregates = {};
            const daysOfWeek = ['Pazar', 'Pzt', 'Salı', 'Çrş', 'Prş', 'Cuma', 'Cmt'];

            timeseries.forEach(item => {
                const date = new Date(item.time);
                const dayKey = date.toISOString().split('T')[0];
                if (!dailyAggregates[dayKey]) {
                    dailyAggregates[dayKey] = {
                        temps: [],
                        precipitations: [],
                        symbols: [],
                        dateObj: date
                    };
                }
                dailyAggregates[dayKey].temps.push(item.data.instant.details.air_temperature);
                dailyAggregates[dayKey].precipitations.push(item.data.next_1_hours?.details?.precipitation_amount ?? 0);
                
                let symbolCode = 'clearsky_day';
                if (item.data.next_1_hours?.summary?.symbol_code) {
                    symbolCode = item.data.next_1_hours.summary.symbol_code;
                } else if (item.data.next_6_hours?.summary?.symbol_code) { // Check 6h if 1h is not available
                    symbolCode = item.data.next_6_hours.summary.symbol_code;
                } else if (item.data.next_12_hours?.summary?.symbol_code) { // Check 12h if 6h is not available
                    symbolCode = item.data.next_12_hours.summary.symbol_code;
                }
                dailyAggregates[dayKey].symbols.push(symbolCode);
            });

            const todayKey = new Date().toISOString().split('T')[0];
            let dayCount = 0;

            for (const dayKey in dailyAggregates) {
                if (dayCount >= 7) break; // Limit to 7 days if data is extensive (though MET.no is usually ~3 days)
                
                const dayData = dailyAggregates[dayKey];
                const dayDate = dayData.dateObj;
                const dayName = (dayKey === todayKey) ? "Bugün" : daysOfWeek[dayDate.getDay()];
                
                const highTemp = Math.round(Math.max(...dayData.temps.filter(t => t !== null && t !== undefined)));
                const lowTemp = Math.round(Math.min(...dayData.temps.filter(t => t !== null && t !== undefined)));
                const totalPrecipitation = dayData.precipitations.reduce((sum, p) => sum + p, 0);

                // Determine dominant symbol for the day (e.g., midday or most frequent)
                const middaySymbol = dayData.symbols[Math.floor(dayData.symbols.length / 2)] || 'clearsky_day';
                const isDayTime = true; // Assume day for daily forecast icon simplicity
                const conditionKey = middaySymbol.includes('_night') || middaySymbol.includes('_day') ? middaySymbol : (isDayTime ? `${middaySymbol}_day` : `${middaySymbol}_night`);
                const condition = weatherConditions[conditionKey] || weatherConditions[middaySymbol] || weatherConditions['default'];


                const dayItem = document.createElement('div');
                dayItem.className = 'forecast-item';
                dayItem.innerHTML = `
                    <div class="forecast-day">${dayName} <small>(${dayDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })})</small></div>
                    <div class="forecast-icon">${condition.icon}</div>
                    <div class="forecast-temps">
                        <span class="forecast-high">${highTemp}°</span>
                        <span class="forecast-low">${lowTemp}°</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--medium-gray); margin-top: 0.5rem; min-height: 2.4em; line-height: 1.2em;">
                        ${condition.description}
                    </div>
                    ${totalPrecipitation > 0 ? 
                        `<div style="font-size: 0.8rem; color: var(--primary-blue); margin-top: 0.3rem;">
                            <i class="fas fa-tint"></i> ${totalPrecipitation.toFixed(1)} mm
                        </div>` : ''
                    }
                `;
                container.appendChild(dayItem);
                dayCount++;
            }
            document.getElementById('dailyForecastTitle').textContent = `Günlük Tahmin (Yaklaşık ${dayCount} Gün)`;
        }

        function updateDetailedInfoUI(currentInstantDetails, currentFullDataEntry) {
            const container = document.getElementById('detailsContainer');
            const airTemperature = currentInstantDetails.air_temperature ?? 'N/A';
            const dewPoint = currentInstantDetails.dew_point_temperature ?? 'N/A';
            const windSpeed = (currentInstantDetails.wind_speed ?? 'N/A') !== 'N/A' ? Math.round(currentInstantDetails.wind_speed * 3.6) : 'N/A';
            const windDirection = currentInstantDetails.wind_from_direction ?? 'N/A';
            const relativeHumidity = currentInstantDetails.relative_humidity ?? 'N/A';
            const pressure = currentInstantDetails.air_pressure_at_sea_level ?? 'N/A';
            const cloudFraction = currentInstantDetails.cloud_area_fraction ?? 'N/A';
            const fogFraction = currentInstantDetails.fog_area_fraction ?? 'N/A';
            const solarIrradiance = currentFullDataEntry?.instant?.details?.ultraviolet_index_clear_sky ?? 'N/A'; // Using this as a proxy for solar irradiance, MET.no compact doesn't have direct solar_irradiance. UV is related.

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                    <div class="detail-card">
                        <h4><i class="fas fa-thermometer-half"></i> Sıcaklık Detayları</h4>
                        <p><strong>Mevcut:</strong> ${airTemperature}°C</p>
                        <p><strong>Hissedilen (Yaklaşık):</strong> ${airTemperature}°C</p>
                        <p><strong>Çiy Noktası:</strong> ${dewPoint}°C</p>
                    </div>
                    <div class="detail-card">
                        <h4><i class="fas fa-wind"></i> Rüzgar Bilgileri</h4>
                        <p><strong>Hız:</strong> ${windSpeed} km/h</p>
                        <p><strong>Yön:</strong> ${windDirection}° (${getWindDirectionArrow(windDirection)})</p>
                    </div>
                    <div class="detail-card">
                        <h4><i class="fas fa-tint"></i> Nem ve Basınç</h4>
                        <p><strong>Bağıl Nem:</strong> ${relativeHumidity}%</p>
                        <p><strong>Deniz Seviyesi Basıncı:</strong> ${pressure} hPa</p>
                    </div>
                    <div class="detail-card">
                        <h4><i class="fas fa-cloud"></i> Bulut & Sis Durumu</h4>
                        <p><strong>Bulut Örtüsü:</strong> ${cloudFraction}%</p>
                        <p><strong>Sis Örtüsü:</strong> ${fogFraction}%</p>
                    </div>
                     <div class="detail-card">
                        <h4><i class="fas fa-sun"></i> Güneş Işınımı (Yaklaşık)</h4>
                        <p><strong>UV İndeksi (Açık Hava):</strong> ${solarIrradiance}</p>
                        <small>(MET Norway verisi UV İndeksini içerir, bu yaklaşık bir göstergedir)</small>
                    </div>
                </div>
            `;
        }
        
        function updateCharts(timeseries) {
            const tempChartContainer = document.getElementById('chartsContainer');
            const precipChartContainer = document.getElementById('precipitationChartContainer');
            tempChartContainer.innerHTML = '<div class="chart-placeholder">Sıcaklık grafiği oluşturuluyor...</div>';
            precipChartContainer.innerHTML = '<div class="chart-placeholder">Yağış grafiği oluşturuluyor...</div>';

            const now = new Date();
            let startIndex = timeseries.findIndex(item => new Date(item.time) >= now);
            if (startIndex === -1) startIndex = 0;
            const chartData = timeseries.slice(startIndex, startIndex + 24).map(item => ({
                time: new Date(item.time).getHours() + ':00',
                temperature: item.data.instant.details.air_temperature,
                precipitation_probability: item.data.next_1_hours?.details?.precipitation_probability ?? // MET.no Compact doesn't have prob.
                                           (item.data.next_1_hours?.details?.precipitation_amount > 0 ? 50 : 0) // Basic assumption if precipitating
            }));

            if (chartData.length > 0) {
                tempChartContainer.innerHTML = ''; // Clear placeholder
                createBarChart(tempChartContainer, chartData, 'time', 'temperature', 'Sıcaklık (°C)', 'var(--primary-blue)');
                
                precipChartContainer.innerHTML = ''; // Clear placeholder
                createBarChart(precipChartContainer, chartData, 'time', 'precipitation_probability', 'Yağış İhtimali (%)', 'var(--secondary-blue)', 100);
            } else {
                tempChartContainer.innerHTML = '<div class="chart-placeholder">Sıcaklık grafiği için veri yok.</div>';
                precipChartContainer.innerHTML = '<div class="chart-placeholder">Yağış grafiği için veri yok.</div>';
            }
        }

        function createBarChart(container, data, xKey, yKey, yLabel, barColor, yMax = null) {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            const padding = { top: 20, right: 20, bottom: 30, left: 40 };
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight || 300;
            
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", `0 0 ${containerWidth} ${containerHeight}`);
            svg.style.display = "block"; // Ensure SVG takes block space

            const dataValues = data.map(d => d[yKey]).filter(v => v !== null && v !== undefined);
            if (dataValues.length === 0) {
                container.innerHTML = `<div class="chart-placeholder">${yLabel} için veri yok.</div>`;
                return;
            }

            const minYValue = Math.min(0, ...dataValues); // Ensure Y axis starts at 0 or below if negative temps
            const maxYValue = yMax !== null ? yMax : Math.max(...dataValues);
            
            const chartWidth = containerWidth - padding.left - padding.right;
            const chartHeight = containerHeight - padding.top - padding.bottom;
            
            const barWidth = chartWidth / data.length * 0.8;
            const spacing = chartWidth / data.length * 0.2;

            // Y axis
            const yAxis = document.createElementNS(svgNS, "line");
            yAxis.setAttribute("x1", padding.left);
            yAxis.setAttribute("y1", padding.top);
            yAxis.setAttribute("x2", padding.left);
            yAxis.setAttribute("y2", padding.top + chartHeight);
            yAxis.setAttribute("stroke", "var(--medium-gray)");
            svg.appendChild(yAxis);

            // X axis
            const xAxis = document.createElementNS(svgNS, "line");
            xAxis.setAttribute("x1", padding.left);
            xAxis.setAttribute("y1", padding.top + chartHeight);
            xAxis.setAttribute("x2", padding.left + chartWidth);
            xAxis.setAttribute("y2", padding.top + chartHeight);
            xAxis.setAttribute("stroke", "var(--medium-gray)");
            svg.appendChild(xAxis);

            // Y-axis labels (simple example, can be improved)
            for (let i = 0; i <= 4; i++) {
                const val = minYValue + (i/4) * (maxYValue - minYValue);
                const yPos = padding.top + chartHeight - ( (val - minYValue) / (maxYValue - minYValue) * chartHeight );
                
                const yLabelText = document.createElementNS(svgNS, "text");
                yLabelText.setAttribute("x", padding.left - 5);
                yLabelText.setAttribute("y", yPos + 4); // adjust for text alignment
                yLabelText.setAttribute("fill", "var(--medium-gray)");
                yLabelText.setAttribute("font-size", "10");
                yLabelText.setAttribute("text-anchor", "end");
                yLabelText.textContent = Math.round(val);
                svg.appendChild(yLabelText);
            }

            data.forEach((d, i) => {
                const x = padding.left + i * (barWidth + spacing) + spacing / 2;
                const value = d[yKey] ?? 0;
                const barHeight = Math.max(0, ( (value - minYValue) / (maxYValue - minYValue) ) * chartHeight);
                const y = padding.top + chartHeight - barHeight;

                const rect = document.createElementNS(svgNS, "rect");
                rect.setAttribute("x", x);
                rect.setAttribute("y", y);
                rect.setAttribute("width", barWidth);
                rect.setAttribute("height", barHeight);
                rect.setAttribute("fill", barColor);
                svg.appendChild(rect);

                // X-axis labels
                if (i % Math.max(1, Math.floor(data.length / 8)) === 0) { // Show fewer labels if many bars
                    const xLabelText = document.createElementNS(svgNS, "text");
                    xLabelText.setAttribute("x", x + barWidth / 2);
                    xLabelText.setAttribute("y", containerHeight - padding.bottom + 15);
                    xLabelText.setAttribute("fill", "var(--medium-gray)");
                    xLabelText.setAttribute("font-size", "10");
                    xLabelText.setAttribute("text-anchor", "middle");
                    xLabelText.textContent = d[xKey];
                    svg.appendChild(xLabelText);
                }
            });
            container.appendChild(svg);
        }



        // --- UI INTERACTION ---
        function populateProvinceSelector() {
            const selector = document.getElementById('provinceSelector');
            selector.innerHTML = '<option value="">İl Seçin...</option>'; // Clear and add placeholder
            
            const sortedLocations = [...locationsToFetchForBulkUpdate].sort((a, b) => a.displayName.localeCompare(b.displayName, 'tr'));

            sortedLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.dbKey;
                option.textContent = loc.displayName;
                selector.appendChild(option);
            });
        }

        function handleProvinceSelection(dbKey) {
            if (dbKey) {
                const location = locationsToFetchForBulkUpdate.find(loc => loc.dbKey === dbKey);
                if (location) {
                    loadAndDisplayWeather(location.dbKey, location.displayName);
                }
            }
        }
        
        function selectLocation(dbKey, displayName) { // Used by quick action buttons
            document.getElementById('provinceSelector').value = dbKey;
            loadAndDisplayWeather(dbKey, displayName);
        }


        function showLoading(locationName = null, isBulk = false) {
            const loadingContainer = document.getElementById('loadingContainer');
            const mainText = document.getElementById('loadingTextMain');
            const subText = document.getElementById('loadingTextSub');
            const progressBarContainer = document.querySelector('.progress-bar-container');
            const currentStatusEl = document.getElementById('currentUpdateStatus');


            if (isBulk) {
                mainText.textContent = "Tüm Konumlar İçin Veriler Güncelleniyor...";
                subText.textContent = "Bu işlem birkaç dakika sürebilir. Lütfen bekleyin.";
                progressBarContainer.style.display = 'block';
                currentStatusEl.style.display = 'block';
            } else {
                mainText.textContent = `'${locationName || currentSelectedDisplayName}' için hava durumu yükleniyor...`;
                subText.textContent = "Met Norway API'den gerçek zamanlı veriler çekiliyor.";
                progressBarContainer.style.display = 'none';
                currentStatusEl.style.display = 'none';
            }
            loadingContainer.classList.add('active');
            document.getElementById('weatherDisplay').classList.remove('active');
        }

        function hideLoading() {
            document.getElementById('loadingContainer').classList.remove('active');
        }

        function showErrorMessage(message) {
            const container = document.getElementById('loadingContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger-red); margin-bottom: 1rem;"></i>
                    <h3 style="color: var(--danger-red); margin-bottom: 1rem;">Hata</h3>
                    <p style="color: var(--medium-gray); margin-bottom: 2rem;">${message}</p>
                    <button onclick="loadAndDisplayWeather(currentSelectedLocationKey, currentSelectedDisplayName, true)" style="background: var(--primary-blue); color: white; border: none; padding: 0.8rem 2rem; border-radius: 8px; cursor: pointer;">
                        Tekrar Dene (${currentSelectedDisplayName})
                    </button>
                     <button onclick="manualBulkUpdate()" style="background: var(--secondary-blue); color: white; border: none; padding: 0.8rem 2rem; border-radius: 8px; cursor: pointer; margin-left:10px;">
                        Tüm Verileri Yenile
                    </button>
                </div>
            `;
            container.classList.add('active');
            document.getElementById('weatherDisplay').classList.remove('active');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.weather-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active'); // Use event.currentTarget
        }

        function toggleTheme() {
            const body = document.body;
            const themeText = document.getElementById('themeText');
            const currentTheme = body.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                body.removeAttribute('data-theme');
                themeText.textContent = 'Koyu Tema';
                localStorage.setItem('havadurumuxOfflineTheme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeText.textContent = 'Açık Tema';
                localStorage.setItem('havadurumuxOfflineTheme', 'dark');
            }
        }
        // Load saved theme
        const savedTheme = localStorage.getItem('havadurumuxOfflineTheme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeText').textContent = 'Açık Tema';
        }


        function getCurrentUserLocation() {
            if ("geolocation" in navigator) {
                showLoading("Konumunuz belirleniyor");
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        let closestLocation = null;
                        let minDistance = Infinity;
                        
                        locationsToFetchForBulkUpdate.forEach(locDef => {
                            const locConfig = getLocationConfig(locDef.dbKey);
                            if (locConfig && locConfig.lat !== 0 && locConfig.lon !== 0) {
                                const distance = getDistanceHaversine(lat, lon, locConfig.lat, locConfig.lon);
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    closestLocation = locConfig;
                                }
                            }
                        });
                        
                        if (closestLocation) {
                            document.getElementById('provinceSelector').value = closestLocation.dbKey;
                            loadAndDisplayWeather(closestLocation.dbKey, closestLocation.displayName, true);
                        } else {
                             showErrorMessage('Yakınınızda bilinen bir konum bulunamadı. Lütfen listeden seçin.');
                        }
                    },
                    function(error) {
                        hideLoading();
                        showErrorMessage('Konum bilgisine erişilemedi. Hata: ' + error.message + '. Lütfen manuel olarak il seçin.');
                    },
                    { timeout: 10000, maximumAge: 60000, enableHighAccuracy: false }
                );
            } else {
                showErrorMessage('Tarayıcınız konum özelliğini desteklemiyor.');
            }
        }

        function getDistanceHaversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function getWindDirectionArrow(degrees) {
            if (degrees === null || degrees === undefined || isNaN(degrees)) return '';
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round((degrees % 360) / 22.5) % 16;
            const arrows = ['↓', '↙', '↙', '↙', '←', '↖', '↖', '↖', '↑', '↗', '↗', '↗', '→', '↘', '↘', '↘'];
            // Correcting arrow logic for N, E, S, W
            if (degrees >= 337.5 || degrees < 22.5) return `↓ (${directions[0]})`; // N
            if (degrees >= 67.5 && degrees < 112.5) return `← (${directions[4]})`; // E
            if (degrees >= 157.5 && degrees < 202.5) return `↑ (${directions[8]})`; // S
            if (degrees >= 247.5 && degrees < 292.5) return `→ (${directions[12]})`;// W
            return `${arrows[index]} (${directions[index]})`;
        }


        function updateCurrentDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            };
            const dateString = now.toLocaleDateString('tr-TR', options);
            const el = document.getElementById('currentDate');
            if (el) el.textContent = dateString;
        }
        
        function updateLastBulkUpdateTimeDisplay() {
            const lastBulkUpdateTime = localStorage.getItem('lastBulkUpdateTime_v3');
            const displayEl = document.getElementById('lastBulkUpdateTimeDisplay');
            if (lastBulkUpdateTime) {
                displayEl.textContent = `Tüm veriler en son ${new Date(parseInt(lastBulkUpdateTime)).toLocaleString('tr-TR')} tarihinde güncellendi.`;
            } else {
                displayEl.textContent = 'Veriler henüz toplu olarak güncellenmedi. İlk güncelleme için "Tüm Verileri Yenile" butonunu kullanın.';
            }
        }

        // --- END OF SCRIPT ---
    </script>
</body>
</html>
