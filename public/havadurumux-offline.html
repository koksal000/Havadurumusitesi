
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HavaDurumuX - Çevrimdışı</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f8ff; /* Light AliceBlue */
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }
        .header {
            background-color: #87CEEB; /* Sky Blue */
            color: white;
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
        }
        .header-title {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .header-controls button, .header-controls select {
            margin-left: 0.5rem;
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        .header-controls #dataProgressIndicator {
            background-color: rgba(255,255,255,0.2);
            padding: 0.3rem 0.7rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            margin-left: 0.5rem;
            color: white;
            font-weight: 500;
        }
        .main-container {
            flex-grow: 1;
            padding: 1rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }
        .weather-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .weather-card-header {
            background-color: #E6E6FA; /* Soft Lavender */
            color: #555;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #ddd;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .weather-card-body {
            padding: 1rem;
        }
        .current-weather-display {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-bottom: 1rem;
        }
        .current-weather-display .temp {
            font-size: 3rem;
            font-weight: bold;
            color: #87CEEB;
        }
        .current-weather-display .condition-icon {
            font-size: 3.5rem;
            color: #87CEEB;
        }
        .current-weather-display .condition-text {
            font-size: 1rem;
            color: #555;
            text-align: center;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .detail-item:last-child {
            border-bottom: none;
        }
        .detail-item .label {
            color: #666;
            font-size: 0.85rem;
        }
        .detail-item .value {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .forecast-tabs .nav-link {
            color: #87CEEB;
            font-weight: 500;
        }
        .forecast-tabs .nav-link.active {
            color: #555;
            background-color: #E6E6FA !important;
            border-color: #ddd #ddd #E6E6FA !important;
        }
        .daily-forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.3rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .daily-forecast-item:last-child {
            border-bottom: none;
        }
        .daily-forecast-item .day {
            font-weight: 600;
        }
        .daily-forecast-item .icon {
            font-size: 1.5rem;
            color: #87CEEB;
        }
        .hourly-forecast-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 1rem;
        }
        .hourly-forecast-item {
            display: inline-block;
            width: 80px;
            text-align: center;
            padding: 0.5rem;
            margin-right: 0.5rem;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
            font-size: 0.8rem;
        }
        .hourly-forecast-item .icon {
            font-size: 1.8rem;
            color: #87CEEB;
            margin-bottom: 0.2rem;
        }
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1060;
            font-size: 1.2rem;
        }
        .loading-container .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }
        .quick-actions button {
            margin: 0.2rem;
            font-size: 0.8rem;
        }
        #mapContainer iframe {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .footer {
            text-align: center;
            padding: 1rem;
            background-color: #e0f0f8;
            color: #555;
            font-size: 0.85rem;
            margin-top: auto;
        }
        @media (max-width: 767px) {
            .header-content {
                flex-direction: column;
            }
            .header-title {
                margin-bottom: 0.5rem;
            }
            .header-controls {
                width: 100%;
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
            }
            .header-controls > * { margin: 0.2rem; }
            .current-weather-display { flex-direction: column; }
            .current-weather-display .temp { margin-bottom: 0.5rem; font-size: 2.5rem; }
            .current-weather-display .condition-icon { font-size: 3rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <div class="header-title">HavaDurumuX Çevrimdışı</div>
            <div class="header-controls">
                <select id="provinceSelect" class="form-select form-select-sm d-inline-block" style="width: auto;"></select>
                <button id="forceRefreshButton" class="btn btn-light btn-sm" title="Mevcut konum verilerini anında yenile (API'den)">
                    <i class="fas fa-sync-alt"></i> Yenile
                </button>
                 <button id="forceBulkUpdateButton" class="btn btn-warning btn-sm" title="Tüm kayıtlı il verilerini API'den çekerek güncelle (6 saat bekleme süresini atlar)">
                    <i class="fas fa-database"></i> Tümünü API'den Yenile
                </button>
                <div id="dataProgressIndicator" title="Yerelde saklanan konum verisi sayısı / Toplam hedef konum sayısı">-- / --</div>
            </div>
        </div>
    </header>

    <!-- Pinned Location Modal -->
    <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="locationModalLabel">'Mevcut Konum' Olarak Sabitlenecek Yeri Seçin</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="small text-muted">Bu seçim, tarayıcınızdan konum izni istemeden, 'Konumumu Bul' butonuna bastığınızda varsayılan olarak gösterilecek konumu belirler.</p>
            <select id="modalProvinceSelect" class="form-select"></select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
            <button type="button" class="btn btn-primary" id="savePinnedLocationBtn">Kaydet</button>
          </div>
        </div>
      </div>
    </div>


    <div class="main-container container mt-3">
        <div id="loadingContainer" class="loading-container" style="display: none;">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p id="loadingMessage">Yükleniyor...</p>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="weather-card">
                    <div class="weather-card-header" id="currentCity">Konum Seçin</div>
                    <div class="weather-card-body">
                        <div class="current-weather-display">
                            <div>
                                <div class="condition-icon"><i class="fas fa-question-circle"></i></div>
                                <div class="condition-text" id="currentCondition">--</div>
                            </div>
                            <div class="temp" id="currentTemp">--°C</div>
                        </div>
                        <div id="currentTimestamp" class="text-muted text-center small mb-3">Güncelleme: --</div>
                    </div>
                </div>

                <ul class="nav nav-tabs forecast-tabs" id="weatherTab" role="tablist">
                     <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Ayrıntılar</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="hourly-tab" data-bs-toggle="tab" data-bs-target="#hourly" type="button" role="tab" aria-controls="hourly" aria-selected="false">Saatlik</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab" aria-controls="daily" aria-selected="false">7 Günlük Tahmin</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab" aria-controls="alerts" aria-selected="false">Uyarılar</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map" type="button" role="tab" aria-controls="map" aria-selected="false">Harita</button>
                    </li>
                </ul>
                <div class="tab-content weather-card" id="weatherTabContent" style="border-top-left-radius: 0; border-top-right-radius: 0;">
                    <div class="tab-pane fade show active p-3" id="details" role="tabpanel" aria-labelledby="details-tab">
                        <h5>Ayrıntılı Bilgiler</h5>
                        <div id="detailsContainer" class="row">
                            <!-- Content will be generated by JS -->
                            <p class="text-muted">Veri yükleniyor...</p>
                        </div>
                    </div>
                    <div class="tab-pane fade p-3" id="hourly" role="tabpanel" aria-labelledby="hourly-tab">
                        <h5>Saatlik Tahmin (Gelecek 24 Saat)</h5>
                        <div id="hourlyForecastContainer" class="hourly-forecast-container">
                            <p class="text-muted">Saatlik tahmin verisi bulunamadı.</p>
                        </div>
                    </div>
                    <div class="tab-pane fade p-3" id="daily" role="tabpanel" aria-labelledby="daily-tab">
                        <h5>7 Günlük Tahmin</h5>
                        <div id="dailyForecastContainer">
                            <p class="text-muted">Günlük tahmin verisi bulunamadı.</p>
                        </div>
                    </div>
                    <div class="tab-pane fade p-3" id="alerts" role="tabpanel" aria-labelledby="alerts-tab">
                        <h5>Uyarılar (<span id="alertLocationName"></span>)</h5>
                        <div id="alertsContainer">
                            <p class="text-muted">Aktif uyarı bulunmuyor.</p>
                        </div>
                    </div>
                    <div class="tab-pane fade p-3" id="map" role="tabpanel" aria-labelledby="map-tab">
                        <h5>Konum Haritası: <span id="mapLocation"></span></h5>
                        <div id="mapContainer" style="width: 100%; height: 400px;">
                            <p class="text-muted">Harita yüklenemedi. Lütfen bir konum seçin.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="weather-card">
                    <div class="weather-card-header">Hızlı Eylemler</div>
                    <div class="weather-card-body quick-actions text-center">
                        <div id="pinnedLocationControls">
                            <button id="getCurrentLocationBtn" class="btn btn-primary btn-sm mb-2 w-100"><i class="fas fa-location-arrow"></i> Kayıtlı Konumumu Göster</button>
                        </div>
                        <p class="text-muted small">Popüler İller:</p>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="Ankara">Ankara</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="İstanbul">İstanbul</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="İzmir">İzmir</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="Antalya">Antalya</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="Bursa Merkez">Bursa Merkez</button>
                        <button class="btn btn-outline-info btn-sm quick-city-special" data-city="Bursa" data-district="İnegöl">Bursa İnegöl</button>
                        <button class="btn btn-outline-secondary btn-sm quick-city" data-city="Kütahya Merkez">Kütahya Merkez</button>
                        <button class="btn btn-outline-info btn-sm quick-city-special" data-city="Kütahya" data-district="Domaniç">Kütahya Domaniç</button>
                    </div>
                </div>
                 <div class="weather-card mt-3">
                    <div class="weather-card-header">Veri Kaynağı & Güncelleme</div>
                    <div class="weather-card-body small">
                        <p>Bu sayfadaki veriler, çevrimdışı kullanım için önbelleğe alınan <a href="https://www.met.no/" target="_blank" rel="noopener noreferrer">MET Norway</a> ve <a href="https://open-meteo.com/" target="_blank" rel="noopener noreferrer">Open-Meteo</a> API verileridir.</p>
                        <p>Veriler yaklaşık 6 saatte bir otomatik olarak güncellenmeye çalışılır.</p>
                        <p>Son toplu güncelleme: <span id="lastBulkUpdateTimeDisplay" class="fw-bold">Hiçbir zaman</span></p>
                        <p>Bir sonraki otomatik güncelleme yaklaşık: <span id="nextBulkUpdateTimeDisplay" class="fw-bold">--</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        HavaDurumuX Çevrimdışı Sürümü &copy; <span id="currentYear"></span>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Constants and Global State ---
        const DB_NAME = 'HavaDurumuXOfflineDB_v3';
        const DB_VERSION = 2;
        const STORE_NAME = 'weatherData_v3';
        const MET_API_BASE_URL = 'https://api.met.no/weatherapi/locationforecast/2.0/compact';
        const OPEN_METEO_API_BASE_URL = 'https://api.open-meteo.com/v1/forecast';
        const USER_AGENT = 'HavaDurumuXOffline/1.2 domaniccamlicakoyu@gmail.com';
        const BULK_REQUEST_DELAY = 1500; // 1.5 seconds
        const SIX_HOURS_MS = 6 * 60 * 60 * 1000;

        let db;
        let isBulkUpdating = false;
        let currentDisplayedData = null; // Holds the full data object for the currently displayed location
        let liveUpdateInterval = null; // To hold the setInterval ID for live UI updates
        let locationModal; // To hold the Bootstrap Modal instance

        // Utility to convert m/s to km/h
        const MPS_TO_KMH = 3.6;
        const provincesToFetchForBulkUpdate = [
            { displayName: "Adana Merkez", dbKey: "Adana_Merkez", lat: 37.00, lon: 35.32 }, { displayName: "Adıyaman Merkez", dbKey: "Adıyaman_Merkez", lat: 37.76, lon: 38.27 },
            { displayName: "Afyonkarahisar Merkez", dbKey: "Afyonkarahisar_Merkez", lat: 38.75, lon: 30.53 }, { displayName: "Ağrı Merkez", dbKey: "Ağrı_Merkez", lat: 39.72, lon: 43.05 },
            { displayName: "Amasya Merkez", dbKey: "Amasya_Merkez", lat: 40.65, lon: 35.83 }, { displayName: "Ankara Merkez", dbKey: "Ankara_Merkez", lat: 39.93, lon: 32.85 },
            { displayName: "Antalya Merkez", dbKey: "Antalya_Merkez", lat: 36.89, lon: 30.70 }, { displayName: "Artvin Merkez", dbKey: "Artvin_Merkez", lat: 41.18, lon: 41.82 },
            { displayName: "Aydın Merkez", dbKey: "Aydın_Merkez", lat: 37.84, lon: 27.83 }, { displayName: "Balıkesir Merkez", dbKey: "Balıkesir_Merkez", lat: 39.65, lon: 27.88 },
            { displayName: "Bilecik Merkez", dbKey: "Bilecik_Merkez", lat: 40.14, lon: 29.98 }, { displayName: "Bingöl Merkez", dbKey: "Bingöl_Merkez", lat: 38.88, lon: 40.49 },
            { displayName: "Bitlis Merkez", dbKey: "Bitlis_Merkez", lat: 38.40, lon: 42.11 }, { displayName: "Bolu Merkez", dbKey: "Bolu_Merkez", lat: 40.73, lon: 31.61 },
            { displayName: "Burdur Merkez", dbKey: "Burdur_Merkez", lat: 37.72, lon: 30.28 }, { displayName: "Bursa Merkez", dbKey: "Bursa_Merkez", lat: 40.18, lon: 29.06 },
            { displayName: "Bursa İnegöl", dbKey: "Bursa_İnegöl", lat: 40.0833, lon: 29.5167 }, { displayName: "Çanakkale Merkez", dbKey: "Çanakkale_Merkez", lat: 40.15, lon: 26.41 },
            { displayName: "Çankırı Merkez", dbKey: "Çankırı_Merkez", lat: 40.60, lon: 33.61 }, { displayName: "Çorum Merkez", dbKey: "Çorum_Merkez", lat: 40.55, lon: 34.95 },
            { displayName: "Denizli Merkez", dbKey: "Denizli_Merkez", lat: 37.77, lon: 29.09 }, { displayName: "Diyarbakır Merkez", dbKey: "Diyarbakır_Merkez", lat: 37.91, lon: 40.23 },
            { displayName: "Edirne Merkez", dbKey: "Edirne_Merkez", lat: 41.67, lon: 26.57 }, { displayName: "Elazığ Merkez", dbKey: "Elazığ_Merkez", lat: 38.67, lon: 39.22 },
            { displayName: "Erzincan Merkez", dbKey: "Erzincan_Merkez", lat: 39.74, lon: 39.49 }, { displayName: "Erzurum Merkez", dbKey: "Erzurum_Merkez", lat: 39.90, lon: 41.27 },
            { displayName: "Eskişehir Merkez", dbKey: "Eskişehir_Merkez", lat: 39.77, lon: 30.52 }, { displayName: "Gaziantep Merkez", dbKey: "Gaziantep_Merkez", lat: 37.06, lon: 37.38 },
            { displayName: "Giresun Merkez", dbKey: "Giresun_Merkez", lat: 40.91, lon: 38.39 }, { displayName: "Gümüşhane Merkez", dbKey: "Gümüşhane_Merkez", lat: 40.46, lon: 39.47 },
            { displayName: "Hakkari Merkez", dbKey: "Hakkari_Merkez", lat: 37.57, lon: 43.74 }, { displayName: "Hatay Merkez", dbKey: "Hatay_Merkez", lat: 36.20, lon: 36.16 },
            { displayName: "Isparta Merkez", dbKey: "Isparta_Merkez", lat: 37.76, lon: 30.55 }, { displayName: "Mersin Merkez", dbKey: "Mersin_Merkez", lat: 36.80, lon: 34.62 },
            { displayName: "İstanbul Merkez", dbKey: "İstanbul_Merkez", lat: 41.01, lon: 28.97 }, { displayName: "İzmir Merkez", dbKey: "İzmir_Merkez", lat: 38.42, lon: 27.14 },
            { displayName: "Kars Merkez", dbKey: "Kars_Merkez", lat: 40.60, lon: 43.09 }, { displayName: "Kastamonu Merkez", dbKey: "Kastamonu_Merkez", lat: 41.37, lon: 33.77 },
            { displayName: "Kayseri Merkez", dbKey: "Kayseri_Merkez", lat: 38.72, lon: 35.48 }, { displayName: "Kırklareli Merkez", dbKey: "Kırklareli_Merkez", lat: 41.73, lon: 27.22 },
            { displayName: "Kırşehir Merkez", dbKey: "Kırşehir_Merkez", lat: 39.14, lon: 34.16 }, { displayName: "Kocaeli Merkez", dbKey: "Kocaeli_Merkez", lat: 40.76, lon: 29.91 },
            { displayName: "Konya Merkez", dbKey: "Konya_Merkez", lat: 37.87, lon: 32.48 }, { displayName: "Kütahya Merkez", dbKey: "Kütahya_Merkez", lat: 39.42, lon: 29.98 },
            { displayName: "Kütahya Domaniç", dbKey: "Kütahya_Domaniç", lat: 39.8119, lon: 29.6078 }, { displayName: "Malatya Merkez", dbKey: "Malatya_Merkez", lat: 38.35, lon: 38.30 },
            { displayName: "Manisa Merkez", dbKey: "Manisa_Merkez", lat: 38.61, lon: 27.42 }, { displayName: "Kahramanmaraş Merkez", dbKey: "Kahramanmaraş_Merkez", lat: 37.58, lon: 36.93 },
            { displayName: "Mardin Merkez", dbKey: "Mardin_Merkez", lat: 37.31, lon: 40.73 }, { displayName: "Muğla Merkez", dbKey: "Muğla_Merkez", lat: 37.21, lon: 28.36 },
            { displayName: "Muş Merkez", dbKey: "Muş_Merkez", lat: 38.73, lon: 41.49 }, { displayName: "Nevşehir Merkez", dbKey: "Nevşehir_Merkez", lat: 38.62, lon: 34.71 },
            { displayName: "Niğde Merkez", dbKey: "Niğde_Merkez", lat: 37.96, lon: 34.68 }, { displayName: "Ordu Merkez", dbKey: "Ordu_Merkez", lat: 40.98, lon: 37.88 },
            { displayName: "Rize Merkez", dbKey: "Rize_Merkez", lat: 41.02, lon: 40.52 }, { displayName: "Sakarya Merkez", dbKey: "Sakarya_Merkez", lat: 40.77, lon: 30.40 },
            { displayName: "Samsun Merkez", dbKey: "Samsun_Merkez", lat: 41.28, lon: 36.33 }, { displayName: "Siirt Merkez", dbKey: "Siirt_Merkez", lat: 37.93, lon: 41.94 },
            { displayName: "Sinop Merkez", dbKey: "Sinop_Merkez", lat: 42.02, lon: 35.15 }, { displayName: "Sivas Merkez", dbKey: "Sivas_Merkez", lat: 39.75, lon: 37.01 },
            { displayName: "Tekirdağ Merkez", dbKey: "Tekirdağ_Merkez", lat: 40.98, lon: 27.51 }, { displayName: "Tokat Merkez", dbKey: "Tokat_Merkez", lat: 40.32, lon: 36.55 },
            { displayName: "Trabzon Merkez", dbKey: "Trabzon_Merkez", lat: 41.00, lon: 39.72 }, { displayName: "Tunceli Merkez", dbKey: "Tunceli_Merkez", lat: 39.10, lon: 39.54 },
            { displayName: "Şanlıurfa Merkez", dbKey: "Şanlıurfa_Merkez", lat: 37.16, lon: 38.79 }, { displayName: "Uşak Merkez", dbKey: "Uşak_Merkez", lat: 38.67, lon: 29.40 },
            { displayName: "Van Merkez", dbKey: "Van_Merkez", lat: 38.50, lon: 43.37 }, { displayName: "Yozgat Merkez", dbKey: "Yozgat_Merkez", lat: 39.82, lon: 34.80 },
            { displayName: "Zonguldak Merkez", dbKey: "Zonguldak_Merkez", lat: 41.45, lon: 31.79 }, { displayName: "Aksaray Merkez", dbKey: "Aksaray_Merkez", lat: 38.36, lon: 34.03 },
            { displayName: "Bayburt Merkez", dbKey: "Bayburt_Merkez", lat: 40.25, lon: 40.22 }, { displayName: "Karaman Merkez", dbKey: "Karaman_Merkez", lat: 37.18, lon: 33.21 },
            { displayName: "Kırıkkale Merkez", dbKey: "Kırıkkale_Merkez", lat: 39.84, lon: 33.51 }, { displayName: "Batman Merkez", dbKey: "Batman_Merkez", lat: 37.88, lon: 41.13 },
            { displayName: "Şırnak Merkez", dbKey: "Şırnak_Merkez", lat: 37.51, lon: 42.46 }, { displayName: "Bartın Merkez", dbKey: "Bartın_Merkez", lat: 41.63, lon: 32.33 },
            { displayName: "Ardahan Merkez", dbKey: "Ardahan_Merkez", lat: 41.11, lon: 42.70 }, { displayName: "Iğdır Merkez", dbKey: "Iğdır_Merkez", lat: 39.92, lon: 44.04 },
            { displayName: "Yalova Merkez", dbKey: "Yalova_Merkez", lat: 40.65, lon: 29.27 }, { displayName: "Karabük Merkez", dbKey: "Karabük_Merkez", lat: 41.20, lon: 32.62 },
            { displayName: "Kilis Merkez", dbKey: "Kilis_Merkez", lat: 36.71, lon: 37.11 }, { displayName: "Osmaniye Merkez", dbKey: "Osmaniye_Merkez", lat: 37.07, lon: 36.24 },
            { displayName: "Düzce Merkez", dbKey: "Düzce_Merkez", lat: 40.84, lon: 31.15 }
        ];
        const TOTAL_TARGET_LOCATIONS = provincesToFetchForBulkUpdate.length;

        // DOM Elements
        const provinceSelect = document.getElementById('provinceSelect');
        const modalProvinceSelect = document.getElementById('modalProvinceSelect');
        const currentCityEl = document.getElementById('currentCity');
        const currentTempEl = document.getElementById('currentTemp');
        const currentConditionEl = document.getElementById('currentCondition');
        const currentConditionIconEl = document.querySelector('.current-weather-display .condition-icon i');
        const currentTimestampEl = document.getElementById('currentTimestamp');
        const detailsContainer = document.getElementById('detailsContainer');
        const hourlyForecastContainer = document.getElementById('hourlyForecastContainer');
        const dailyForecastContainer = document.getElementById('dailyForecastContainer');
        const alertsContainer = document.getElementById('alertsContainer');
        const alertLocationNameEl = document.getElementById('alertLocationName');
        const mapContainer = document.getElementById('mapContainer');
        const mapLocationEl = document.getElementById('mapLocation');
        const loadingContainer = document.getElementById('loadingContainer');
        const loadingMessageEl = document.getElementById('loadingMessage');
        const forceRefreshButton = document.getElementById('forceRefreshButton');
        const forceBulkUpdateButton = document.getElementById('forceBulkUpdateButton');
        const getCurrentLocationBtn = document.getElementById('getCurrentLocationBtn');
        const savePinnedLocationBtn = document.getElementById('savePinnedLocationBtn');
        const pinnedLocationControls = document.getElementById('pinnedLocationControls');
        const dataProgressIndicator = document.getElementById('dataProgressIndicator');
        const lastBulkUpdateTimeDisplay = document.getElementById('lastBulkUpdateTimeDisplay');
        const nextBulkUpdateTimeDisplay = document.getElementById('nextBulkUpdateTimeDisplay');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            locationModal = new bootstrap.Modal(document.getElementById('locationModal'));
            
            populateProvinceSelect(provinceSelect);
            populateProvinceSelect(modalProvinceSelect);
            initDb();

            provinceSelect.addEventListener('change', handleProvinceSelectChange);
            forceRefreshButton.addEventListener('click', handleForceRefresh);
            forceBulkUpdateButton.addEventListener('click', handleForceBulkUpdate);
            getCurrentLocationBtn.addEventListener('click', handleGetCurrentLocation);
            savePinnedLocationBtn.addEventListener('click', handleSavePinnedLocation);
            
            document.querySelectorAll('.quick-city, .quick-city-special').forEach(button => {
                button.addEventListener('click', handleQuickCitySelect);
            });
            
            setupPinnedLocationControls();
            
            const lastSelectedDbKey = localStorage.getItem('lastSelectedLocationDbKey_v3');
            let initialLocation = provincesToFetchForBulkUpdate.find(p => p.dbKey === lastSelectedDbKey);
            if (!initialLocation) {
                initialLocation = provincesToFetchForBulkUpdate.find(p => p.dbKey === "Kütahya_Merkez") || provincesToFetchForBulkUpdate[0];
            }
            if(initialLocation) {
                 provinceSelect.value = initialLocation.dbKey;
            }
        });

        function initDb() {
            showLoading('Veritabanı başlatılıyor...');
            const dbRequest = indexedDB.open(DB_NAME, DB_VERSION);

            dbRequest.onupgradeneeded = (event) => {
                db = (event.target).result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'dbKey' });
                }
            };

            dbRequest.onsuccess = (event) => {
                db = (event.target).result;
                console.log("Database opened successfully.");
                updateDataProgressIndicator();
                
                const selectedKey = provinceSelect.value;
                const locationToLoad = provincesToFetchForBulkUpdate.find(p => p.dbKey === selectedKey);
                if (locationToLoad) {
                     loadWeatherDataForLocation(locationToLoad);
                }

                const lastBulkUpdateTime = parseInt(localStorage.getItem('lastBulkUpdateTime_v3') || '0');
                if (Date.now() - lastBulkUpdateTime > SIX_HOURS_MS) {
                    bulkUpdateAllProvincesData(false);
                } else {
                    console.log("Auto bulk update not needed, last update was recent.");
                    hideLoading();
                }
                updateLastBulkUpdateTimeDisplay();
                updateNextBulkUpdateDisplay(lastBulkUpdateTime);
            };

            dbRequest.onerror = (event) => {
                console.error("Database error:", (event.target).error);
                showError("Veritabanı açılamadı.");
                hideLoading();
            };
        }
        
        // --- UI Setup & Handlers ---

        function populateProvinceSelect(selectElement) {
            provincesToFetchForBulkUpdate.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.dbKey;
                option.textContent = loc.displayName;
                selectElement.appendChild(option);
            });
        }
        
        function setupPinnedLocationControls() {
            const pinnedLocationKey = localStorage.getItem('userPinnedGeolocation_v3');
            pinnedLocationControls.innerHTML = ''; // Clear previous
            
            if (pinnedLocationKey) {
                 const pinnedLocation = provincesToFetchForBulkUpdate.find(p => p.dbKey === pinnedLocationKey);
                 const btnText = pinnedLocation ? `${pinnedLocation.displayName} için Göster` : "Kayıtlı Konumumu Göster";
                 
                 const showBtn = document.createElement('button');
                 showBtn.id = 'getCurrentLocationBtn';
                 showBtn.className = 'btn btn-primary btn-sm mb-2 w-100';
                 showBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${btnText}`;
                 showBtn.addEventListener('click', handleGetCurrentLocation);

                 const changeBtn = document.createElement('button');
                 changeBtn.id = 'changePinnedLocationBtn';
                 changeBtn.className = 'btn btn-outline-secondary btn-sm w-100';
                 changeBtn.innerHTML = `<i class="fas fa-edit"></i> Kayıtlı Konumu Değiştir`;
                 changeBtn.addEventListener('click', () => {
                     modalProvinceSelect.value = pinnedLocationKey;
                     locationModal.show();
                 });

                 pinnedLocationControls.appendChild(showBtn);
                 pinnedLocationControls.appendChild(changeBtn);

            } else {
                const setBtn = document.createElement('button');
                setBtn.id = 'getCurrentLocationBtn';
                setBtn.className = 'btn btn-primary btn-sm mb-2 w-100';
                setBtn.innerHTML = `<i class="fas fa-location-arrow"></i> 'Mevcut Konum' Ayarla`;
                setBtn.addEventListener('click', handleGetCurrentLocation);
                pinnedLocationControls.appendChild(setBtn);
            }
        }

        function handleProvinceSelectChange() {
            const selectedDbKey = provinceSelect.value;
            localStorage.setItem('lastSelectedLocationDbKey_v3', selectedDbKey);
            const selectedLoc = provincesToFetchForBulkUpdate.find(p => p.dbKey === selectedDbKey);
            if (selectedLoc) {
                loadWeatherDataForLocation(selectedLoc);
            }
        }
        
        function handleQuickCitySelect(event) {
            const cityDisplayName = event.target.textContent;
            const targetLocation = provincesToFetchForBulkUpdate.find(p => p.displayName === cityDisplayName);
            if (targetLocation) {
                provinceSelect.value = targetLocation.dbKey;
                handleProvinceSelectChange();
            }
        }

        function handleForceRefresh() {
            const selectedKey = provinceSelect.value;
            const locationToRefresh = provincesToFetchForBulkUpdate.find(p => p.dbKey === selectedKey);
            if (locationToRefresh) {
                console.log("Forcing refresh for current location:", locationToRefresh.displayName);
                loadWeatherDataForLocation(locationToRefresh, true);
            } else {
                alert("Lütfen önce bir konum seçin.");
            }
        }
        
        function handleForceBulkUpdate() {
            bulkUpdateAllProvincesData(true); 
        }
        
        function handleGetCurrentLocation() {
            const pinnedLocationKey = localStorage.getItem('userPinnedGeolocation_v3');
            if (pinnedLocationKey) {
                const locationToLoad = provincesToFetchForBulkUpdate.find(p => p.dbKey === pinnedLocationKey);
                if (locationToLoad) {
                    provinceSelect.value = locationToLoad.dbKey;
                    handleProvinceSelectChange();
                }
            } else {
                locationModal.show();
            }
        }

        function handleSavePinnedLocation() {
            const selectedKey = modalProvinceSelect.value;
            if (selectedKey) {
                localStorage.setItem('userPinnedGeolocation_v3', selectedKey);
                locationModal.hide();
                setupPinnedLocationControls();
                // Optionally, load the newly pinned location immediately
                const locationToLoad = provincesToFetchForBulkUpdate.find(p => p.dbKey === selectedKey);
                if (locationToLoad) {
                    provinceSelect.value = locationToLoad.dbKey;
                    handleProvinceSelectChange();
                }
            }
        }

        // --- Data Fetching and Management ---

        async function loadWeatherDataForLocation(location, forceApiFetch = false) {
            if (!location || !location.dbKey) {
                console.error("Invalid location:", location);
                updateAllUI(null, "Geçersiz Konum");
                return;
            }
            showLoading(`${location.displayName} için veri yükleniyor...`);
            
            let data = null;
            if (!forceApiFetch) {
                data = await getWeatherDataFromDB(location.dbKey);
            }

            if (data && data.timestamp && (Date.now() - data.timestamp < SIX_HOURS_MS)) {
                 console.log(`Fresh data for ${location.displayName} found in DB.`);
                 currentDisplayedData = data;
                 updateAllUI(currentDisplayedData, location.displayName);
                 hideLoading();
                 return;
            }

            // Fetch from API if no fresh data
            const fetchedData = await fetchAndMergeWeatherData(location);
            if (fetchedData) {
                currentDisplayedData = fetchedData;
                updateAllUI(currentDisplayedData, location.displayName);
            } else {
                // If fetch fails, try to use stale data from DB as a fallback
                currentDisplayedData = data || null;
                updateAllUI(currentDisplayedData, location.displayName + (currentDisplayedData ? " (Eski Veri)" : " (Veri Alınamadı)"));
            }
            hideLoading();
        }

        async function fetchAndMergeWeatherData(location) {
            try {
                // Fetch primary data from MET Norway
                const metResponse = await fetch(`${MET_API_BASE_URL}?lat=${location.lat}&lon=${location.lon}`, {
                    headers: { 'User-Agent': USER_AGENT }
                });
                if (!metResponse.ok) throw new Error(`MET Norway API Error: ${metResponse.status}`);
                const metData = await metResponse.json();

                // Fetch supplementary data from Open-Meteo
                const omParams = new URLSearchParams({
                    latitude: location.lat,
                    longitude: location.lon,
                    current: 'apparent_temperature,wind_gusts_10m',
                    hourly: 'apparent_temperature,wind_gusts_10m',
                    daily: 'apparent_temperature_max,apparent_temperature_min,sunrise,sunset,uv_index_max',
                    timezone: 'auto',
                    forecast_days: 7
                });
                const openMeteoResponse = await fetch(`${OPEN_METEO_API_BASE_URL}?${omParams}`);
                if (!openMeteoResponse.ok) throw new Error(`Open-Meteo API Error: ${openMeteoResponse.status}`);
                const openMeteoData = await openMeteoResponse.json();
                
                // Merge Data
                const mergedData = {
                    ...metData,
                    openMeteo: openMeteoData,
                    timestamp: Date.now(),
                    dbKey: location.dbKey
                };
                
                await saveWeatherDataToDB(mergedData);
                return mergedData;

            } catch (error) {
                console.error(`Failed to fetch/merge data for ${location.displayName}:`, error);
                return null;
            }
        }


        function getWeatherDataFromDB(dbKey) {
            return new Promise((resolve, reject) => {
                if (!db) { reject("DB not open"); return; }
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(dbKey);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function saveWeatherDataToDB(data) {
            return new Promise((resolve, reject) => {
                if (!db) { reject("DB not open"); return; }
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }
        
        async function bulkUpdateAllProvincesData(forceUpdate = false) {
            if (isBulkUpdating) { return; }
            
            const lastBulkUpdateTime = parseInt(localStorage.getItem('lastBulkUpdateTime_v3') || '0');
            if (!forceUpdate && (Date.now() - lastBulkUpdateTime < SIX_HOURS_MS)) {
                console.log("Bulk update skipped, last update was recent.");
                return;
            }

            isBulkUpdating = true;
            let updatedSomething = false;
            showLoading(`Toplu güncelleme başlatılıyor (0/${TOTAL_TARGET_LOCATIONS})...`);

            for (let i = 0; i < TOTAL_TARGET_LOCATIONS; i++) {
                const location = provincesToFetchForBulkUpdate[i];
                updateLoadingMessage(`İller Güncelleniyor: ${i + 1} / ${TOTAL_TARGET_LOCATIONS} (${location.displayName})...`);
                const fetchedData = await fetchAndMergeWeatherData(location);
                if (fetchedData) updatedSomething = true;
                if (i < TOTAL_TARGET_LOCATIONS - 1) {
                    await new Promise(resolve => setTimeout(resolve, BULK_REQUEST_DELAY));
                }
            }
            
            if (updatedSomething) {
                localStorage.setItem('lastBulkUpdateTime_v3', Date.now().toString());
            }
            
            isBulkUpdating = false;
            showLoading("Toplu güncelleme tamamlandı.", 2000);
            updateDataProgressIndicator();
            updateLastBulkUpdateTimeDisplay();
            updateNextBulkUpdateDisplay(parseInt(localStorage.getItem('lastBulkUpdateTime_v3') || '0'));

            // Refresh the currently viewed location's display with the new data
            const currentSelectedKey = provinceSelect.value;
            const currentLoc = provincesToFetchForBulkUpdate.find(p => p.dbKey === currentSelectedKey);
            if (currentLoc) loadWeatherDataForLocation(currentLoc);
        }

        // --- UI Update Functions ---
        
        function updateAllUI(weatherData, cityName) {
            clearInterval(liveUpdateInterval);

            if (!weatherData || !weatherData.properties || !weatherData.properties.timeseries) {
                const elementsToClear = [currentCityEl, currentTempEl, currentConditionEl, currentTimestampEl, detailsContainer, hourlyForecastContainer, dailyForecastContainer, alertsContainer];
                elementsToClear.forEach(el => { if(el) el.innerHTML = (el.id === 'currentCity') ? cityName : '--'; });
                if (currentConditionIconEl) currentConditionIconEl.className = 'fas fa-question-circle';
                updateMapTab(null, null, cityName);
                return;
            }

            const runLiveUpdate = () => updateLiveUIComponents(weatherData, cityName);
            
            runLiveUpdate(); // Run once immediately
            liveUpdateInterval = setInterval(runLiveUpdate, 60000); // Re-run every minute

            // Components that don't need minutely updates
            updateDailyForecast(weatherData);
            updateAlerts(weatherData);
            updateMapTab(weatherData.geometry.coordinates[1], weatherData.geometry.coordinates[0], cityName);
        }
        
        function findCurrentTimeseriesIndex(timeseries) {
            const now = Date.now();
            let closestIndex = 0;
            for (let i = 0; i < timeseries.length; i++) {
                if (new Date(timeseries[i].time).getTime() <= now) {
                    closestIndex = i;
                } else {
                    break;
                }
            }
            return closestIndex;
        }

        function updateLiveUIComponents(weatherData, cityName) {
            const timeseries = weatherData.properties.timeseries;
            const currentIndex = findCurrentTimeseriesIndex(timeseries);
            const currentEntry = timeseries[currentIndex];
            
            updateCurrentWeatherDisplay(currentEntry, cityName, weatherData.timestamp);
            updateDetailedInfo(currentEntry, weatherData.openMeteo, currentIndex);
            updateHourlyForecast(timeseries, currentIndex);
        }

        function updateCurrentWeatherDisplay(currentEntry, cityName, dataTimestamp) {
            currentCityEl.textContent = cityName;
            const weatherDetails = currentEntry.data.instant.details;
            const next1HourSummary = currentEntry.data.next_1_hours?.summary;
            
            currentTempEl.textContent = `${weatherDetails.air_temperature.toFixed(1)}°C`;
            const symbolCode = next1HourSummary ? next1HourSummary.symbol_code : 'unknown';
            const { description, Icon } = getWeatherSymbolInfo(symbolCode, new Date(currentEntry.time));
            currentConditionEl.textContent = description;
            currentConditionIconEl.className = Icon;
            
            const entryTime = new Date(currentEntry.time);
            currentTimestampEl.textContent = `Tahmin Saati: ${entryTime.toLocaleTimeString('tr-TR')} | Veri Zamanı: ${new Date(dataTimestamp).toLocaleTimeString('tr-TR')}`;
        }
        
        function updateDetailedInfo(currentEntry, openMeteoData, currentIndex) {
            detailsContainer.innerHTML = '';
            const na = "N/A";
            const metDetails = currentEntry?.data?.instant?.details;
            const metNextHour = currentEntry?.data?.next_1_hours?.details;
            
            // Open-Meteo data for the corresponding hour
            const omCurrent = openMeteoData?.current;
            const omHourly = openMeteoData?.hourly;
            
            const createDetailItem = (label, value, unit = '') => {
                if (value === undefined || value === null || (typeof value === 'number' && isNaN(value))) {
                    return ''; // Don't render if value is not available
                }
                return `
                    <div class="col-md-6 col-lg-4">
                        <div class="detail-card">
                            ${label}
                            <div class="value">${value}${unit}</div>
                        </div>
                    </div>
                `;
            };

            let detailsHtml = '';
            detailsHtml += createDetailItem('Sıcaklık', metDetails?.air_temperature?.toFixed(1), '°C');
            
            // Check OpenMeteo for apparent_temperature
            let apparentTemp = omHourly?.apparent_temperature?.[currentIndex];
            if (apparentTemp === undefined) apparentTemp = omCurrent?.apparent_temperature;
            detailsHtml += createDetailItem('Hissedilen', apparentTemp?.toFixed(1), '°C');

            detailsHtml += createDetailItem('Basınç', metDetails?.air_pressure_at_sea_level?.toFixed(0), ' hPa');
            detailsHtml += createDetailItem('Nem', metDetails?.relative_humidity?.toFixed(0), '%');
            detailsHtml += createDetailItem('Bulut Oranı', metDetails?.cloud_area_fraction?.toFixed(0), '%');
            detailsHtml += createDetailItem('Rüzgar Yönü', metDetails?.wind_from_direction?.toFixed(0), '°');
            detailsHtml += createDetailItem('Rüzgar Hızı', (metDetails?.wind_speed * MPS_TO_KMH)?.toFixed(1), ' km/s');
            
            // Check OpenMeteo for wind_gusts
            let windGust = omHourly?.wind_gusts_10m?.[currentIndex];
            if (windGust === undefined) windGust = omCurrent?.wind_gusts_10m;
            detailsHtml += createDetailItem('Rüzgar Hamlesi', windGust?.toFixed(1), ' km/s');

            detailsHtml += createDetailItem('Yağış (1 Saat)', metNextHour?.precipitation_amount?.toFixed(1), ' mm');

            detailsContainer.innerHTML = detailsHtml || '<p class="text-muted p-3">Ayrıntılı veri bulunamadı.</p>';
        }

        function updateHourlyForecast(timeseries, startIndex) {
            let hourlyHtml = '';
            const hourlyToShow = Math.min(timeseries.length - startIndex, 24);
            
            for (let i = 0; i < hourlyToShow; i++) {
                const entry = timeseries[startIndex + i];
                const time = new Date(entry.time);
                const symbolInfo = getWeatherSymbolInfo(entry.data.next_1_hours?.summary.symbol_code, time);
                hourlyHtml += `
                    <div class="hourly-forecast-item">
                        <div>${time.getHours()}:00</div>
                        <div class="icon"><i class="${symbolInfo.Icon}"></i></div>
                        <div>${entry.data.instant.details.air_temperature.toFixed(0)}°C</div>
                        <div class="text-muted small">${(entry.data.next_1_hours?.details.precipitation_amount || 0).toFixed(1)}mm</div>
                    </div>
                `;
            }
            hourlyForecastContainer.innerHTML = hourlyHtml || '<p class="text-muted">Saatlik tahmin verisi yok.</p>';
        }

        function updateDailyForecast(weatherData) {
            const timeseries = weatherData.properties.timeseries;
            const openMeteoDaily = weatherData.openMeteo?.daily;

            const dailyAggregated = {};
            if (openMeteoDaily && openMeteoDaily.time) {
                openMeteoDaily.time.forEach((dateStr, index) => {
                    dailyAggregated[dateStr] = {
                        date: new Date(dateStr),
                        minTemp: openMeteoDaily.apparent_temperature_min[index],
                        maxTemp: openMeteoDaily.apparent_temperature_max[index],
                        sunrise: openMeteoDaily.sunrise[index],
                        sunset: openMeteoDaily.sunset[index],
                        uv_index: openMeteoDaily.uv_index_max[index],
                        precip: 0, // Will be summed from MET hourly
                        codes: []
                    };
                });
            }

            // Aggregate precip and codes from MET.no hourly data
            timeseries.forEach(entry => {
                const dateStr = new Date(entry.time).toISOString().split('T')[0];
                if (dailyAggregated[dateStr]) {
                    dailyAggregated[dateStr].precip += (entry.data.next_1_hours?.details.precipitation_amount || 0);
                    dailyAggregated[dateStr].codes.push(entry.data.next_1_hours?.summary.symbol_code);
                }
            });

            let dailyHtml = '';
            for (const dateStr in dailyAggregated) {
                const dayData = dailyAggregated[dateStr];
                const codeCounts = dayData.codes.reduce((acc, code) => {
                    if(code) acc[code] = (acc[code] || 0) + 1;
                    return acc;
                }, {});
                let dominantCode = dayData.codes.find(c => c) || 'clearsky_day';
                let maxCount = 0;
                for (const code in codeCounts) {
                    if (codeCounts[code] > maxCount) {
                        maxCount = codeCounts[code];
                        dominantCode = code;
                    }
                }
                const symbolInfo = getWeatherSymbolInfo(dominantCode, dayData.date);
                const dayName = dayData.date.toLocaleDateString('tr-TR', { weekday: 'short' });

                dailyHtml += `
                    <div class="daily-forecast-item">
                        <span class="day">${dayName}, ${dayData.date.toLocaleDateString('tr-TR', {day: '2-digit', month:'short'})}</span>
                        <span class="icon"><i class="${symbolInfo.Icon}"></i></span>
                        <span>${dayData.minTemp?.toFixed(0) ?? 'N/A'}° / ${dayData.maxTemp?.toFixed(0) ?? 'N/A'}°C</span>
                        <span class="text-muted small">${dayData.precip.toFixed(1)}mm</span>
                    </div>
                `;
            }
            dailyForecastContainer.innerHTML = dailyHtml || '<p class="text-muted">Günlük tahmin verisi yok.</p>';
        }
        
        function updateAlerts(weatherData) {
            alertsContainer.innerHTML = '';
            const timeseries = weatherData?.properties?.timeseries;
            const openMeteoDaily = weatherData?.openMeteo?.daily;
            if (!timeseries || !openMeteoDaily) {
                alertsContainer.innerHTML = '<p class="text-muted">Uyarı bilgisi için veri bulunamadı.</p>';
                return;
            }

            const lookAheadHours = Math.min(timeseries.length, 66);
            let hasSignificantPrecipitation = false;
            let hasHighTemp = false;
            let hasLowTemp = false;

            for (let i = 0; i < lookAheadHours; i++) {
                const entry = timeseries[i];
                const temp = entry.data.instant.details.air_temperature;
                const precip = entry.data.next_1_hours?.details.precipitation_amount || 0;
                
                if (precip > 0.1) hasSignificantPrecipitation = true;
                if (temp > 30) hasHighTemp = true;
                if (temp < 5) hasLowTemp = true;
            }
            
            let alertMessage = '';
            const conditions = [];
            if(hasSignificantPrecipitation) conditions.push('yağış');
            if(hasHighTemp) conditions.push('yüksek sıcaklık');
            if(hasLowTemp) conditions.push('düşük sıcaklık');

            if(conditions.length > 0){
                alertMessage = `Önümüzdeki 66 saat içinde ${conditions.join(', ')} bekleniyor. Detaylar için saatlik ve günlük tahminleri kontrol ediniz.`;
                 const alertDiv = document.createElement('div');
                 alertDiv.className = 'alert alert-warning small p-2 mb-2';
                 alertDiv.textContent = alertMessage;
                 alertsContainer.appendChild(alertDiv);
            } else {
                alertsContainer.innerHTML = '<p class="text-muted">Önümüzdeki 66 saat için önemli bir meteorolojik uyarı bulunmuyor.</p>';
            }
        }

        function updateMapTab(lat, lon, locationName) {
            mapLocationEl.textContent = locationName || "Bilinmiyor";
            if (lat && lon) {
                mapContainer.innerHTML = `<iframe src="https://maps.google.com/maps?q=${lat},${lon}&hl=tr&z=10&output=embed" width="100%" height="100%"></iframe>`;
            } else {
                mapContainer.innerHTML = '<p class="text-muted">Harita için konum bilgisi bulunamadı.</p>';
            }
        }
        
        // --- Utility Functions ---

        function getWeatherSymbolInfo(symbolCode, date = new Date()) {
            const code = symbolCode ? symbolCode.toLowerCase() : 'unknown';
            const hour = date.getHours();
            const isDayTime = hour > 6 && hour < 20;
            if (code.startsWith('clearsky')) return { description: 'Açık', Icon: isDayTime ? 'fas fa-sun' : 'fas fa-moon' };
            if (code.startsWith('fair')) return { description: 'Az Bulutlu', Icon: isDayTime ? 'fas fa-cloud-sun' : 'fas fa-cloud-moon' };
            if (code.startsWith('partlycloudy')) return { description: 'Parçalı Bulutlu', Icon: 'fas fa-cloud' };
            if (code.startsWith('cloudy')) return { description: 'Bulutlu', Icon: 'fas fa-cloud' };
            if (code.includes('rainshowers')) return { description: 'Sağanak Yağışlı', Icon: 'fas fa-cloud-showers-heavy' };
            if (code.includes('rain')) return { description: 'Yağmurlu', Icon: 'fas fa-cloud-rain' };
            if (code.includes('sleet')) return { description: 'Sulu Kar', Icon: 'fas fa-cloud-meatball' };
            if (code.includes('snowshowers')) return { description: 'Kar Sağanağı', Icon: 'fas fa-snowflake' };
            if (code.includes('snow')) return { description: 'Karlı', Icon: 'fas fa-snowflake' };
            if (code.startsWith('fog')) return { description: 'Sisli', Icon: 'fas fa-smog' };
            if (code.includes('thunder')) return { description: 'Gök Gürültülü Fırtına', Icon: 'fas fa-bolt' };
            return { description: 'Bilinmiyor', Icon: 'fas fa-question-circle' };
        }

        function showLoading(message, autoHideDelay = 0) {
            loadingMessageEl.textContent = message;
            loadingContainer.style.display = 'flex';
            if (autoHideDelay > 0) {
                setTimeout(() => { if (loadingMessageEl.textContent === message) hideLoading(); }, autoHideDelay);
            }
        }

        function hideLoading() {
            loadingContainer.style.display = 'none';
        }

        function updateLoadingMessage(message) {
            if (loadingContainer.style.display !== 'none') {
                loadingMessageEl.textContent = message;
            }
        }
        
        function showError(message) {
            alert(message);
            console.error(message);
        }
        
        function formatTimeDifference(ms) {
            if (ms < 0) ms = 0;
            let seconds = Math.floor(ms / 1000);
            let minutes = Math.floor(seconds / 60);
            let hours = Math.floor(minutes / 60);
            seconds %= 60; minutes %= 60;
            if (hours > 0) return `${hours} sa ${minutes} dk`;
            if (minutes > 0) return `${minutes} dk ${seconds} sn`;
            return `${seconds} sn`;
        }
        
        function updateLastBulkUpdateTimeDisplay() {
            const lastTime = localStorage.getItem('lastBulkUpdateTime_v3');
            if (lastTime) lastBulkUpdateTimeDisplay.textContent = new Date(parseInt(lastTime)).toLocaleString('tr-TR');
            else lastBulkUpdateTimeDisplay.textContent = "Henüz Yok";
        }

        function updateNextBulkUpdateDisplay(lastUpdateTimeMs) {
            if (lastUpdateTimeMs) {
                const nextUpdateTs = lastUpdateTimeMs + SIX_HOURS_MS;
                const remainingMs = nextUpdateTs - Date.now();
                if (remainingMs > 0) nextBulkUpdateTimeDisplay.textContent = `${formatTimeDifference(remainingMs)} sonra`;
                else nextBulkUpdateTimeDisplay.textContent = "Şimdi veya Yakında";
            } else {
                nextBulkUpdateTimeDisplay.textContent = "Belirsiz";
            }
        }
    </script>
</body>
</html>
