
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HavaDurumuX - İnternetsiz Sürüm (Konsept)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff; /* AliceBlue */
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
        }
        h1, h2, h3 {
            color: #005a8d; /* Darker blue */
            margin-top: 0;
        }
        h1 { text-align: center; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #87ceeb; padding-bottom: 5px; margin-top: 25px; }

        .controls, .status-panel, .current-weather, .forecast-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        label {
            font-weight: bold;
            margin-right: 10px;
            color: #555;
        }
        select, button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        select {
            min-width: 200px;
        }
        button {
            background-color: #87ceeb; /* SkyBlue */
            color: white;
            border: none;
        }
        button:hover {
            background-color: #5f9ea0; /* CadetBlue */
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status-panel {
            font-size: 0.9em;
            color: #555;
        }
        .status-panel .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            height: 20px;
            margin-top: 5px;
        }
        .status-panel .progress-bar-fill {
            height: 100%;
            width: 0%;
            background-color: #4caf50;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8em;
            transition: width 0.3s ease;
        }

        .current-weather .temp {
            font-size: 3em;
            font-weight: bold;
            color: #005a8d;
            text-align: center;
        }
        .current-weather .description {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        .current-weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }
        .current-weather-details div {
            padding: 8px;
            background-color: #eef;
            border-radius: 4px;
        }

        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .forecast-table th, .forecast-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .forecast-table th {
            background-color: #e0f2f7;
            color: #005a8d;
        }
        .forecast-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .forecast-table .weather-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
        }

        .daily-forecast-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .daily-forecast-item:last-child {
            border-bottom: none;
        }
        .daily-forecast-item .date {
            font-weight: bold;
        }

        .chart-container {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            background-color: #fff;
        }
        .chart-title {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }
        .bar-chart {
            display: flex;
            align-items: flex-end;
            height: 150px; /* Adjusted height */
            border-left: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            padding: 5px 0 0 5px;
            overflow-x: auto; /* Make chart scrollable if too wide */
            overflow-y: hidden;
        }
        .bar-chart .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 2px; /* Reduced margin */
            min-width: 25px; /* Min width for bars */
        }
        .bar-chart .bar {
            background-color: #87ceeb;
            width: 20px; /* Reduced width */
            transition: height 0.3s ease;
            position: relative;
        }
         .bar-chart .bar.precipitation {
            background-color: #5f9ea0; /* CadetBlue */
        }
        .bar-chart .bar-value {
            font-size: 0.6em; /* Smaller font */
            text-align: center;
            position: absolute;
            bottom: -15px;
            width: 100%;
            color: #555;
        }
        .bar-chart .bar-time {
            font-size: 0.6em; /* Smaller font */
            margin-top: 2px;
            white-space: nowrap;
            transform: rotate(-45deg); /* Rotate for better fit */
            transform-origin: top right;
            position: relative;
            right: 5px; /* Adjust position after rotation */
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none; /* Initially hidden */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HavaDurumuX - İnternetsiz (Konsept)</h1>
        <p style="text-align: center; font-size: 0.9em; color: #777; margin-bottom: 20px;">
            Bu sürüm, internet bağlantınız olmadığında temel hava durumu bilgilerini sunmayı amaçlar.
            Veriler periyodik olarak (internet varken) güncellenir ve tarayıcınızda saklanır.
            <br><strong>Not:</strong> Bu, tüm özellikleri barındıran bir prototiptir ve gerçek API kullanım limitlerine tabidir.
            `turkey_locations.json` dosyasındaki koordinatların doğruluğu önemlidir.
        </p>

        <div class="controls">
            <label for="province-select">İl Seçin:</label>
            <select id="province-select"></select>
            <button id="refresh-all-button">Tüm İller İçin Verileri Yenile (6+ Saat Geçtiyse)</button>
            <div id="loader" class="loader"></div>
        </div>

        <div class="status-panel">
            <strong>Durum:</strong> <span id="status-message">Hazır.</span><br>
            <strong>Son Toplu Güncelleme:</strong> <span id="last-bulk-update-time">Bilinmiyor</span>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="bulk-update-progress">0%</div>
            </div>
        </div>

        <div id="weather-content" style="display: none;">
            <h2 id="selected-province-name"></h2>
            
            <div class="current-weather">
                <h3>Şu Anki Hava Durumu (Tahmini)</h3>
                <div id="current-temp" class="temp">--°C</div>
                <div id="current-condition" class="description">--</div>
                <div class="current-weather-details">
                    <div id="current-feels-like">Hissedilen: --°C</div>
                    <div id="current-humidity">Nem: --%</div>
                    <div id="current-pressure">Basınç: -- hPa</div>
                    <div id="current-wind">Rüzgar: -- km/s (--)</div>
                    <div id="current-gusts">Hamle: -- km/s</div>
                    <div id="current-precipitation">Yağış (1s): -- mm</div>
                    <div id="current-uv">UV İndeksi: --</div>
                    <div id="current-visibility">Görüş: -- km</div>
                </div>
                <small id="current-time-info" style="display: block; text-align: center; margin-top: 10px;"></small>
            </div>

            <div class="forecast-section">
                <h3>Saatlik Tahminler (Gelecek 24 Saat)</h3>
                <div class="chart-container">
                    <div class="chart-title">Saatlik Sıcaklık Değişimi (°C)</div>
                    <div class="bar-chart" id="temp-chart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Saatlik Yağış Olasılığı (%)</div>
                    <div class="bar-chart" id="precip-prob-chart"></div>
                </div>
                <table class="forecast-table" id="hourly-forecast-table">
                    <thead>
                        <tr>
                            <th>Saat</th>
                            <th>Sıcaklık</th>
                            <th>Hava Durumu</th>
                            <th>Yağış İht.</th>
                            <th>Yağış (mm)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="forecast-section">
                <h3>Günlük Tahminler (Gelecek 7 Gün)</h3>
                <div id="daily-forecast-list"></div>
            </div>
        </div>
    </div>

    <script>
        const turkeyLocations = { /* JSON içeriği buraya gelecek */ };
        const MET_API_BASE_URL = 'https://api.met.no/weatherapi/locationforecast/2.0/compact';
        const MET_USER_AGENT = 'havadurumuxsite-offline/1.0 havadurumuxsite@gmail.com'; // Farklı User-Agent
        const BULK_UPDATE_INTERVAL_HOURS = 6;
        const DATA_STALE_HOURS = 6; // Verinin ne kadar süre sonra eski kabul edileceği
        const HOURS_TO_FETCH = 66; // MET.no'dan çekilecek saatlik tahmin sayısı

        const provinceSelect = document.getElementById('province-select');
        const refreshAllButton = document.getElementById('refresh-all-button');
        const statusMessageEl = document.getElementById('status-message');
        const lastBulkUpdateTimeEl = document.getElementById('last-bulk-update-time');
        const bulkUpdateProgressEl = document.getElementById('bulk-update-progress');
        const loaderEl = document.getElementById('loader');

        const weatherContentEl = document.getElementById('weather-content');
        const selectedProvinceNameEl = document.getElementById('selected-province-name');
        const currentTempEl = document.getElementById('current-temp');
        const currentConditionEl = document.getElementById('current-condition');
        const currentFeelsLikeEl = document.getElementById('current-feels-like');
        const currentHumidityEl = document.getElementById('current-humidity');
        const currentPressureEl = document.getElementById('current-pressure');
        const currentWindEl = document.getElementById('current-wind');
        const currentGustsEl = document.getElementById('current-gusts');
        const currentPrecipitationEl = document.getElementById('current-precipitation');
        const currentUvEl = document.getElementById('current-uv');
        const currentVisibilityEl = document.getElementById('current-visibility');
        const currentTimeInfoEl = document.getElementById('current-time-info');
        
        const tempChartEl = document.getElementById('temp-chart');
        const precipProbChartEl = document.getElementById('precip-prob-chart');
        const hourlyForecastTableBodyEl = document.getElementById('hourly-forecast-table').getElementsByTagName('tbody')[0];
        const dailyForecastListEl = document.getElementById('daily-forecast-list');

        let currentProvinceData = null;
        let tempAnimationInterval = null;

        // --- İl Verileri (turkey_locations.json'dan alınacak) ---
        // Bu kısım çok uzun olacağı için sadece yapısını gösteriyorum.
        // Gerçek uygulamada bu JSON'dan dinamik olarak yüklenmeli veya buraya gömülmeli.
        const allProvincesData = {
            "Adana": [{"name":"Seyhan","lat":37.00,"lon":35.32},{"name":"Yüreğir","lat":36.98,"lon":35.35} /* ...diğer ilçeler */],
            "Ankara": [{"name":"Çankaya","lat":39.92,"lon":32.85},{"name":"Keçiören","lat":39.98,"lon":32.87} /* ... */],
            "İstanbul": [{"name":"Kadıköy","lat":40.99,"lon":29.02},{"name":"Beşiktaş","lat":41.04,"lon":29.00} /* ... */],
            "İzmir": [{"name":"Konak","lat":38.42,"lon":27.14},{"name":"Bornova","lat":38.46,"lon":27.22} /* ... */],
            "Kütahya": [ // Örnek olarak Kütahya'yı detaylı verelim
                { "name": "Merkez", "lat": 39.4203, "lon": 29.9833 },
                { "name": "Tavşanlı", "lat": 39.5708, "lon": 29.4903 },
                { "name": "Simav", "lat": 39.0903, "lon": 28.9706 },
                { "name": "Domaniç", "lat": 39.8119, "lon": 29.6078 }
                // Diğer Kütahya ilçeleri...
            ]
            // ... Diğer 76 il ve ilçeleri
        };
        // NOT: turkey_locations.json dosyanızdaki tüm illeri ve ilçeleri buraya eklemeniz gerekecek.
        // Özellikle 0,0 olan koordinatların güncellenmesi kritik.
        // Bu örnekte sadece birkaç il ve Kütahya'nın bazı ilçeleri var.

        // Weather Icon Mapping (Basit)
        const weatherIcons = {
            0: '☀️', 1: '🌤️', 2: '🌥️', 3: '☁️', 45: '🌫️', 48: '🌫️',
            51: '💧', 53: '💧', 55: '💧', 61: '🌧️', 63: '🌧️', 65: '🌧️',
            71: '❄️', 73: '❄️', 75: '❄️', 80: '🌦️', 81: '🌦️', 82: '⛈️',
            85: '🌨️', 86: '🌨️', 95: '🌩️', 96: '🌩️', 99: '🌩️'
        };
        const weatherDescriptions = {
            0: 'Açık', 1: 'Parçalı Bulutlu', 2: 'Bulutlu', 3: 'Çok Bulutlu', 45: 'Sisli', 48: 'Kırağı Sisi',
            51: 'Hafif Çisenti', 53: 'Orta Çisenti', 55: 'Yoğun Çisenti',
            61: 'Hafif Yağmurlu', 63: 'Orta Yağmurlu', 65: 'Şiddetli Yağmurlu',
            71: 'Hafif Kar', 73: 'Orta Kar', 75: 'Yoğun Kar',
            80: 'Hafif Sağanak', 81: 'Orta Sağanak', 82: 'Şiddetli Sağanak',
            85: 'Hafif Kar Sağanağı', 86: 'Yoğun Kar Sağanağı',
            95: 'Gök Gürültülü Fırtına', 96: 'Dolu ile Fırtına', 99: 'Şiddetli Dolu ile Fırtına'
        };


        function getWindDirectionSymbol(degrees) {
            if (degrees === null || typeof degrees === 'undefined') return 'N/A';
            const directions = ['K', 'KKD', 'KD', 'DKD', 'D', 'DGD', 'GD', 'GGD', 'G', 'GGB', 'GB', 'BGB', 'B', 'BKB', 'KB', 'KKB'];
            return directions[Math.round(degrees / 22.5) % 16];
        }

        async function fetchWeatherData(lat, lon) {
            const url = `${MET_API_BASE_URL}?lat=${lat}&lon=${lon}`;
            try {
                const response = await fetch(url, { headers: { 'User-Agent': MET_USER_AGENT } });
                if (!response.ok) {
                    console.error(`API isteği başarısız oldu: ${response.status} - ${lat},${lon}`);
                    return null;
                }
                const data = await response.json();
                // Sadece ilk HOURS_TO_FETCH saatlik veriyi alalım
                if (data.properties && data.properties.timeseries) {
                    data.properties.timeseries = data.properties.timeseries.slice(0, HOURS_TO_FETCH);
                }
                return data;
            } catch (error) {
                console.error(`API isteği sırasında hata: ${error} - ${lat},${lon}`);
                return null;
            }
        }

        function storeWeatherData(provinceKey, districtName, data) {
            try {
                localStorage.setItem(`offline_weather_${provinceKey}_${districtName}`, JSON.stringify(data));
                localStorage.setItem(`offline_weather_timestamp_${provinceKey}_${districtName}`, new Date().toISOString());
            } catch (e) {
                console.error("localStorage'a kaydetme hatası (muhtemelen dolu):", e);
                statusMessageEl.textContent = "Hata: Tarayıcı depolama alanı dolu olabilir.";
            }
        }

        function getStoredWeatherData(provinceKey, districtName) {
            const dataStr = localStorage.getItem(`offline_weather_${provinceKey}_${districtName}`);
            const timestampStr = localStorage.getItem(`offline_weather_timestamp_${provinceKey}_${districtName}`);
            if (dataStr && timestampStr) {
                const dataTimestamp = new Date(timestampStr);
                const now = new Date();
                if ((now - dataTimestamp) / (1000 * 60 * 60) < DATA_STALE_HOURS) {
                    return JSON.parse(dataStr);
                }
            }
            return null;
        }
        
        function processMetData(metData, districtName) {
            if (!metData || !metData.properties || !metData.properties.timeseries) {
                return { current: null, hourly: [], daily: [] };
            }
        
            const timeseries = metData.properties.timeseries;
            let currentData = null;
            const now = new Date();
        
            // En yakın geçmiş veya şu anki saat dilimini bul
            let closestTimeEntry = timeseries[0];
            let minDiff = Math.abs(now - new Date(timeseries[0].time));

            for (let i = 0; i < timeseries.length; i++) {
                const entryTime = new Date(timeseries[i].time);
                const diff = Math.abs(now - entryTime);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestTimeEntry = timeseries[i];
                }
                if (entryTime > now && i > 0) { // Şu andan sonraki ilk girişi de kontrol et
                    if (Math.abs(now - new Date(timeseries[i-1].time)) <= Math.abs(now - entryTime)) {
                        closestTimeEntry = timeseries[i-1];
                    } else {
                        closestTimeEntry = timeseries[i];
                    }
                    break;
                }
            }
            if(closestTimeEntry){
                const details = closestTimeEntry.data.instant.details;
                const next1Hour = closestTimeEntry.data.next_1_hours || closestTimeEntry.data.next_6_hours || closestTimeEntry.data.next_12_hours;
                currentData = {
                    time: closestTimeEntry.time,
                    temperature: details.air_temperature,
                    feels_like: details.air_temperature, // MET.no doğrudan vermez, aynı kabul edelim
                    humidity: details.relative_humidity,
                    pressure: details.air_pressure_at_sea_level,
                    wind_speed: details.wind_speed * 3.6, // m/s to km/h
                    wind_direction: details.wind_from_direction,
                    wind_gusts: (details.wind_speed_of_gust || details.wind_speed) * 3.6, // m/s to km/h
                    precipitation_1h: next1Hour ? next1Hour.details.precipitation_amount : 0,
                    weather_code: next1Hour ? metSymbolToWMOCode(next1Hour.summary.symbol_code) : 0,
                    description: next1Hour ? weatherDescriptions[metSymbolToWMOCode(next1Hour.summary.symbol_code)] || 'Bilinmiyor' : 'Bilinmiyor',
                    icon: next1Hour ? weatherIcons[metSymbolToWMOCode(next1Hour.summary.symbol_code)] || '❓' : '❓',
                    uv_index: null, // MET.no sağlamaz, OpenMeteo'dan alınabilir
                    visibility: null, // MET.no sağlamaz
                    districtName: districtName
                };
            }


            const hourlyData = timeseries.map(entry => {
                const details = entry.data.instant.details;
                const next1Hour = entry.data.next_1_hours || entry.data.next_6_hours || entry.data.next_12_hours;
                const weatherCode = next1Hour ? metSymbolToWMOCode(next1Hour.summary.symbol_code) : 0;
                return {
                    time: new Date(entry.time).getHours() + ':00',
                    fullTime: entry.time,
                    temperature: details.air_temperature,
                    description: next1Hour ? weatherDescriptions[weatherCode] || 'Bilinmiyor' : 'Bilinmiyor',
                    icon: next1Hour ? weatherIcons[weatherCode] || '❓' : '❓',
                    precipitation_probability: next1Hour ? (next1Hour.details.probability_of_precipitation || 0) : 0, // MET.no'da yok, 0 varsayalım
                    precipitation_mm: next1Hour ? next1Hour.details.precipitation_amount : 0
                };
            }).slice(0, 24); // İlk 24 saati gösterelim

            // Günlük verileri saatlikten türetelim (basitleştirilmiş)
            const dailyAggregated = {};
            timeseries.forEach(entry => {
                const dateKey = entry.time.split('T')[0];
                if (!dailyAggregated[dateKey]) {
                    dailyAggregated[dateKey] = {
                        temps: [],
                        precipitations: [],
                        codes: [],
                        precip_probs: []
                    };
                }
                dailyAggregated[dateKey].temps.push(entry.data.instant.details.air_temperature);
                const next1Hour = entry.data.next_1_hours || entry.data.next_6_hours || entry.data.next_12_hours;
                if (next1Hour) {
                    dailyAggregated[dateKey].precipitations.push(next1Hour.details.precipitation_amount || 0);
                    dailyAggregated[dateKey].codes.push(metSymbolToWMOCode(next1Hour.summary.symbol_code));
                    dailyAggregated[dateKey].precip_probs.push(next1Hour.details.probability_of_precipitation || 0);
                }
            });

            const dailyData = Object.keys(dailyAggregated).map(dateKey => {
                const day = dailyAggregated[dateKey];
                const temp_max = Math.max(...day.temps);
                const temp_min = Math.min(...day.temps);
                const precip_sum = day.precipitations.reduce((a, b) => a + b, 0);
                const dominant_code = day.codes.length ? day.codes.sort((a,b) => day.codes.filter(v => v===a).length - day.codes.filter(v => v===b).length).pop() : 0;
                const precip_prob_max = day.precip_probs.length ? Math.max(...day.precip_probs) : 0;

                return {
                    date: new Date(dateKey).toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'short' }),
                    temp_max: temp_max.toFixed(1),
                    temp_min: temp_min.toFixed(1),
                    description: weatherDescriptions[dominant_code] || 'Bilinmiyor',
                    icon: weatherIcons[dominant_code] || '❓',
                    precipitation_sum: precip_sum.toFixed(1),
                    precipitation_probability_max: precip_prob_max
                };
            }).slice(0, 7); // İlk 7 günü gösterelim

            return { current: currentData, hourly: hourlyData, daily: dailyData };
        }
        
        // MET.no sembol kodlarını WMO kodlarına çevirme (basitleştirilmiş)
        function metSymbolToWMOCode(symbolCode) {
            if (!symbolCode) return 0;
            const s = symbolCode.toLowerCase();
            if (s.startsWith('clearsky')) return 0;
            if (s.startsWith('fair')) return 1;
            if (s.startsWith('partlycloudy')) return 2;
            if (s.startsWith('cloudy')) return 3;
            if (s.startsWith('lightrainshowers') || s.startsWith('lightrain')) return 61; // Hafif Yağmur/Sağanak
            if (s.startsWith('rainshowers') || s.startsWith('rain')) return 63; // Orta Yağmur/Sağanak
            if (s.startsWith('heavyrainshowers') || s.startsWith('heavyrain')) return 65; // Şiddetli Yağmur/Sağanak
            if (s.includes('thunder')) return 95; // Gök Gürültülü (basit)
            if (s.startsWith('lightsnowshowers') || s.startsWith('lightsnow')) return 71;
            if (s.startsWith('snowshowers') || s.startsWith('snow')) return 73;
            if (s.startsWith('heavysnowshowers') || s.startsWith('heavysnow')) return 75;
            if (s.startsWith('fog')) return 45;
            // Diğer kodlar eklenebilir...
            return 0; // Bilinmiyor
        }


        function displayWeatherData(provinceName, districtName, weatherData) {
            weatherContentEl.style.display = 'block';
            selectedProvinceNameEl.textContent = `${provinceName} - ${districtName}`;

            const { current, hourly, daily } = weatherData;

            if (current) {
                stopTemperatureAnimation();
                currentTempEl.textContent = `${current.temperature?.toFixed(1) || '--'}°C`;
                animateTemperature(current.temperature, getNextHourTemperature(hourly, current.time));

                currentConditionEl.innerHTML = `${current.icon} ${current.description}`;
                currentFeelsLikeEl.textContent = `Hissedilen: ${current.feels_like?.toFixed(1) || '--'}°C`;
                currentHumidityEl.textContent = `Nem: ${current.humidity?.toFixed(0) || '--'}%`;
                currentPressureEl.textContent = `Basınç: ${current.pressure?.toFixed(0) || '--'} hPa`;
                currentWindEl.textContent = `Rüzgar: ${current.wind_speed?.toFixed(1) || '--'} km/s (${getWindDirectionSymbol(current.wind_direction)})`;
                currentGustsEl.textContent = `Hamle: ${current.wind_gusts?.toFixed(1) || '--'} km/s`;
                currentPrecipitationEl.textContent = `Yağış (1s): ${current.precipitation_1h?.toFixed(1) || '0'} mm`;
                currentUvEl.textContent = `UV İndeksi: ${current.uv_index || '--'}`;
                currentVisibilityEl.textContent = `Görüş: ${current.visibility ? (current.visibility / 1000).toFixed(1) : '--'} km`;
                currentTimeInfoEl.textContent = `Son Veri: ${new Date(current.time).toLocaleString('tr-TR')}`;
            } else {
                currentTempEl.textContent = '--°C';
                currentConditionEl.textContent = 'Veri yok';
                // Diğer anlık alanları temizle
            }

            // Saatlik Tahminler Tablosu ve Grafikleri
            hourlyForecastTableBodyEl.innerHTML = '';
            tempChartEl.innerHTML = '';
            precipProbChartEl.innerHTML = '';

            const hourlyForChart = hourly.slice(0, 24); // Grafik için ilk 24 saat

            if (hourlyForChart.length > 0) {
                // Sıcaklık Grafiği
                const maxTemp = Math.max(...hourlyForChart.map(h => h.temperature).filter(t => t !== null));
                const minTemp = Math.min(...hourlyForChart.map(h => h.temperature).filter(t => t !== null));
                hourlyForChart.forEach(hour => {
                    const barWrapper = document.createElement('div');
                    barWrapper.className = 'bar-wrapper';
                    
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    const temp = hour.temperature;
                    const barHeight = temp !== null ? ((temp - minTemp) / (maxTemp - minTemp + 0.1) * 100) : 0; // +0.1 to avoid division by zero
                    bar.style.height = `${Math.max(5, barHeight)}%`; // Min height 5%
                    bar.title = `${hour.time}: ${temp}°C`;

                    const barValue = document.createElement('div');
                    barValue.className = 'bar-value';
                    barValue.textContent = `${temp?.toFixed(0) || ''}`;
                    
                    const barTime = document.createElement('div');
                    barTime.className = 'bar-time';
                    barTime.textContent = hour.time.split(':')[0];

                    bar.appendChild(barValue);
                    barWrapper.appendChild(bar);
                    barWrapper.appendChild(barTime);
                    tempChartEl.appendChild(barWrapper);

                    // Tablo Satırı
                    const row = hourlyForecastTableBodyEl.insertRow();
                    row.insertCell().textContent = hour.time;
                    row.insertCell().textContent = `${hour.temperature?.toFixed(1) || '--'}°C`;
                    row.insertCell().innerHTML = `${hour.icon} ${hour.description}`;
                    row.insertCell().textContent = `${hour.precipitation_probability?.toFixed(0) || '0'}%`;
                    row.insertCell().textContent = `${hour.precipitation_mm?.toFixed(1) || '0'} mm`;
                });

                // Yağış Olasılığı Grafiği
                hourlyForChart.forEach(hour => {
                    const barWrapper = document.createElement('div');
                    barWrapper.className = 'bar-wrapper';

                    const bar = document.createElement('div');
                    bar.className = 'bar precipitation';
                    const prob = hour.precipitation_probability || 0;
                    bar.style.height = `${Math.max(5, prob)}%`;
                    bar.title = `${hour.time}: %${prob}`;
                    
                    const barValue = document.createElement('div');
                    barValue.className = 'bar-value';
                    barValue.textContent = `${prob.toFixed(0)}`;

                    const barTime = document.createElement('div');
                    barTime.className = 'bar-time';
                    barTime.textContent = hour.time.split(':')[0];
                    
                    bar.appendChild(barValue);
                    barWrapper.appendChild(bar);
                    barWrapper.appendChild(barTime);
                    precipProbChartEl.appendChild(barWrapper);
                });

            } else {
                hourlyForecastTableBodyEl.innerHTML = '<tr><td colspan="5">Saatlik veri bulunamadı.</td></tr>';
            }


            // Günlük Tahminler
            dailyForecastListEl.innerHTML = '';
            if (daily.length > 0) {
                daily.forEach(day => {
                    const item = document.createElement('div');
                    item.className = 'daily-forecast-item';
                    item.innerHTML = `
                        <div class="date">${day.date}</div>
                        <div>${day.icon} ${day.description}</div>
                        <div>Sıcaklık: ${day.temp_max}°C / ${day.temp_min}°C</div>
                        <div>Yağış: ${day.precipitation_sum} mm (İht: %${day.precipitation_probability_max})</div>
                    `;
                    dailyForecastListEl.appendChild(item);
                });
            } else {
                dailyForecastListEl.innerHTML = '<p>Günlük veri bulunamadı.</p>';
            }
        }

        function getNextHourTemperature(hourlyForecast, currentTimeISO) {
            if (!hourlyForecast || hourlyForecast.length === 0 || !currentTimeISO) return null;
            const currentTime = new Date(currentTimeISO);
            const currentHour = currentTime.getHours();

            for (let i = 0; i < hourlyForecast.length; i++) {
                const forecastTime = new Date(hourlyForecast[i].fullTime);
                if (forecastTime > currentTime && forecastTime.getHours() === (currentHour + 1) % 24) {
                    return hourlyForecast[i].temperature;
                }
            }
            // If next hour not found in immediate list, try to find the next available hour
            for (let i = 0; i < hourlyForecast.length; i++) {
                const forecastTime = new Date(hourlyForecast[i].fullTime);
                 if (forecastTime > currentTime) {
                    return hourlyForecast[i].temperature;
                }
            }
            return null; // Sonraki saat için veri yok
        }
        
        function animateTemperature(startTemp, endTemp) {
            if (tempAnimationInterval) clearInterval(tempAnimationInterval);
            if (startTemp === null || endTemp === null || typeof startTemp === 'undefined' || typeof endTemp === 'undefined' || startTemp === endTemp) {
                currentTempEl.textContent = `${(startTemp || endTemp || '--').toFixed(1)}°C`;
                return;
            }

            let currentAnimatedTemp = startTemp;
            const diff = endTemp - startTemp;
            const steps = Math.abs(diff) * 10; // 0.1C'lik adımlar için
            const intervalTime = (60 * 60 * 1000) / steps; // 1 saat / adım sayısı
            const stepAmount = diff / steps;

            tempAnimationInterval = setInterval(() => {
                currentAnimatedTemp += stepAmount;
                currentTempEl.textContent = `${currentAnimatedTemp.toFixed(1)}°C`;
                if ((stepAmount > 0 && currentAnimatedTemp >= endTemp) || (stepAmount < 0 && currentAnimatedTemp <= endTemp)) {
                    currentTempEl.textContent = `${endTemp.toFixed(1)}°C`;
                    clearInterval(tempAnimationInterval);
                }
            }, Math.max(100, intervalTime)); // Minimum 100ms aralık
        }

        function stopTemperatureAnimation() {
            if (tempAnimationInterval) {
                clearInterval(tempAnimationInterval);
                tempAnimationInterval = null;
            }
        }

        async function loadSelectedProvinceData() {
            const selectedValue = provinceSelect.value;
            if (!selectedValue) return;

            const [provinceKey, districtName] = selectedValue.split('___');
            statusMessageEl.textContent = `${provinceKey} - ${districtName} için veriler yükleniyor...`;
            loaderEl.style.display = 'block';

            let weatherData = getStoredWeatherData(provinceKey, districtName);
            let fetchedFresh = false;

            if (!weatherData) {
                const provinceInfo = allProvincesData[provinceKey];
                const districtInfo = provinceInfo ? provinceInfo.find(d => d.name === districtName) : null;
                
                if (districtInfo && districtInfo.lat !== 0 && districtInfo.lon !== 0) {
                    statusMessageEl.textContent = `${provinceKey} - ${districtName} için API'den veri çekiliyor...`;
                    const metData = await fetchWeatherData(districtInfo.lat, districtInfo.lon);
                    if (metData) {
                        currentProvinceData = processMetData(metData, districtName);
                        storeWeatherData(provinceKey, districtName, currentProvinceData);
                        fetchedFresh = true;
                    } else {
                        currentProvinceData = { current: null, hourly: [], daily: [] }; // API hatası
                        statusMessageEl.textContent = `${provinceKey} - ${districtName} için API'den veri alınamadı.`;
                    }
                } else {
                    currentProvinceData = { current: null, hourly: [], daily: [] }; // Koordinat yok
                    statusMessageEl.textContent = `${provinceKey} - ${districtName} için koordinat bulunamadı.`;
                }
            } else {
                 currentProvinceData = weatherData; // localStorage'dan geldi
            }
            
            displayWeatherData(provinceKey, districtName, currentProvinceData);
            statusMessageEl.textContent = `${provinceKey} - ${districtName} için veriler ${fetchedFresh ? 'güncel olarak API\'den' : 'yerel depodan'} yüklendi.`;
            loaderEl.style.display = 'none';
        }

        function populateProvinces() {
            const provinces = Object.keys(allProvincesData);
            provinces.sort((a, b) => a.localeCompare(b, 'tr'));

            provinces.forEach(province => {
                const districts = allProvincesData[province];
                if (districts && districts.length > 0) {
                    districts.sort((a,b) => a.name.localeCompare(b.name, 'tr'));
                    districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = `${province}___${district.name}`; // Ayırıcı ile
                        option.textContent = `${province} / ${district.name}`;
                        provinceSelect.appendChild(option);
                    });
                } else { // Sadece il merkezi varsa (veya ilçe listesi boşsa)
                     const option = document.createElement('option');
                     option.value = `${province}___${province}`; // İl adını ilçe gibi kullan
                     option.textContent = province;
                     provinceSelect.appendChild(option);
                }
            });
             // Kütahya Merkez'i varsayılan yapalım
            const defaultKutahya = `Kütahya___Merkez`;
            if (Array.from(provinceSelect.options).some(opt => opt.value === defaultKutahya)) {
                 provinceSelect.value = defaultKutahya;
            } else if (provinceSelect.options.length > 0) {
                provinceSelect.selectedIndex = 0; // İlk ili seç
            }
        }

        async function bulkUpdateAllProvinces(forceUpdate = false) {
            const lastUpdateStr = localStorage.getItem('lastBulkUpdateTime');
            const now = new Date();
            if (!forceUpdate && lastUpdateStr) {
                const lastUpdateTime = new Date(lastUpdateStr);
                if ((now - lastUpdateTime) / (1000 * 60 * 60) < BULK_UPDATE_INTERVAL_HOURS) {
                    statusMessageEl.textContent = `Son toplu güncelleme ${BULK_UPDATE_INTERVAL_HOURS} saatten yeni. Atlanıyor.`;
                    lastBulkUpdateTimeEl.textContent = lastUpdateTime.toLocaleString('tr-TR');
                    return;
                }
            }

            statusMessageEl.textContent = 'Tüm iller için veri güncelleme başlatılıyor...';
            loaderEl.style.display = 'block';
            refreshAllButton.disabled = true;
            let updatedCount = 0;
            const provinceKeys = Object.keys(allProvincesData);

            for (let i = 0; i < provinceKeys.length; i++) {
                const provinceKey = provinceKeys[i];
                const districts = allProvincesData[provinceKey];
                if (districts && districts.length > 0) {
                    for (const district of districts) {
                        // Sadece geçerli koordinatları olanları çekelim
                        if (district.lat !== 0 && district.lon !== 0) {
                            statusMessageEl.textContent = `[${updatedCount + 1}/${provinceKeys.length * (districts.length || 1)}] ${provinceKey} - ${district.name} çekiliyor...`;
                            const metData = await fetchWeatherData(district.lat, district.lon);
                            if (metData) {
                                const processedData = processMetData(metData, district.name);
                                storeWeatherData(provinceKey, district.name, processedData);
                            }
                            await new Promise(resolve => setTimeout(resolve, 1500)); // API kibarlığı için 1.5 saniye bekle
                        }
                        updatedCount++;
                        const progress = Math.round((updatedCount / (provinceKeys.length * (districts.length || 1))) * 100);
                        bulkUpdateProgressEl.style.width = `${progress}%`;
                        bulkUpdateProgressEl.textContent = `${progress}%`;
                    }
                } else { // Sadece il merkezi durumu (varsa)
                     const district = {name: provinceKey, lat: allProvincesData[provinceKey]?.[0]?.lat || 0, lon: allProvincesData[provinceKey]?.[0]?.lon || 0};
                     if (district.lat !== 0 && district.lon !== 0) {
                        statusMessageEl.textContent = `[${updatedCount + 1}/${provinceKeys.length}] ${provinceKey} çekiliyor...`;
                        const metData = await fetchWeatherData(district.lat, district.lon);
                        if (metData) {
                            const processedData = processMetData(metData, district.name);
                            storeWeatherData(provinceKey, district.name, processedData);
                        }
                        await new Promise(resolve => setTimeout(resolve, 1500));
                     }
                     updatedCount++;
                     const progress = Math.round((updatedCount / provinceKeys.length) * 100);
                     bulkUpdateProgressEl.style.width = `${progress}%`;
                     bulkUpdateProgressEl.textContent = `${progress}%`;
                }
            }
            
            const newUpdateTime = new Date();
            localStorage.setItem('lastBulkUpdateTime', newUpdateTime.toISOString());
            lastBulkUpdateTimeEl.textContent = newUpdateTime.toLocaleString('tr-TR');
            statusMessageEl.textContent = 'Tüm il verileri güncellendi.';
            loaderEl.style.display = 'none';
            refreshAllButton.disabled = false;
            bulkUpdateProgressEl.style.width = `100%`;
            bulkUpdateProgressEl.textContent = `100%`;

            // Seçili olan ilin verisini de tazeleyelim (eğer bir il seçiliyse)
            if (provinceSelect.value) {
                loadSelectedProvinceData();
            }
        }
        
        // Event Listeners
        provinceSelect.addEventListener('change', loadSelectedProvinceData);
        refreshAllButton.addEventListener('click', () => bulkUpdateAllProvinces(true));

        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            // turkey_locations.json içeriğini buraya kopyala
            // Bu satırı JSON dosyanızın gerçek içeriğiyle değiştirin:
            // const externalLocations = { ... }; // JSON'dan yüklenen veri
            // Object.assign(allProvincesData, externalLocations); // Eğer harici bir JSON'dan yüklüyorsanız
            
            populateProvinces();
            const lastUpdateStr = localStorage.getItem('lastBulkUpdateTime');
            if (lastUpdateStr) {
                lastBulkUpdateTimeEl.textContent = new Date(lastUpdateStr).toLocaleString('tr-TR');
            }
            
            // Sayfa yüklendiğinde seçili olan ilin verisini yükle
            if (provinceSelect.value) {
                 loadSelectedProvinceData();
            } else if (provinceSelect.options.length > 0) {
                 provinceSelect.selectedIndex = 0; // İlk ili seç ve yükle
                 loadSelectedProvinceData();
            }


            // Otomatik toplu güncelleme kontrolü (6+ saat geçtiyse)
            bulkUpdateAllProvinces(false); 
        });

    </script>
</body>
</html>
